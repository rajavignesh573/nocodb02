{"version":3,"file":"sdk.js","sources":["../../src/sdk.ts"],"sourcesContent":["import type { Integration } from '@sentry/core';\nimport {\n  applySdkMetadata,\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  spanToJSON,\n} from '@sentry/core';\nimport type { NodeClient, NodeOptions, Span } from '@sentry/node';\nimport { getDefaultIntegrations as getDefaultNodeIntegrations, init as nodeInit } from '@sentry/node';\nimport { nestIntegration } from './integrations/nest';\n\n/**\n * Initializes the NestJS SDK\n */\nexport function init(options: NodeOptions | undefined = {}): NodeClient | undefined {\n  const opts: NodeOptions = {\n    defaultIntegrations: getDefaultIntegrations(options),\n    ...options,\n  };\n\n  applySdkMetadata(opts, 'nestjs');\n\n  const client = nodeInit(opts);\n\n  if (client) {\n    client.on('spanStart', span => {\n      // The NestInstrumentation has no requestHook, so we add NestJS-specific attributes here\n      addNestSpanAttributes(span);\n    });\n  }\n\n  return client;\n}\n\n/** Get the default integrations for the NestJS SDK. */\nexport function getDefaultIntegrations(options: NodeOptions): Integration[] | undefined {\n  return [nestIntegration(), ...getDefaultNodeIntegrations(options)];\n}\n\nfunction addNestSpanAttributes(span: Span): void {\n  const attributes = spanToJSON(span).data;\n\n  // this is one of: app_creation, request_context, handler\n  const type = attributes['nestjs.type'];\n\n  // Only set the NestJS attributes for spans that are created by the NestJS instrumentation and for spans that do not have an op already.\n  if (type && !attributes[SEMANTIC_ATTRIBUTE_SENTRY_OP]) {\n    span.setAttributes({\n      [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.http.otel.nestjs',\n      [SEMANTIC_ATTRIBUTE_SENTRY_OP]: `${type}.nestjs`,\n    });\n  }\n}\n"],"names":["nodeInit","getDefaultNodeIntegrations"],"mappings":";;;;AAWA;AACA;AACA;AACO,SAAS,IAAI,CAAC,OAAO,GAA4B,EAAE,EAA0B;AACpF,EAAE,MAAM,IAAI,GAAgB;AAC5B,IAAI,mBAAmB,EAAE,sBAAsB,CAAC,OAAO,CAAC;AACxD,IAAI,GAAG,OAAO;AACd,GAAG;;AAEH,EAAE,gBAAgB,CAAC,IAAI,EAAE,QAAQ,CAAC;;AAElC,EAAE,MAAM,MAAA,GAASA,MAAQ,CAAC,IAAI,CAAC;;AAE/B,EAAE,IAAI,MAAM,EAAE;AACd,IAAI,MAAM,CAAC,EAAE,CAAC,WAAW,EAAE,QAAQ;AACnC;AACA,MAAM,qBAAqB,CAAC,IAAI,CAAC;AACjC,KAAK,CAAC;AACN;;AAEA,EAAE,OAAO,MAAM;AACf;;AAEA;AACO,SAAS,sBAAsB,CAAC,OAAO,EAA0C;AACxF,EAAE,OAAO,CAAC,eAAe,EAAE,EAAE,GAAGC,wBAA0B,CAAC,OAAO,CAAC,CAAC;AACpE;;AAEA,SAAS,qBAAqB,CAAC,IAAI,EAAc;AACjD,EAAE,MAAM,aAAa,UAAU,CAAC,IAAI,CAAC,CAAC,IAAI;;AAE1C;AACA,EAAE,MAAM,IAAA,GAAO,UAAU,CAAC,aAAa,CAAC;;AAExC;AACA,EAAE,IAAI,IAAA,IAAQ,CAAC,UAAU,CAAC,4BAA4B,CAAC,EAAE;AACzD,IAAI,IAAI,CAAC,aAAa,CAAC;AACvB,MAAM,CAAC,gCAAgC,GAAG,uBAAuB;AACjE,MAAM,CAAC,4BAA4B,GAAG,CAAC,EAAA,IAAA,CAAA,OAAA,CAAA;AACA,KAAA,CAAA;AACA;AACA;;;;"}