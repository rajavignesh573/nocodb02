var de=Object.defineProperty;var ue=(i,t,n)=>t in i?de(i,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):i[t]=n;var v=(i,t,n)=>ue(i,typeof t!="symbol"?t+"":t,n);import{e as me,ak as pe,r as M,aG as he,n as fe,I as ke,o as V,L as k,w as x,c as ge,K as ve,O as xe,a as q,b as w,ar as we,Q as be,ap as Me,N as ye,ag as _e,M as Ce,d as W,fl as Le,lm as G,aY as Se,ln as ze,lo as Ee,lp as Te,lj as J,lq as Be,lr as Ie,ls as Q,lt as Oe,lu as De,lv as Ne,lw as $e,lx as Ae,ly as He,lz as Pe,lA as je,lB as Re,lC as Ke,lD as X,li as Fe,lh as Ve,lf as qe,lE as We,lF as Y,lG as Ge,lH as Ue,h5 as Je,lI as Qe,lJ as Xe,lK as Ye,lL as Ze,lM as et,lN as tt,lO as nt}from"./DRA9KN5F.js";import{B as st}from"./DjPyxH1k.js";const rt={class:"flex items-center gap-x-1"},at={class:"!py-0.5 bg-white rounded-md !z-10 flex-1"},it=me({__name:"LinkOptions",props:{editor:{},isFormField:{type:Boolean},isComment:{type:Boolean}},emits:["blur"],setup(i,{emit:t}){const n=i,s=t,{editor:e,isFormField:a}=pe(n),l=M(),d=M(),c=M(""),b=M(!1),y=M(!1),te=r=>{var f,L,S,z,E,T,B,I,O,D,N,$,A,H,P,j,R,K,F;if(!r.view.editable)return!1;if(y.value)return setTimeout(()=>{y.value=!1},100),!1;const o=((S=(L=(f=r==null?void 0:r.state)==null?void 0:f.selection)==null?void 0:L.$from)==null?void 0:S.nodeBefore)||((T=(E=(z=r==null?void 0:r.state)==null?void 0:z.selection)==null?void 0:E.$from)==null?void 0:T.nodeAfter),m=(I=(B=r==null?void 0:r.state)==null?void 0:B.storedMarks)==null?void 0:I.some(g=>g.type.name==="link"),u=((O=o==null?void 0:o.marks)==null?void 0:O.some(g=>g.type.name==="link"))||m;u&&(d.value=o==null?void 0:o.marks.find(g=>g.type.name==="link"),c.value=(N=(D=d.value)==null?void 0:D.attrs)==null?void 0:N.href),m&&(d.value=(A=($=r==null?void 0:r.state)==null?void 0:$.storedMarks)==null?void 0:A.find(g=>g.type.name==="link"),c.value=(P=(H=d.value)==null?void 0:H.attrs)==null?void 0:P.href);const h=((R=(j=r==null?void 0:r.state)==null?void 0:j.selection)==null?void 0:R.from)!==((F=(K=r==null?void 0:r.state)==null?void 0:K.selection)==null?void 0:F.to),p=u&&!h;return b.value=!!p,p};function ne(r){return/^(?![^:]+:\/\/).*/.test(r)}const se=()=>{var m,u,h;const r=(u=(m=e.value.state)==null?void 0:m.storedMarks)==null?void 0:u.some(p=>p.type.name==="link");let o=c.value;if(Le(c.value)&&c.value.length>0&&!c.value.startsWith("/")&&ne(c.value)&&(o=`https://${c.value}`),r)e.value.view.dispatch(e.value.view.state.tr.removeStoredMark(e.value.schema.marks.link).addStoredMark(e.value.schema.marks.link.create({href:o})));else if(d.value){const p=(h=e.value.state)==null?void 0:h.selection,f=G(p.$anchor,e.value.schema.marks.link);e.value.view.dispatch(e.value.view.state.tr.removeMark(f.from,f.to,e.value.schema.marks.link).addMark(f.from,f.to,e.value.schema.marks.link.create({href:o})))}},re=()=>{var o,m;if((m=(o=e.value.state)==null?void 0:o.storedMarks)==null?void 0:m.some(u=>u.type.name==="link"))e.value.view.dispatch(e.value.view.state.tr.removeStoredMark(e.value.schema.marks.link));else if(d.value){const u=e.value.state.selection,h=G(u.$anchor,e.value.schema.marks.link);e.value.view.dispatch(e.value.view.state.tr.removeMark(h.from,h.to,e.value.schema.marks.link))}y.value=!0},ae=r=>{const o=Se()?r.metaKey:r.ctrlKey;o&&r.key==="z"&&(r.preventDefault(),e.value.commands.undo()),o&&r.shiftKey&&r.key==="z"&&(r.preventDefault(),e.value.commands.redo())},ie=()=>{var r;(r=l.value)==null||r.blur(),e.value.chain().focus().run()},oe=r=>{(r.key==="ArrowDown"||r.key==="Escape")&&e.value.chain().focus().run()};he(b,(r,o)=>{var m,u;if(r&&!o){if(!(!((m=e.value.state.selection.$from.nodeBefore)!=null&&m.textContent)&&!((u=e.value.state.selection.$from.nodeAfter)!=null&&u.textContent)))return;setTimeout(()=>{var p;(p=l.value)==null||p.focus()},100)}});const le=()=>{c.value&&window.open(c.value,"_blank","noopener,noreferrer")},ce=r=>{var o;(o=r==null?void 0:r.popper)!=null&&o.style&&(n.isComment&&(r.popper.style.left="-10%"),r.popper.style.width="95%")},C=fe(()=>a.value?-1:0);return(r,o)=>{const m=we,u=Ce,h=ye,p=Me;return V(),ke(k(st),{editor:k(e),"tippy-options":{duration:100,maxWidth:600,onMount:ce},"should-show":te},{default:x(()=>[k(y)?ve("",!0):(V(),ge("div",{key:0,ref:"wrapperRef",class:"relative bubble-menu nc-text-area-rich-link-options bg-white flex flex-col border-1 border-gray-200 py-1 px-1 rounded-lg w-full","data-testid":"nc-text-area-rich-link-options",onKeydown:xe(ae,["stop"])},[q("div",rt,[q("div",at,[w(m,{ref_key:"inputRef",ref:l,value:k(c),"onUpdate:value":o[0]||(o[0]=f=>be(c)?c.value=f:null),tabindex:k(C),class:"nc-text-area-rich-link-option-input flex-1 !mx-0.5 !px-1.5 !py-0.5 !rounded-md z-10",bordered:!1,placeholder:"Enter a link",onChange:se,onPressEnter:ie,onKeydown:oe,onBlur:o[1]||(o[1]=f=>s("blur"))},null,8,["value","tabindex"])]),w(p,{"overlay-class-name":"nc-text-area-rich-link-options"},{title:x(()=>o[2]||(o[2]=[W(" Open link ")])),default:x(()=>[w(h,{tabindex:k(C),class:_e({"!text-gray-300 cursor-not-allowed":k(c).length===0}),"data-testid":"text-gray-700 nc-text-area-rich-link-options-open-link",size:"small",type:"text",onClick:le},{default:x(()=>[w(u,{icon:"externalLink"})]),_:1},8,["tabindex","class"])]),_:1}),w(p,{"overlay-class-name":"nc-text-area-rich-link-options"},{title:x(()=>o[3]||(o[3]=[W(" Delete link ")])),default:x(()=>[w(h,{tabindex:k(C),class:"!duration-0 !hover:text-red-400 !hover:bg-red-50","data-testid":"nc-text-area-rich-link-options-open-delete",size:"small",type:"text",onClick:re},{default:x(()=>[w(u,{icon:"delete"})]),_:1},8,["tabindex"])]),_:1})])],544))]),_:1},8,["editor","tippy-options","should-show"])}}}),vt=Object.assign(it,{__name:"CellRichTextLinkOptions"}),ot=[ze,Ee,Te,J,Be,Ie,Q,Oe,De,Ne,$e,Ae,He,Pe,je,Re,Ke,X,Fe,Ve,qe,We],lt=i=>{var t,n;return(n=(t=ot.find(s=>s.name===i.name))==null?void 0:t.storage)==null?void 0:n.markdown};function _(i){var s;const t=(s=i.storage)==null?void 0:s.markdown,n=lt(i);return t||n?{...n??{},...t??{}}:null}const U=Y();function Z(i,t){return U.inline.State.prototype.scanDelims.call({src:i,posMax:i.length}),new U.inline.State(i,null,null,[]).scanDelims(t,!0)}function ee(i,t,n,s){let e=i.substring(0,n)+i.substring(n+t.length);return e=e.substring(0,n+s)+t+e.substring(n+s),e}function ct(i,t,n,s){let e=n,a=i;for(;e<s&&!Z(a,e).can_open;)a=ee(a,t,e,1),e++;return{text:a,from:e,to:s}}function dt(i,t,n,s){let e=s,a=i;for(;e>n&&!Z(a,e).can_close;)a=ee(a,t,e,-1),e--;return{text:a,from:n,to:e}}function ut(i,t,n,s){let e={text:i,from:n,to:s};return e=ct(e.text,t,e.from,e.to),e=dt(e.text,t,e.from,e.to),e.to-e.from<t.length+1&&(e.text=e.text.substring(0,e.from)+e.text.substring(e.to+t.length)),e.text}class mt extends Ge{constructor(n,s,e){super(n,s,e??{});v(this,"inTable",!1);v(this,"inlines",[]);v(this,"out","");this.inlines=[]}render(n,s,e){super.render(n,s,e);const a=this.inlines[this.inlines.length-1];if(a!=null&&a.start&&(a!=null&&a.end)){const{delimiter:l,start:d,end:c}=this.normalizeInline(a);this.out=ut(this.out,l,d,c),this.inlines.pop()}}markString(n,s,e,a){const l=this.marks[n.type.name];if(l.expelEnclosingWhitespace)if(s)this.inlines.push({start:this.out.length,delimiter:l.open});else{const d=this.inlines.pop()||{};this.inlines.push({...d,end:this.out.length})}return super.markString(n,s,e,a)}normalizeInline(n){let{start:s}=n;for(;this.out.charAt(s).match(/\s/);)s++;return{...n,start:s}}}class pt{constructor(t){v(this,"editor");this.editor=t}serialize(t){const n=new mt(this.nodes,this.marks,{hardBreakNodeName:J.name});return n.renderContent(t),n.out}get nodes(){return{...Object.fromEntries(Object.keys(this.editor.schema.nodes).map(t=>[t,this.serializeNode(Q)])),...Object.fromEntries(this.editor.extensionManager.extensions.filter(t=>t.type==="node"&&this.serializeNode(t)).map(t=>[t.name,this.serializeNode(t)])??[])}}get marks(){return{...Object.fromEntries(Object.keys(this.editor.schema.marks).map(t=>[t,this.serializeMark(X)])),...Object.fromEntries(this.editor.extensionManager.extensions.filter(t=>t.type==="mark"&&this.serializeMark(t)).map(t=>[t.name,this.serializeMark(t)])??[])}}serializeNode(t){var n,s;return(s=(n=_(t))==null?void 0:n.serialize)==null?void 0:s.bind({editor:this.editor,options:t.options})}serializeMark(t){var s;const n=(s=_(t))==null?void 0:s.serialize;return n?{...n,open:typeof n.open=="function"?n.open.bind({editor:this.editor,options:t.options}):n.open,close:typeof n.close=="function"?n.close.bind({editor:this.editor,options:t.options}):n.close}:null}}class ht{constructor(t,n){v(this,"editor");v(this,"md");this.editor=t,this.md=this.withPatchedRenderer(Y({html:n.html,linkify:n.linkify,breaks:n.breaks})),n.renderImagesAsLinks&&this.md.use(Ue)}parse(t,{inline:n}={}){if(!Je(t))return t;this.editor.extensionManager.extensions.forEach(a=>{var l,d,c;return(c=(d=(l=_(a))==null?void 0:l.parse)==null?void 0:d.setup)==null?void 0:c.call({editor:this.editor,options:a.options},this.md)});const s=this.md.render(t),e=Qe(s);return this.editor.extensionManager.extensions.forEach(a=>{var l,d,c;return(c=(d=(l=_(a))==null?void 0:l.parse)==null?void 0:d.updateDOM)==null?void 0:c.call({editor:this.editor,options:a.options},e)}),this.normalizeDOM(e,{inline:n,content:t}),e.innerHTML}normalizeDOM(t,{inline:n,content:s}){return this.normalizeBlocks(t),t.querySelectorAll("*").forEach(e=>{var a,l;((a=e.nextSibling)==null?void 0:a.nodeType)===Node.TEXT_NODE&&!e.closest("pre")&&(e.nextSibling.textContent=((l=e.nextSibling.textContent)==null?void 0:l.replace(/^\n/,""))??"")}),n&&this.normalizeInline(t,s),t}normalizeBlocks(t){const s=Object.values(this.editor.schema.nodes).filter(e=>e.isBlock).map(e=>{var a;return(a=e.spec.parseDOM)==null?void 0:a.map(l=>l.tag)}).flat().filter(Boolean).join(",");s&&[...t.querySelectorAll(s)].forEach(e=>{var a;(a=e.parentElement)!=null&&a.matches("p")&&Xe(e)})}normalizeInline(t,n){var s,e,a;if((s=t.firstElementChild)!=null&&s.matches("p")){const l=t.firstElementChild,{nextElementSibling:d}=l,c=((e=n.match(/^\s+/))==null?void 0:e[0])??"",b=d?"":((a=n.match(/\s+$/))==null?void 0:a[0])??"";if(n.match(/^\n\n/)){l.innerHTML=`${l.innerHTML}${b}`;return}Ye(l),t.innerHTML=`${c}${t.innerHTML}${b}`}}withPatchedRenderer(t){const n=s=>(...e)=>{const a=s(...e);return a===`
`?a:a[a.length-1]===`
`?a.slice(0,-1):a};return t.renderer.rules.hardbreak=n(t.renderer.rules.hardbreak),t.renderer.rules.softbreak=n(t.renderer.rules.softbreak),t.renderer.rules.fence=n(t.renderer.rules.fence),t.renderer.rules.code_block=n(t.renderer.rules.code_block),t.renderer.renderToken=n(t.renderer.renderToken.bind(t.renderer)),t}}const xt=Ze.create({name:"markdown",priority:50,addOptions(){return{html:!0,tightLists:!0,tightListClass:"tight",bulletListMarker:"-",linkify:!1,breaks:!1,transformPastedText:!1,transformCopiedText:!1,renderImagesAsLinks:!0}},addCommands(){const i=nt.Commands.config.addCommands();return{setContent:(t,n,s)=>e=>i.setContent(e.editor.storage.markdown.parser.parse(t),n,s)(e),insertContentAt:(t,n,s)=>e=>i.insertContentAt(t,e.editor.storage.markdown.parser.parse(n,{inline:!0}),s)(e)}},onBeforeCreate(){this.editor.storage.markdown={options:{...this.options},parser:new ht(this.editor,this.options),serializer:new pt(this.editor),getMarkdown:()=>this.editor.storage.markdown.serializer.serialize(this.editor.state.doc).replace(/<br \/>/g,"<br>"),getHtmlFromMd:i=>i?this.editor.storage.markdown.parser.parse(i):""},this.editor.options.initialContent=this.editor.options.content,this.editor.options.content=this.editor.storage.markdown.parser.parse(this.editor.options.content)},onCreate(){this.editor.options.content=this.editor.options.initialContent,delete this.editor.options.initialContent},addStorage(){return{}},addExtensions(){return[et.configure({tight:this.options.tightLists,tightClass:this.options.tightListClass}),tt.configure({transformPastedText:this.options.transformPastedText,transformCopiedText:this.options.transformCopiedText})]}});export{xt as M,vt as _};
