import{r as j,J as V,as as G,f as N,a7 as T,a8 as W,n as y,L as w,ei as F,le as H,a4 as _,a5 as p,e as I,I as J,o as K,M as q}from"./DRA9KN5F.js";import{u as z}from"./DkDj6Z7Z.js";import{e as h}from"./gAYHr7Gr.js";import{j as Q}from"./BYKJ-MHf.js";const[re,X]=z((o,n)=>{const d=j(!1),{user:R}=V(),{isUIAllowed:f}=G(),{$e:b,$state:m,$api:v}=N(),O=T(),{basesUser:S}=W(O),C=y(()=>o.value.base_id?S.value.get(o.value.base_id)||[]:[]),s=j([]),E=y(()=>s.value.reduce((r,t)=>{if(t.id){let e=w(t.comment);if(t.updated_at!==t.created_at&&t.updated_at){const a=F(t.updated_at).replace(" ","_");e+=` [(edited)](a~~~###~~~Edited_${a}) `}r[t.id]=H.parse(e,{enableMention:!1,users:w(C.value),currentUser:w(R.value)},!0)??""}return r},{})),M=async(r,t=!0)=>{if(!f("commentList")||!n.value&&!r)return;const e=r??h(n.value.row,o.value.columns);if(e)try{t||(d.value=!0);const a=(await v.utils.commentList({row_id:e,fk_model_id:o.value.id})).list||[];s.value=a.map(l=>{const i=C.value.find(c=>c.id===l.created_by),u=l.resolved_by?C.value.find(c=>c.id===l.resolved_by):null;return{...l,created_display_name:(i==null?void 0:i.display_name)??((i==null?void 0:i.email)??"").split("@")[0]??"",resolved_display_name:u?u.display_name??u.email.split("@")[0]:void 0,created_by_meta:i==null?void 0:i.meta,resolved_by_meta:u==null?void 0:u.meta}})}catch(a){_.error(await p(a))}finally{t||(d.value=!1)}},U=async r=>{if(!f("commentDelete"))return;const t=s.value.find(e=>e.id===r);if(t)try{s.value=s.value.filter(e=>e.id!==r),await v.utils.commentDelete(r),Object.assign(n.value,{...n.value,rowMeta:{...n.value.rowMeta,commentCount:(n.value.rowMeta.commentCount??1)-1}})}catch(e){_.error(await p(e)),s.value=[...s.value,t]}},B=async r=>{if(!f("commentResolve"))return;const t=s.value.find(e=>e.id===r);if(t)try{s.value=s.value.map(e=>{var a,l,i,u,c,x,g,k,A,$;return e.id===r?{...e,resolved_by:t.resolved_by||(l=(a=m.user)==null?void 0:a.value)==null?void 0:l.id,resolved_by_email:t.resolved_by||(u=(i=m.user)==null?void 0:i.value)==null?void 0:u.email,resolved_display_name:t.resolved_by?void 0:((x=(c=m.user)==null?void 0:c.value)==null?void 0:x.display_name)??((k=(g=m.user)==null?void 0:g.value)==null?void 0:k.email.split("@")[0]),resolved_by_meta:t.resolved_by||($=(A=m.user)==null?void 0:A.value)==null?void 0:$.meta}:e}),await v.utils.commentResolve(r,{})}catch(e){s.value=s.value.map(a=>a.id===r?t:a),_.error(await p(e))}},D=async r=>{var t;try{if(!n.value||!r){s.value=s.value.filter(a=>{var l;return!((l=a.id)!=null&&l.startsWith("temp-"))});return}const e=h(n.value.row,o.value.columns);if(!e)return;await v.utils.commentRow({fk_model_id:(t=o.value)==null?void 0:t.id,row_id:e,comment:`${r}`.replace(/(<br \/>)+$/g,"")}),Object.assign(n.value,{rowMeta:{...n.value.rowMeta,commentCount:(n.value.rowMeta.commentCount??0)+1}}),await M()}catch(e){s.value=s.value.filter(a=>!(a.id??"").startsWith("temp-")),_.error(await p(e))}b("a:row-expand:comment")},L=async(r,t)=>{const e=s.value.find(a=>a.id===r);if(e)try{s.value=s.value.map(a=>a.id===r?{...a,...t,updated_at:new Date().toISOString()}:a),await v.utils.commentUpdate(r,t)}catch(a){s.value=s.value.map(l=>l.id===r?e:l),_.error(await p(a))}},P=y(()=>h(n.value.row,o.value.columns));return{comments:s,loadComments:M,saveComment:D,updateComment:L,resolveComment:B,deleteComment:U,isCommentsLoading:d,primaryKey:P,parsedHtmlComments:E}});function ne(){const o=X();if(!o)throw new Error("useRowComments is not provided");return o}const Y=(o,n)=>y(()=>Q(o,n)),Z=I({__name:"IconView",props:{item:{}},setup(o){const n=o,d=Y(()=>n.item.title,n.item.mimetype);return(R,f)=>{const b=q;return K(),J(b,{icon:w(d),class:"text-white"},null,8,["icon"])}}}),oe=Object.assign(Z,{__name:"CellAttachmentIconView"});export{oe as _,ne as a,re as u};
