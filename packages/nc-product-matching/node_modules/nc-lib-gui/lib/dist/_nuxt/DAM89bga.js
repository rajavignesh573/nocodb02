import{ba as za,r as V,G as ce,fL as Oa,a8 as xa,V as $a,bX as Ma,f as Ca,as as Da,S as Ea,W as Ha,n as W,bd as Va,bc as Ua,aC as na,aj as j,kv as Pa,l8 as Ra,aG as Qe,a4 as la,a5 as ta,e as Qa,T as ca,bb as Xa,o0 as Ka,ak as Ja,a9 as Ya,gc as Za,b5 as Wa,hX as Ia,al as el,L as a,n$ as al,g as ll,i as tl,$ as sl,ac as nl,c as h,o as u,K as k,ao as pa,I as _,a as T,b as Z,ag as E,w as g,N as ol,M as il,ah as Fa,an as P,f3 as Ta,O as R,d as de,b9 as X,bo as K,t as G,aH as ul,aq as Re,aX as dl,Q as rl,ad as xe,bB as cl,eJ as pl,ap as vl,bD as ml,fV as va,fN as fl,a_ as _l,_ as yl}from"./DRA9KN5F.js";import{_ as bl}from"./C2UaKEE0.js";import{_ as wl}from"./C_VN1MCC.js";import hl from"./xLIsHrMo.js";import{_ as gl}from"./DCm6TF8M.js";import{_ as kl}from"./GU4raMbz.js";import{c as Xe,b as sa}from"./C316Za7m.js";import{u as Sa}from"./CQa0sIfA.js";import{u as Fl}from"./D7poRkS0.js";function Tl(){return"default"}function Ol(S,Le=500,pe=Tl,$={}){const I=new Map;return(..._e)=>{const O=pe(..._e);if(!I.has(O)){const B=za(S,Le,$);I.set(O,B)}return I.get(O)(..._e)}}function xl(S,Le,pe,$,I,_e,O,L,B,q,F,re,ee){const ae={},x=V(Le),$e=V(I),v=V({}),M=ce(Oa),{nestedFilters:le,isForm:Q,allFilters:H}=B?{nestedFilters:V([]),isForm:V(!1),allFilters:V([])}:Sa(),{baseMeta:ge}=xa($a()),ke=ce(Ma,V(!1)),{$api:U,$e:C}=Ca(),{isUIAllowed:Be}=Da(),{metas:ye,getMeta:Fe}=Ea(),{addUndo:Me,clone:be,defineViewScope:Te}=Ha(),je=V([...$e.value||[]]),he=W(()=>ke.value||!Be("filterSync")||!Be("filterChildrenRead")),i=W({get:()=>he.value&&!L&&!O&&!B||Q.value&&!O?$e.value:je.value,set:t=>{if(Q.value&&!O){$e.value=t;return}else if(he.value){$e.value=t,!L&&!O&&!B&&(_e||(le.value=t),le.value=[...le.value]),M==null||M.trigger();return}je.value=t}}),Ke=W(()=>i.value.filter(t=>t.status!=="delete")),Ce=ce(Va,V()),z=ce(Ua,V()),{showSystemFields:te}=q!=null&&q.value?{showSystemFields:V(!1)}:Fl(),Je=W(()=>{var t,n;return(n=(t=Ce.value)==null?void 0:t.columns)==null?void 0:n.filter(o=>na(o)?te.value:o.uidt===j.QrCode||o.uidt===j.Barcode||o.uidt===j.ID||o.system?!1:!(o.colOptions&&o.system))}),Ve=W(()=>{var t,n,o,d;return(n=(t=Ce.value)==null?void 0:t.columns)!=null&&n.length?(d=(o=Ce.value)==null?void 0:o.columns)==null?void 0:d.reduce((f,p)=>{if(p.uidt===j.Formula){const m=Pa({formulaColumn:p});f[p.id]=m||p.uidt}else v.value[p.id]?f[p.id]=v.value[p.id].uidt:f[p.id]=p.uidt;return f},{}):{}}),we=V([]);Ra(i,t=>{we.value=be(t)});const se=(t,n)=>Object.entries(n).filter(([o,d])=>t[o]!==d&&o in t).reduce((o,[d,f])=>({...o,[d]:f}),{}),Ae=(t,n)=>{const o=["empty","notempty","null","notnull"].includes(n.value),d=Ve.value[t.fk_column_id];return n.includedTypes?t.fk_column_id&&n.includedTypes.includes(d)?o?ge.value.showNullAndEmptyInFilter:!0:!1:n.excludedTypes?t.fk_column_id&&!n.excludedTypes.includes(d)?o?ge.value.showNullAndEmptyInFilter:!0:!1:o?ge.value.showNullAndEmptyInFilter:!0},Ne=(t,n)=>{const o=Ve.value[t.fk_column_id];if(n.includedTypes)return t.fk_column_id&&n.includedTypes.includes(o);if(n.excludedTypes)return t.fk_column_id&&!n.excludedTypes.includes(o)},ne=()=>{var n,o,d,f,p,m;const t=new Set(i.value.slice(1).map(y=>y.logical_op));return{comparison_op:(d=(o=Xe((n=Je.value)==null?void 0:n[0].uidt).filter(y=>{var N;return Ae({fk_column_id:(N=Je.value)==null?void 0:N[0].id},y)}))==null?void 0:o[0])==null?void 0:d.value,value:null,status:"create",logical_op:t.size===1?t.values().next().value:"and",fk_column_id:((m=(p=(f=re==null?void 0:re.value)==null?void 0:f.filter(y=>!na(y)))==null?void 0:p[0])==null?void 0:m.id)??void 0,...ee!=null&&ee.value?{fk_parent_column_id:ee.value}:{}}},Ge=()=>{const t=new Set(i.value.slice(1).map(n=>n.logical_op));return{is_group:!0,status:"create",logical_op:t.size===1?t.values().next().value:"and",...ee!=null&&ee.value?{fk_parent_column_id:ee.value,children:[]}:{}}},Ye=async t=>{const n=[],o=[];for(const d of t)if(d.id&&d.is_group){const f=U.dbTableFilter.childrenRead(d.id).then(p=>{const m=p.list;return o.push(...m),Ye(m)});n.push(f)}await Promise.all(n),!L&&!O&&!B&&H.value.push(...o)},Ze=async({hookId:t,isLink:n,widgetId:o,isWebhook:d,isWidget:f,loadAllFilters:p}={})=>{var m;if((m=S.value)!=null&&m.id&&!(he.value||Q.value&&!d))try{d||t?x.value?i.value=(await U.dbTableFilter.childrenRead(x.value)).list:t&&!_e&&(i.value=(await U.dbTableWebhookFilter.read(t)).list):n||F!=null&&F.value?x.value?i.value=(await U.dbTableFilter.childrenRead(x.value)).list:F!=null&&F.value&&!_e&&(i.value=(await U.dbTableLinkFilter.read(F==null?void 0:F.value)).list):f||o!=null&&o.value?x.value?i.value=(await U.dbTableFilter.childrenRead(x.value)).list:o!=null&&o.value&&!_e&&(i.value=(await U.dbWidgetFilter.read(o==null?void 0:o.value)).list):x.value?i.value=(await U.dbTableFilter.childrenRead(x.value)).list:(i.value=(await U.dbTableFilter.read(S.value.id)).list,p&&(H.value=[...i.value],await Ye(H.value)))}catch(y){console.log(y),la.error(await ta(y))}},We=async({hookId:t,linkId:n,widgetId:o})=>{var d,f;try{for(const[p,m]of Object.entries(i.value))if(m.status==="delete")await U.dbTableFilter.delete(m.id),m.is_group?ze(m):!L&&!O&&!B&&(H.value=H.value.filter(y=>y.id!==m.id));else if(m.status==="update")await U.dbTableFilter.update(m.id,{...m,fk_parent_id:x.value});else if(m.status==="create"){const y=(d=i.value[+p])==null?void 0:d.children;t?i.value[+p]=await U.dbTableWebhookFilter.create(t,{...m,children:void 0,fk_parent_id:x.value}):n||F!=null&&F.value?i.value[+p]=await U.dbTableLinkFilter.create(n||F.value,{...m,children:void 0,fk_parent_id:x.value}):o||o!=null&&o.value?i.value[+p]=await U.dbWidgetFilter.create(o||o.value,{...m,children:void 0,fk_parent_id:x.value}):i.value[+p]=await U.dbTableFilter.create((f=S==null?void 0:S.value)==null?void 0:f.id,{...m,fk_parent_id:x.value}),y&&(i.value[+p].children=y),!L&&!O&&!B&&H.value.push(i.value[+p])}!O&&!L&&!B&&($==null||$())}catch(p){console.log(p),la.error(await ta(p))}},qe=Ol(ve,500,(t,n)=>n);async function ve(t,n,o=!1,d=!1,f=!1){var p,m;if(ae[n])return qe(t,n,o,d,f);if(Array.from({length:n}).some((y,N)=>ae[N]))return qe(t,n,o,d,f);if(ae[n]=!0,!(!S.value&&!(F!=null&&F.value)&&!(q!=null&&q.value))){if(!d&&!(Q.value&&!O)){const y=we.value[n];if(y){const N=be(se(t,y));Object.keys(N).length>0&&Me({undo:{fn:(me,Ee)=>{const fe=i.value[n];fe&&(fe[me]=Ee,ve(fe,n,o,!0))},args:[Object.keys(N)[0],Object.values(N)[0]]},redo:{fn:(me,Ee)=>{const fe=i.value[n];fe&&(fe[me]=Ee,ve(fe,n,o,!0))},args:[Object.keys(N)[0],t[Object.keys(N)[0]]]},scope:Te({view:z.value})})}}try{if(he.value)i.value[n]={...t},i.value=[...i.value];else if(!(pe!=null&&pe.value)&&!o)t.status=t.id?"update":"create";else if((p=i.value[n])!=null&&p.id&&((m=i.value[n])==null?void 0:m.status)!=="create")await U.dbTableFilter.update(i.value[n].id,{...t,fk_parent_id:x.value}),C("a:filter:update",{logical:t.logical_op,comparison:t.comparison_op,link:!!L,widget:!!B,webHook:!!O});else{if(F!=null&&F.value){const y=await U.dbTableLinkFilter.create(F.value,{...t,fk_parent_id:x.value});i.value[n]={...i.value[n],fk_parent_id:x.value,id:y.id,status:void 0}}else if(q!=null&&q.value){const y=await U.dbWidgetFilter.create(q.value,{...t,fk_parent_id:x.value});i.value[n]={...i.value[n],fk_parent_id:x.value,id:y.id,status:void 0}}else{const y=await U.dbTableFilter.create(S.value.id,{...t,fk_parent_id:x.value});i.value[n]={...i.value[n],fk_parent_id:x.value,id:y.id,status:void 0}}!L&&!O&&!B&&H.value.push(i.value[+n])}}catch(y){console.log(y),la.error(await ta(y))}finally{ae[n]=!1}we.value=be(i.value),!O&&!f&&!L&&!B&&($==null||$())}}function ze(t){H.value.filter(o=>o.fk_parent_id===t.id).forEach(o=>{o.is_group&&ze(o)}),H.value=H.value.filter(o=>o.id!==t.id&&o.fk_parent_id!==t.id)}const De=async(t,n,o=!1)=>{if(t.status="delete",!o&&!t.is_group&&!(Q.value&&!O)&&Me({undo:{fn:async d=>{d.status="create",i.value.splice(n,0,d),await ve(d,n,!1,!0)},args:[be(t)]},redo:{fn:async d=>{await De(i.value[d],d,!0)},args:[n]},scope:Te({view:z.value})}),he.value)i.value.splice(n,1),i.value=[...i.value],!O&&!L&&!B&&($==null||$());else{if(t.id)if(!(pe!=null&&pe.value))t.status="delete";else try{await U.dbTableFilter.delete(t.id),!O&&!L&&!B&&($==null||$());const d=i.value.findIndex(f=>f.id===t.id);d>-1&&i.value.splice(d,1)}catch(d){console.log(d),la.error(await ta(d))}else i.value.splice(n,1);C("a:filter:delete",{length:Ke.value.length,link:!!L,webHook:!!O,widget:!!B})}t.is_group?ze(t):!L&&!O&&!B&&(H.value=H.value.filter(d=>d.id!==t.id))},oa=async(t=!1,n={})=>{i.value.push(n!=null&&n.fk_column_id?{...ne(),...n}:ne()),!t&&!(Q.value&&!O)&&Me({undo:{fn:async function(d){this.redo.args=[d,be(i.value[d])],await De(i.value[d],d,!0)},args:[i.value.length-1]},redo:{fn:async(o,d)=>{d.status="create",i.value.splice(o,0,d),await ve(d,o,!1,!0)},args:[]},scope:Te({view:z.value})}),we.value=be(i.value),C("a:filter:add",{length:i.value.length,link:!!L,webHook:!!O,widget:!!B})},oe=async()=>{const t=ne(),n=Ge();he.value&&(n.children=[t]),i.value.push(n);const o=i.value.length-1;await ve(i.value[o],o),we.value=be(i.value),C("a:filter:add",{length:i.value.length,group:!0,link:!!L,webHook:!!O,widget:!!B})};return Qe(()=>{var t,n,o,d,f,p;return!(S!=null&&S.value)||!((n=ye==null?void 0:ye.value)!=null&&n[(t=S==null?void 0:S.value)==null?void 0:t.fk_model_id])?0:((p=(f=(d=ye==null?void 0:ye.value)==null?void 0:d[(o=S==null?void 0:S.value)==null?void 0:o.fk_model_id])==null?void 0:f.columns)==null?void 0:p.length)||0},async(t,n)=>{t&&t<n&&await Ze()}),{filters:i,nonDeletedFilters:Ke,loadFilters:Ze,sync:We,deleteFilter:De,saveOrUpdate:ve,addFilter:oa,addFilterGroup:oe,saveOrUpdateDebounced:qe,isComparisonOpAllowed:Ae,isComparisonSubOpAllowed:Ne,loadBtLookupTypes:async()=>{var n,o,d,f;const t={};try{for(const p of((n=Ce.value)==null?void 0:n.columns)||[]){if(p.uidt!==j.Lookup)continue;let m=p;for(;m&&m.uidt===j.Lookup;){const y=(d=(o=await Fe(m.fk_model_id))==null?void 0:o.columns)==null?void 0:d.find(me=>me.id===m.colOptions.fk_relation_column_id);if(!y)break;const N=await Fe((y==null?void 0:y.colOptions).fk_related_model_id);if(m=(f=N==null?void 0:N.columns)==null?void 0:f.find(me=>me.id===m.colOptions.fk_lookup_column_id),(m==null?void 0:m.id)===p.id)break}t[p.id]=m}v.value=t}catch(p){console.error(p)}},btLookupTypesMap:v,types:Ve}}const $l=dl(()=>_l(()=>Promise.resolve().then(()=>ot),void 0,import.meta.url).then(S=>S.default||S)),Ml={key:0,class:"flex min-w-full w-min items-center gap-1 mb-2"},Cl={class:"flex items-center gap-1"},Vl={class:"flex items-center gap-1"},Ul={class:"flex items-center gap-1"},Sl={class:"flex items-center gap-1"},Ll={key:0,class:"flex flex-col min-w-full w-min gap-y-2"},Bl={key:0,class:"flex items-center nc-filter-where-label ml-1"},jl={class:"flex items-center w-full justify-between w-full gap-2"},Al={class:"truncate flex-1 capitalize"},Nl={key:0,class:"flex items-center !min-w-18 !max-w-18 pl-3 nc-filter-where-label"},Gl={class:"flex items-center w-full justify-between w-full gap-2"},ql={class:"truncate flex-1 capitalize"},zl={class:"flex items-center w-full justify-between w-full gap-2"},Dl={class:"truncate flex-1"},El={key:0,class:"flex flex-grow"},Hl={class:"flex items-center w-full justify-between w-full gap-2 max-w-40"},Pl={class:"flex items-center flex-grow"},Rl={key:0,class:"flex-grow"},Ql={key:2,class:"flex-grow"},Xl={class:"relative overflow-visible min-h-17 w-10"},Kl={class:"absolute -top-21 flex flex-col min-h-34.5 w-70 p-1.5 bg-white rounded-lg border-1 border-gray-200 justify-start overflow-hidden",style:{"box-shadow":"0px 4px 6px -2px rgba(0, 0, 0, 0.06), 0px -12px 16px -4px rgba(0, 0, 0, 0.1)"}},Jl=["onClick"],Yl={class:"flex flex-row items-center justify-between w-full"},Zl=["onClick"],Wl={class:"flex flex-row items-center justify-between w-full"},Il={key:2,class:"flex"},et={class:"flex items-center gap-1"},at={class:"flex items-center gap-1"},lt={class:"flex items-center gap-1"},tt={class:"flex items-center gap-1"},st=Qa({__name:"ColumnFilter",props:{nestedLevel:{default:0},parentId:{default:void 0},autoSave:{type:Boolean,default:!0},hookId:{default:void 0},widgetId:{default:void 0},showLoading:{type:Boolean,default:!0},modelValue:{},webHook:{type:Boolean,default:!1},link:{type:Boolean,default:!1},showDynamicCondition:{type:Boolean,default:!0},widget:{type:Boolean,default:!1},draftFilter:{},isOpen:{type:Boolean},rootMeta:{},linkColId:{default:void 0},parentColId:{default:void 0},actionBtnType:{default:"text"},filterOption:{},visibilityError:{default:()=>({})},disableAddNewFilter:{type:Boolean,default:!1},hiddenAddNewFilter:{type:Boolean,default:!1},isViewFilter:{type:Boolean,default:!1},readOnly:{type:Boolean,default:!1},queryFilter:{type:Boolean},isColourFilter:{type:Boolean,default:!1}},emits:["update:filtersLength","update:draftFilter","update:modelValue","update:isOpen","addFilter","addFilterGroup"],setup(S,{expose:Le,emit:pe}){var wa,ha;const $=S,I=pe,_e=$.modelValue,O=[j.QrCode,j.Barcode,j.Button],L=ca($,"draftFilter",I),B=ca($,"modelValue",I),q=ca($,"isOpen",I);Xa(Ka,V(!0));const{nestedLevel:F,parentId:re,autoSave:ee,hookId:ae,widgetId:x,showLoading:$e,webHook:v,link:M,widget:le,linkColId:Q,parentColId:H,visibilityError:ge,disableAddNewFilter:ke,isViewFilter:U}=Ja($),C=W(()=>F.value>0),{t:Be}=Ya(),ye=[{value:"and",text:Be("general.and")},{value:"or",text:Be("general.or")}],Fe=ce(Va,V()),Me=ce(Ua,V()),be=ce(Oa),Te=ce(Za),je=ce(Ma,V(!1)),he=ce(Wa,V(!1)),i=W(()=>he.value&&U.value),{$e:Ke}=Ca(),{nestedFilters:Ce,isForm:z,eventBus:te}=le.value?{nestedFilters:V([]),isForm:V(!1),eventBus:null}:Sa(),Je=B.value||!M.value&&!v.value&&Ce.value||[],Ve=W(()=>{var e;return(e=Fe.value)==null?void 0:e.columns}),we=W(()=>(Ve.value||[]).filter(e=>{if(M.value&&na(e)&&!e.pk&&!Ia(e))return!1;const l=$.filterOption?$.filterOption(e):!0;return!O.includes(e.uidt)&&l})),{filters:se,nonDeletedFilters:Ae,deleteFilter:Ne,saveOrUpdate:ne,loadFilters:Ge,addFilter:Ye,addFilterGroup:Ze,sync:We,saveOrUpdateDebounced:qe,isComparisonOpAllowed:ve,isComparisonSubOpAllowed:ze,loadBtLookupTypes:De,btLookupTypesMap:oa,types:oe}=xl(Me,re,W(()=>ee.value),()=>{be.trigger({shouldShowLoading:$e.value,offset:0,isFormFieldFilters:z.value&&!v.value}),Te==null||Te.trigger({path:[]})},Je,$.nestedLevel>0,v.value,M.value,le.value,x,Q,we,H),{getPlanLimit:ia}=el(),t=V(),n=V(),o=V(),d=V(!1),f=e=>{var l;return oa.value[e.fk_column_id]||((l=Ve.value)==null?void 0:l.find(c=>c.id===e.fk_column_id))},p=V({}),m=(e,l)=>{var c,w,b,D;return!(e.id||e.comparison_op&&((w=sa(e.comparison_op,(c=l==null?void 0:l.meta)==null?void 0:c.date_format).find(Y=>Y.value===e.comparison_sub_op))!=null&&w.ignoreVal)||(D=Xe(oe.value[l.id],(b=l==null?void 0:l.meta)==null?void 0:b.date_format).find(Y=>Y.value===e.comparison_op))!=null&&D.ignoreVal||e.value)},y=(e,l)=>{var w;const c=f(e);c&&(c.uidt===j.SingleSelect&&["anyof","nanyof"].includes(p.value[e.id])&&["eq","neq"].includes(e.comparison_op)?e.value=null:["blank","notblank","empty","notempty","null","notnull"].includes(e.comparison_op)?(e.value=null,e.comparison_sub_op=null):Ie(oe.value[c.id])&&(e.value=null,sa(e.comparison_op,(w=c==null?void 0:c.meta)==null?void 0:w.date_format).map(b=>b.value).includes(e.comparison_sub_op)||(e.comparison_op==="isWithin"?e.comparison_sub_op="pastNumberOfDays":e.comparison_sub_op="exactDate")),m(e,c)||ne(e,l),p.value[e.id]=e.comparison_op,Ke("a:filter:update",{logical:e.logical_op,comparison:e.comparison_op,comparison_sub_op:e.comparison_sub_op,link:!!M.value,webHook:!!v.value}))};Qe(()=>{var e;return(e=Me.value)==null?void 0:e.id},(e,l)=>{!C.value&&e!==l&&(ae!=null&&ae.value||!v.value)&&(Q!=null&&Q.value||!M.value)&&(x.value||!le.value)&&Ge({hookId:ae.value,isWebhook:v.value,widgetId:x.value,isWidget:le.value,linkColId:a(Q),isLink:M.value})});const N=ce(al,V({}));Qe(()=>Ae.value.length,e=>{N.value[(re==null?void 0:re.value)??"root"]=[...Ae.value],I("update:filtersLength",e??0)});const me=W(()=>Object.values(N.value).reduce((e,l)=>e+l.filter(c=>!c.is_group).length,0)),Ee=async(e,l=!1,c=!0)=>{var w;if(!c)for(let b=se.value.length-1;b>=0;b--)await Ne(se.value[b],b);if(M.value){if(!e&&!$.nestedLevel)return;await We({linkId:e,nested:l})}else await We({hookId:e,nested:l});if((w=t.value)!=null&&w.length)for(const b of t.value)b.parentId&&await b.applyChanges(e,!0,void 0)},fe=(e,l)=>{var w,b;const c=f(e);c&&(va(c)?ya(e,l).catch(()=>{}):e.fk_value_col_id=null,e.comparison_op=(b=Xe(oe.value[c.id],(w=c==null?void 0:c.meta)==null?void 0:w.date_format).find(D=>ve(e,D)))==null?void 0:b.value,Ie(oe.value[c.id])&&!["blank","notblank"].includes(e.comparison_op)?e.comparison_op==="isWithin"?e.comparison_sub_op="pastNumberOfDays":e.comparison_sub_op="exactDate":e.comparison_sub_op=null,e.value=null,e.dynamic&&!ra(e)&&(e.dynamic=!1,e.fk_value_col_id=null),m(e,c)||ne(e,l))},La=(e,l,c)=>{l.value=e,qe(l,c)},ua=()=>{var e;(e=n.value)==null||e.scrollTo({top:n.value.scrollHeight,behavior:"smooth"})},ma=()=>{var e;C.value&&((e=o==null?void 0:o.value)==null||e.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"}))},Ue=async e=>{await Ye(!1,e),e&&fe(se.value[se.value.length-1],se.value.length-1),C.value?ma():ua(),I("addFilter",C.value)},He=async()=>{await Ze(),C.value?ma():ua(),I("addFilterGroup",C.value)},Se=e=>{var c,w,b,D,Y;const l=f(e);return e.comparison_op?e.comparison_sub_op?!((b=sa(e.comparison_op,(w=(c=f(e))==null?void 0:c.meta)==null?void 0:w.date_format).find(ie=>ie.value===e.comparison_sub_op))!=null&&b.ignoreVal):!((Y=Xe(oe.value[l==null?void 0:l.id],(D=l==null?void 0:l.meta)==null?void 0:D.date_format).find(ie=>ie.value===e.comparison_op))!=null&&Y.ignoreVal):!1},fa=async e=>{e===fl.FIELD_UPDATE&&await Ge({loadAllFilters:!0})};ll(async()=>{var e;(e=te==null?void 0:te.on)==null||e.call(te,fa),await Promise.all([(async()=>{_e||await Ge({hookId:ae==null?void 0:ae.value,isWebhook:v.value,isWidget:le.value,widgetId:x.value,linkColId:a(Q),isLink:M.value})})(),De()]),d.value=!0}),tl(()=>{var e;(e=te==null?void 0:te.off)==null||e.call(te,fa),re.value&&delete N.value[re.value]});function Ie(e){return[j.Date,j.DateTime,j.CreatedTime,j.LastModifiedTime].includes(e)}Qe([L,d],async()=>{var c,w;if(!d.value||!((c=L.value)!=null&&c.fk_column_id))return;await Ue(L.value),await sl(),ua();const e=document.querySelectorAll(`.nc-filter-wrapper-${L.value.fk_column_id}`);if(L.value={},!e.length)return;const l=(w=e[e.length-1])==null?void 0:w.querySelector(".nc-filter-value-select input");l&&setTimeout(()=>{var b,D;(b=l==null?void 0:l.focus)==null||b.call(l),(D=l==null?void 0:l.click)==null||D.call(l)},100)},{deep:!0,immediate:!0});const J=W(()=>se.value.filter(e=>e.status!=="delete")),ea=W(()=>new Set(J.value.slice(1).map(e=>e.logical_op)).size>1),_a=async(e,l)=>{l===1&&J.value.slice(2).every(c=>c.logical_op!==e.logical_op)&&await Promise.all(J.value.slice(2).map(async(c,w)=>{c.logical_op=e.logical_op,await ne(c,w+2,!1,!1,!0)})),await ne(e,l)};Qe(se,e=>{e&&e!==B.value&&(B.value=e)},{immediate:!0});async function ya(e,l){e.dynamic=!1,e.fk_value_col_id=null,await ne(e,l)}const{sqlUis:ba}=xa($a()),da=(wa=Fe.value)!=null&&wa.source_id?ba.value[(ha=Fe.value)==null?void 0:ha.source_id]:Object.values(ba.value)[0],ra=e=>{const l=f(e);if(va(l)||[j.Attachment,j.Rating,j.Checkbox,j.QrCode,j.Barcode,j.Collaborator,j.GeoData,j.SpecificDBType].includes(l.uidt))return!1;const c=da.getAbstractType(l);return["integer","float","text","string"].includes(c)?!e.comparison_op||["eq","lt","gt","lte","gte","like","nlike","neq"].includes(e.comparison_op):!1},Ba=e=>{var c,w;const l=f(e);return l?(w=(c=$.rootMeta)==null?void 0:c.columns)==null?void 0:w.filter(b=>{if(O.includes(b.uidt)||va(b)||na(b)&&!b.pk)return!1;const D=da.getAbstractType(b),Y=da.getAbstractType(l);return[D,Y].every(ie=>["float","integer"].includes(ie))||[D,Y].every(ie=>["text","string"].includes(ie))?!0:Y===D}):[]},ja=async(e,l)=>{e.dynamic=ra(e)&&Se(e),await ne(e,l)};return Le({applyChanges:Ee,parentId:re,addFilterGroup:He,addFilter:Ue}),(e,l)=>{const c=il,w=ol,b=bl,D=wl,Y=ul,ie=pl,aa=cl,Aa=$l,ga=vl,ka=hl,Na=ml,Ga=gl,qa=kl,Oe=nl("e");return u(),h("div",{"data-testid":"nc-filter",class:E(["menu-filter-dropdown w-min",{"min-w-122 py-2 pl-4":!a(C)&&!e.queryFilter,"max-h-[max(80vh,500px)]":!a(C)&&!e.queryFilter&&!a(M),"max-h-[max(50vh,400px)]":!a(C)&&!e.queryFilter&&a(M),"!min-w-127.5":a(z)&&!a(v),"!min-w-full !w-full !pl-0":!a(C)&&a(v),"min-w-full":a(C)||e.queryFilter}])},[a(C)?(u(),h("div",Ml,[T("div",{class:E([`nc-filter-logical-op-level-${a(F)}`])},[pa(e.$slots,"start",{},void 0,!0)],2),l[11]||(l[11]=T("div",{class:"flex-grow"},null,-1)),Z(Y,{trigger:["hover"],"overlay-class-name":"nc-dropdown-filter-group-sub-menu",disabled:a(ke)||a(i)||e.readOnly},{overlay:g(()=>[Z(D,null,{default:g(()=>[!("isEeUI"in e?e.isEeUI:a(Fa))&&!a(je)?(u(),h(P,{key:0},[a(me)<a(ia)(a(Ta).LIMIT_FILTER_PER_VIEW)?(u(),h(P,{key:0},[Z(b,{"data-testid":"add-filter-menu",onClick:R(Ue,["stop"])},{default:g(()=>[T("div",Cl,[(u(),_(X(("iconMap"in e?e.iconMap:a(K)).plus),{"data-testid":"filter-add-icon"})),de(" "+G(a(z)&&!a(v)?e.$t("activity.addCondition"):e.$t("activity.addFilter")),1)])]),_:1}),a(F)<5?(u(),_(b,{key:0,"data-testid":"add-filter-group-menu",onClick:R(He,["stop"])},{default:g(()=>[T("div",Vl,[(u(),_(X(("iconMap"in e?e.iconMap:a(K)).plusSquare))),de(" "+G(a(z)&&!a(v)?e.$t("activity.addConditionGroup"):e.$t("activity.addFilterGroup")),1)])]),_:1})):k("",!0)],64)):k("",!0)],64)):(u(),h(P,{key:1},[Z(b,{"data-testid":"add-filter-menu",onClick:R(Ue,["stop"])},{default:g(()=>[T("div",Ul,[(u(),_(X(("iconMap"in e?e.iconMap:a(K)).plus),{"data-testid":"filter-add-icon"})),de(" "+G(a(z)&&!a(v)?e.$t("activity.addCondition"):e.$t("activity.addFilter")),1)])]),_:1}),!a(v)&&a(F)<5?(u(),_(b,{key:0,"data-testid":"add-filter-group-menu",onClick:R(He,["stop"])},{default:g(()=>[T("div",Sl,[(u(),_(X(("iconMap"in e?e.iconMap:a(K)).plusSquare))),de(" "+G(a(z)&&!a(v)?e.$t("activity.addConditionGroup"):e.$t("activity.addFilterGroup")),1)])]),_:1})):k("",!0)],64))]),_:1})]),default:g(()=>[Z(w,{size:"xs",type:"text",disabled:a(ke)||a(i)||e.readOnly},{default:g(()=>[Z(c,{icon:"plus",class:"cursor-pointer","data-testid":"filter-add-icon"})]),_:1},8,["disabled"])]),_:1},8,["disabled"]),T("div",null,[pa(e.$slots,"end",{},void 0,!0)])])):k("",!0),a(J)&&a(J).length?(u(),h("div",{key:1,ref_key:"wrapperDomRef",ref:n,class:E(["flex flex-col gap-y-1.5 nc-filter-grid min-w-full w-min",{"nc-scrollbar-thin nc-filter-top-wrapper pr-4 mt-1 mb-2 py-1":!a(C)&&!e.queryFilter,"max-h-420px":!a(C)&&!e.queryFilter&&!a(M),"max-h-320px":!a(C)&&!e.queryFilter&&a(M),"!pr-0":a(v)&&!a(C)}]),onClick:l[5]||(l[5]=R(()=>{},["stop"]))},[(u(!0),h(P,null,Re(a(se),(s,A)=>(u(),h(P,{key:A},[s.status!=="delete"?(u(),h(P,{key:0},[s.is_group?(u(),h("div",Ll,[T("div",{class:E(["flex rounded-lg p-2 min-w-full w-min border-1",[`nc-filter-nested-level-${a(F)}`]])},[s.id||s.children||!a(ee)?(u(),_(Aa,{key:A,ref_for:!0,ref_key:"localNestedFilters",ref:t,modelValue:s.children,"onUpdate:modelValue":r=>s.children=r,"is-open":a(q),"onUpdate:isOpen":l[1]||(l[1]=r=>rl(q)?q.value=r:null),"nested-level":a(F)+1,"parent-id":s.id,"auto-save":a(ee),"web-hook":a(v),link:a(M),"show-dynamic-condition":e.showDynamicCondition,"show-loading":!1,"root-meta":e.rootMeta,"link-col-id":a(Q),"widget-id":a(x),widget:a(le),"parent-col-id":a(H),"filter-option":e.filterOption,"visibility-error":a(ge),"disable-add-new-filter":a(ke),"is-view-filter":a(U),"read-only":e.readOnly},{start:g(()=>[a(J).indexOf(s)?(u(),h("div",{key:`${A}nested`,class:"flex nc-filter-logical-op"},[xe((u(),_(aa,{value:s.logical_op,"onUpdate:value":r=>s.logical_op=r,"dropdown-match-select-width":!1,class:E(["min-w-18 capitalize",{"nc-disabled-logical-op":s.readOnly||A>1&&!a(ea),"!max-w-18":!a(v),"!w-full":a(v)}]),placeholder:"Group op","dropdown-class-name":"nc-dropdown-filter-logical-op-group",disabled:A>1&&!a(ea)||a(i)||e.readOnly,onClick:l[0]||(l[0]=R(()=>{},["stop"])),onChange:r=>_a(s,A)},{default:g(()=>[(u(),h(P,null,Re(ye,r=>Z(ie,{key:r.value,value:r.value},{default:g(()=>[T("div",jl,[T("div",Al,G(r.text),1),s.logical_op===r.value?(u(),_(X(("iconMap"in e?e.iconMap:a(K)).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):k("",!0)])]),_:2},1032,["value"])),64))]),_:2},1032,["value","onUpdate:value","disabled","class","onChange"])),[[Oe,["c:filter:logical-op:select"]]])])):(u(),h("span",Bl,G(e.$t("labels.where")),1))]),end:g(()=>[!s.readOnly&&!e.readOnly?xe((u(),_(w,{key:A,type:"text",size:"small",disabled:a(i),class:"nc-filter-item-remove-btn cursor-pointer",onClick:R(r=>a(Ne)(s,A),["stop"])},{default:g(()=>[(u(),_(X(("iconMap"in e?e.iconMap:a(K)).deleteListItem)))]),_:2},1032,["disabled","onClick"])),[[Oe,["c:filter:delete",{link:!!a(M),webHook:!!a(v)}]]]):k("",!0)]),_:2},1032,["modelValue","onUpdate:modelValue","is-open","nested-level","parent-id","auto-save","web-hook","link","show-dynamic-condition","root-meta","link-col-id","widget-id","widget","parent-col-id","filter-option","visibility-error","disable-add-new-filter","is-view-filter","read-only"])):k("",!0)],2)])):(u(),h("div",{key:1,class:E(["flex flex-row gap-x-0 w-full nc-filter-wrapper",`nc-filter-wrapper-${s.fk_column_id}`])},[a(J).indexOf(s)?xe((u(),_(aa,{key:1,value:s.logical_op,"onUpdate:value":r=>s.logical_op=r,"dropdown-match-select-width":!1,class:E(["h-full !max-w-18 !min-w-18 capitalize",{"nc-disabled-logical-op":s.readOnly||a(J).indexOf(s)>1&&!a(ea)||e.readOnly}]),"hide-details":"",disabled:s.readOnly||a(J).indexOf(s)>1&&!a(ea)||a(i)||e.readOnly,"dropdown-class-name":"nc-dropdown-filter-logical-op",onChange:r=>_a(s,A),onClick:l[2]||(l[2]=R(()=>{},["stop"]))},{default:g(()=>[(u(),h(P,null,Re(ye,r=>Z(ie,{key:r.value,value:r.value},{default:g(()=>[T("div",Gl,[T("div",ql,G(r.text),1),s.logical_op===r.value?(u(),_(X(("iconMap"in e?e.iconMap:a(K)).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):k("",!0)])]),_:2},1032,["value"])),64))]),_:2},1032,["value","onUpdate:value","disabled","class","onChange"])),[[Oe,["c:filter:logical-op:select",{link:!!a(M),webHook:!!a(v)}]]]):(u(),h("div",Nl,G(e.$t("labels.where")),1)),a(z)&&!a(v)&&!a(we).find(r=>(r==null?void 0:r.id)===s.fk_column_id)?(u(),_(ga,{key:2,class:"flex-1 flex items-center gap-2 px-2 !text-red-500 cursor-pointer",disabled:!s.fk_column_id||!a(ge)[s.fk_column_id]},{title:g(()=>[de(G(a(ge)[s.fk_column_id]??""),1)]),default:g(()=>[Z(c,{icon:"alertTriangle",class:"flex-none"}),de(" "+G(e.$t("title.fieldInaccessible")),1)]),_:2},1032,["disabled"])):(u(),h(P,{key:3},[(u(),_(ka,{key:`${A}_6`,modelValue:s.fk_column_id,"onUpdate:modelValue":r=>s.fk_column_id=r,class:E([{"max-w-32":!a(v),"!w-full":a(v)},"nc-filter-field-select min-w-32 max-h-8"]),columns:a(we),"disable-smartsheet":!!a(le),disabled:s.readOnly||a(i)||e.readOnly,meta:a(Fe),onClick:l[3]||(l[3]=R(()=>{},["stop"])),onChange:r=>fe(s,A)},null,8,["modelValue","onUpdate:modelValue","class","columns","disable-smartsheet","disabled","meta","onChange"])),xe((u(),_(aa,{value:s.comparison_op,"onUpdate:value":r=>s.comparison_op=r,"dropdown-match-select-width":!1,class:E(["caption nc-filter-operation-select !min-w-26.75 max-h-8",{"!max-w-26.75":!a(v),"!w-full":a(v)}]),placeholder:e.$t("labels.operation"),density:"compact",variant:"solo",disabled:s.readOnly||a(i)||e.readOnly,"hide-details":"","dropdown-class-name":"nc-dropdown-filter-comp-op !max-w-80",onChange:r=>y(s,A)},{default:g(()=>{var r,Pe;return[(u(!0),h(P,null,Re(("comparisonOpList"in e?e.comparisonOpList:a(Xe))(a(oe)[s.fk_column_id],(Pe=(r=f(s))==null?void 0:r.meta)==null?void 0:Pe.date_format),ue=>(u(),h(P,{key:ue.value},[a(ve)(s,ue)?(u(),_(ie,{key:0,value:ue.value},{default:g(()=>[T("div",zl,[T("div",Dl,G(ue.text),1),s.comparison_op===ue.value?(u(),_(X(("iconMap"in e?e.iconMap:a(K)).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):k("",!0)])]),_:2},1032,["value"])):k("",!0)],64))),128))]}),_:2},1032,["value","onUpdate:value","placeholder","class","disabled","onChange"])),[[Oe,["c:filter:comparison-op:select",{link:!!a(M),webHook:!!a(v)}]]]),["blank","notblank"].includes(s.comparison_op)?(u(),h("div",El)):Ie(a(oe)[s.fk_column_id])?xe((u(),_(aa,{key:1,value:s.comparison_sub_op,"onUpdate:value":r=>s.comparison_sub_op=r,"dropdown-match-select-width":!1,class:E(["caption nc-filter-sub_operation-select min-w-28",{"flex-grow w-full":!Se(s),"max-w-28":Se(s)&&!a(v)}]),placeholder:e.$t("labels.operationSub"),density:"compact",variant:"solo",disabled:s.readOnly||a(i)||e.readOnly,"hide-details":"","dropdown-class-name":"nc-dropdown-filter-comp-sub-op",onChange:r=>y(s,A)},{default:g(()=>{var r,Pe;return[(u(!0),h(P,null,Re(("comparisonSubOpList"in e?e.comparisonSubOpList:a(sa))(s.comparison_op,(Pe=(r=f(s))==null?void 0:r.meta)==null?void 0:Pe.date_format),ue=>(u(),h(P,{key:ue.value},[a(ze)(s,ue)?(u(),_(ie,{key:0,value:ue.value},{default:g(()=>[T("div",Hl,[Z(ga,{"show-on-truncate-only":"",class:"truncate flex-1"},{title:g(()=>[de(G(ue.text),1)]),default:g(()=>[de(" "+G(ue.text),1)]),_:2},1024),s.comparison_sub_op===ue.value?(u(),_(X(("iconMap"in e?e.iconMap:a(K)).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):k("",!0)])]),_:2},1032,["value"])):k("",!0)],64))),128))]}),_:2},1032,["value","onUpdate:value","class","placeholder","disabled","onChange"])),[[Oe,["c:filter:sub-comparison-op:select",{link:!!a(M),webHook:!!a(v)}]]]):k("",!0),T("div",Pl,[a(M)&&(s.dynamic||s.fk_value_col_id)?(u(),h("div",Rl,[Se(s)?(u(),_(ka,{key:0,modelValue:s.fk_value_col_id,"onUpdate:modelValue":r=>s.fk_value_col_id=r,"disable-smartsheet":!!a(le),class:"nc-filter-field-select min-w-32 w-full max-h-8",columns:Ba(s),meta:e.rootMeta,onChange:r=>a(ne)(s,A)},null,8,["modelValue","onUpdate:modelValue","disable-smartsheet","columns","meta","onChange"])):k("",!0)])):(u(),h(P,{key:1},[s.field&&a(oe)[s.field]==="boolean"?(u(),_(Na,{key:0,checked:s.value,"onUpdate:checked":r=>s.value=r,dense:"",disabled:s.readOnly||a(i)||e.readOnly,onChange:r=>a(ne)(s,A)},null,8,["checked","onUpdate:checked","disabled","onChange"])):k("",!0),Se(s)&&(!a(U)||a(q))?(u(),_(Ga,{key:1,class:E(["nc-filter-value-select rounded-md min-w-34",{"!w-full":a(v)}]),column:{...f(s),uidt:a(oe)[s.fk_column_id]},filter:s,disabled:a(i)||e.readOnly,onUpdateFilterValue:r=>La(r,s,A),onClick:l[4]||(l[4]=R(()=>{},["stop"]))},null,8,["class","column","filter","disabled","onUpdateFilterValue"])):Ie(a(oe)[s.fk_column_id])?k("",!0):(u(),h("div",Ql))],64)),a(M)&&e.showDynamicCondition?(u(),_(Y,{key:2,class:"nc-settings-dropdown h-full flex items-center min-w-0 rounded-lg",trigger:["click"],placement:"bottom",disabled:a(i)},{overlay:g(()=>[T("div",Xl,[T("div",Kl,[T("div",{class:"px-4 py-3 flex flex-col select-none gap-y-2 cursor-pointer rounded-md hover:bg-gray-100 text-gray-600 nc-new-record-with-grid group",onClick:r=>ya(s,A)},[T("div",Yl,[l[12]||(l[12]=T("div",{class:"flex flex-row items-center justify-start gap-x-3"},"Static condition",-1)),!s.dynamic&&!s.fk_value_col_id?(u(),_(c,{key:0,icon:"check",class:"w-4 h-4 text-primary"})):k("",!0)]),l[13]||(l[13]=T("div",{class:"flex flex-row text-xs text-gray-400"},"Filter based on static value",-1))],8,Jl),xe((u(),h("div",{class:E(["px-4 py-3 flex flex-col select-none gap-y-2 cursor-pointer rounded-md hover:bg-gray-100 text-gray-600 nc-new-record-with-form group",ra(s)&&Se(s)?"cursor-pointer":"cursor-not-allowed"]),onClick:r=>ja(s,A)},[T("div",Wl,[l[14]||(l[14]=T("div",{class:"flex flex-row items-center justify-start gap-x-2.5"},"Dynamic condition",-1)),s.dynamic||s.fk_value_col_id?(u(),_(c,{key:0,icon:"check",class:"w-4 h-4 text-primary"})):k("",!0)]),l[15]||(l[15]=T("div",{class:"flex flex-row text-xs text-gray-400"},"Filter based on dynamic value",-1))],10,Zl)),[[Oe,["c:filter:dynamic-filter"]]])])])]),default:g(()=>[Z(w,{type:"text",size:"small"},{default:g(()=>[Z(c,{icon:"settings"})]),_:1})]),_:2},1032,["disabled"])):k("",!0)])],64)),!s.readOnly&&!e.readOnly?xe((u(),_(w,{key:4,type:"text",size:"small",disabled:a(i),class:"nc-filter-item-remove-btn self-center",onClick:R(r=>a(Ne)(s,A),["stop"])},{default:g(()=>[(u(),_(X(("iconMap"in e?e.iconMap:a(K)).deleteListItem)))]),_:2},1032,["disabled","onClick"])),[[Oe,["c:filter:delete",{link:!!a(M),webHook:!!a(v)}]]]):k("",!0)],2))],64)):k("",!0)],64))),128))],2)):k("",!0),a(C)?k("",!0):(u(),h("div",Il,[("isEeUI"in e?e.isEeUI:a(Fa))&&!a(je)?(u(),h(P,{key:0},[!e.readOnly&&a(me)<a(ia)(a(Ta).LIMIT_FILTER_PER_VIEW)&&!e.hiddenAddNewFilter?(u(),h("div",{key:0,class:E(["flex gap-2",{"mt-1 mb-2":a(se).length}])},[e.hiddenAddNewFilter?k("",!0):(u(),_(w,{key:0,size:"small",type:e.actionBtnType,disabled:a(ke)||a(i)||e.readOnly,class:"nc-btn-focus","data-testid":"add-filter",onClick:l[6]||(l[6]=R(s=>Ue(),["stop"]))},{default:g(()=>[T("div",et,[(u(),_(X(("iconMap"in e?e.iconMap:a(K)).plus))),de(" "+G(a(z)&&!a(v)?e.$t("activity.addCondition"):e.$t("activity.addFilter")),1)])]),_:1},8,["type","disabled"])),a(F)<5&&!e.readOnly?(u(),_(w,{key:1,class:"nc-btn-focus",disabled:a(ke)||a(i),type:e.actionBtnType,size:"small","data-testid":"add-filter-group",onClick:l[7]||(l[7]=R(s=>He(),["stop"]))},{default:g(()=>[T("div",at,[(u(),_(X(("iconMap"in e?e.iconMap:a(K)).plus))),de(" "+G(a(z)&&!a(v)?e.$t("activity.addConditionGroup"):e.$t("activity.addFilterGroup")),1)])]),_:1},8,["disabled","type"])):k("",!0)],2)):k("",!0)],64)):!e.readOnly&&!e.hiddenAddNewFilter?(u(),h("div",{key:1,ref_key:"addFiltersRowDomRef",ref:o,class:E(["flex gap-2",{"mt-1 mb-2":a(se).length}])},[Z(w,{class:"nc-btn-focus",size:"small",type:e.actionBtnType,"data-testid":"add-filter",disabled:a(i),onClick:l[8]||(l[8]=R(s=>Ue(),["stop"]))},{default:g(()=>[T("div",lt,[(u(),_(X(("iconMap"in e?e.iconMap:a(K)).plus))),de(" "+G(a(z)&&!a(v)?e.$t("activity.addCondition"):e.$t("activity.addFilter")),1)])]),_:1},8,["type","disabled"]),!a(M)&&!a(v)&&a(F)<5?(u(),_(w,{key:0,class:"nc-btn-focus",type:e.actionBtnType,size:"small",disabled:a(i),"data-testid":"add-filter-group",onClick:l[9]||(l[9]=R(s=>He(),["stop"]))},{default:g(()=>[T("div",tt,[(u(),_(X(("iconMap"in e?e.iconMap:a(K)).plus))),de(" "+G(a(z)&&!a(v)?e.$t("activity.addConditionGroup"):e.$t("activity.addFilterGroup")),1)])]),_:1},8,["type","disabled"])):k("",!0)],2)):k("",!0)])),!a(J)||!a(J).length?(u(),h("div",{key:3,class:E(["flex flex-row text-gray-400 mt-2",{"ml-1":a(C),"ml-0.5":!a(C)}])},G(a(z)&&!a(v)?e.$t("title.noConditionsAdded"):e.$t("title.noFiltersAdded")),3)):k("",!0),pa(e.$slots,"default",{},void 0,!0),a(i)&&!a(C)?(u(),_(qa,{key:4,class:E(["-mb-2 -ml-4",{"mt-2":!a(J)||!a(J).length}]),onOnOpen:l[10]||(l[10]=s=>q.value=!1)},null,8,["class"])):k("",!0)],2)}}}),nt=Object.assign(yl(st,[["__scopeId","data-v-f638de40"]]),{__name:"SmartsheetToolbarColumnFilter"}),ot=Object.freeze(Object.defineProperty({__proto__:null,default:nt},Symbol.toStringTag,{value:"Module"}));export{ot as C,nt as _,xl as u};
