const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./B5enLgkq.js","./DRA9KN5F.js","./entry.CNP42Mi6.css","./RichTextOptions.-OI5EMWT.css"])))=>i.map(i=>d[i]);
import{e as Le,G as Ae,r as f,j7 as qe,aQ as Ue,n as Y,le as He,lf as Ve,lg as Ge,lh as Qe,li as Ye,lj as Je,bv as we,eI as Oe,ac as Re,c as m,o as l,ag as M,L as s,K as E,t as w,an as ue,I as C,b as p,O as de,ad as J,aX as Xe,N as Be,w as _,M as Me,$ as j,a_ as Ze,J as Ie,as as et,aR as tt,bk as ot,a8 as Ce,a7 as nt,bd as st,u as at,aG as $e,ba as lt,i as rt,b3 as it,a as d,aq as ct,bV as ut,aH as dt,d as B,ei as pt,b9 as Ee,bo as Te,aA as mt,ap as _t,a3 as ie,Q as Se,aP as ce,aO as ft,_ as vt}from"./DRA9KN5F.js";import{_ as yt}from"./LhVKWcKT.js";import{_ as bt}from"./C2UaKEE0.js";import{_ as xt}from"./C_VN1MCC.js";import{M as ht,_ as gt}from"./B89wxTuy.js";import{S as kt,P as wt,u as Ct,E as $t,t as Et}from"./DjPyxH1k.js";import{u as Tt}from"./DCa6wpIA.js";import{u as St}from"./B8gs0dG7.js";import{a as Lt}from"./yMSt-9W5.js";const At=Xe(()=>Ze(()=>import("./B5enLgkq.js"),__vite__mapDeps([0,1,2,3]),import.meta.url).then(N=>N.default||N)),Ot={key:0,class:"truncate"},Rt={key:0},Bt={key:1,class:"flex justify-between pt-1 rich-text-bottom-bar items-center"},Mt=Le({__name:"RichComment",props:{hideOptions:{type:Boolean,default:!0},value:{},readOnly:{type:Boolean},syncValueChange:{type:Boolean},autofocus:{type:Boolean},autofocusToEnd:{type:Boolean},placeholder:{},renderAsText:{type:Boolean}},emits:["update:value","focus","blur","save"],setup(N,{expose:b,emit:T}){const v=N,y=T,X=Ae(qe,f(!1)),x=f(!1),h=Ue(),S=f(null),U=f(null),L=Y({get:()=>He.preprocessMarkdown(v.value,!0),set:e=>{y("update:value",e)}}),F=[kt.configure({heading:!1,codeBlock:!1,code:!1,strike:!1,hardBreak:!1,italic:!1}),Ve,Ge,Qe,Ye,Je,wt.configure({emptyEditorClass:"is-editor-empty",placeholder:v.placeholder}),ht.configure({breaks:!0,transformPastedText:!1})];function Z(e){return!e||!(e!=null&&e.trim())?!0:/^\s*(<br\s*\/?>\s*)*$/i.test(e)}const i=Ct({content:L.value,extensions:F,onUpdate:({editor:e})=>{let o=e.storage.markdown.getMarkdown();((e==null?void 0:e.isActive("bulletList"))||(e==null?void 0:e.isActive("orderedList"))||(e==null?void 0:e.isActive("blockquote")))&&(o.endsWith("<br>")&&(o=o.slice(0,-4)),o.endsWith("<br> ")&&(o=o.slice(0,-5))),L.value=Z(o)?"":`${o}`},editable:!v.readOnly,autofocus:v.autofocus,onCreate:()=>{v.autofocusToEnd&&j(()=>{var e;(e=i.value)==null||e.commands.setContent(L.value)})},onFocus:()=>{x.value=!0,y("focus")},onBlur:e=>{const o=e==null?void 0:e.event.relatedTarget;o&&(o!=null&&o.closest(".comment-bubble-menu, .nc-rich-text-comment, .tippy-box, .nc-comment-save-btn, .rich-text-bottom-bar, .mention, .nc-mention-list, .tippy-content, .nc-comment-rich-editor")||(x.value=!1,y("blur")))},editorProps:{handleKeyDown(e,o){if(o.key==="Enter"&&!o.ctrlKey&&!o.shiftKey&&!o.metaKey){const{state:c}=e,{selection:g}=c;if(!g.empty)return!0}}}}),H=(e,o)=>{i.value&&(i.value.commands.setContent(e,!1),o&&z())};function A(){var e;!v.readOnly&&!h.shift.value&&((e=i.value)==null||e.chain().focus().run())}function z(){i.value&&j(()=>{var e;(e=i.value)==null||e.chain().focus().run()})}we(S,"focusout",e=>{var c;const o=e==null?void 0:e.relatedTarget;((c=o==null?void 0:o.classList)!=null&&c.contains("tiptap")||!(o!=null&&o.closest(".comment-bubble-menu, .nc-rich-text-comment, .tippy-box, .nc-comment-save-btn, .rich-text-bottom-bar, .mention, .nc-mention-list, .tippy-content, .nc-comment-rich-editor")))&&(x.value=!1,y("blur"))},!0),we(U,"focusout",e=>{var c;const o=e==null?void 0:e.relatedTarget;!o&&((c=e.target)!=null&&c.closest(".comment-bubble-menu, .nc-comment-save-btn, .nc-mention-list, .mention, .rich-text-bottom-bar, .tippy-content, .nc-comment-rich-editor"))||o!=null&&o.closest(".comment-bubble-menu, .nc-comment-save-btn, .rich-text-bottom-bar, .mention, .tippy-content, .nc-mention-list, .nc-comment-rich-editor")||(x.value=!1,y("blur"))},!0),Oe(S,e=>{if(!x.value)return;const o=e==null?void 0:e.target;o!=null&&o.closest(".tippy-content, .nc-rich-text-comment, .nc-comment-save-btn, .nc-mention-list, .rich-text-bottom-bar, .mention, .comment-bubble-menu, .nc-comment-rich-editor")||(x.value=!1,y("blur"))});const P=f(!1),I=e=>{i.value&&(P.value?P.value=!1:i.value.isActive("bulletList")||i.value.isActive("orderedList")||i.value.isActive("blockquote")?e.stopPropagation():y("save"))};let W;const ee=e=>{var c,g,u,R;if(!((c=L.value)!=null&&c.length)){H("");return}W&&clearTimeout(W),((g=i.value)==null?void 0:g.isActive("bulletList"))||((u=i.value)==null?void 0:u.isActive("orderedList"))||((R=i.value)==null?void 0:R.isActive("blockquote"))?(P.value=!0,W=setTimeout(()=>{P.value=!1},1e3)):I(e)},r=e=>{var o,c;e.altKey&&e.key==="Enter"||e.shiftKey&&e.key==="Enter"?e.stopPropagation():e.key==="Enter"?ee(e):e.key==="Escape"&&(x.value=!1,y("blur"),(c=(o=document.querySelector('.nc-drawer-expanded-form.active > div[tabindex="0"]'))==null?void 0:o.focus)==null||c.call(o))},O=e=>{e.preventDefault(),e.stopPropagation(),y("save")};return b({setEditorContent:H,focusEditor:z}),(e,o)=>{var V,D;const c=gt,g=At,u=Me,R=Be,te=Re("e");return l(),m("div",{class:M([{readonly:e.readOnly,"nc-rich-text-grid":s(X)},"nc-rich-text-comment flex flex-col w-full h-full"]),tabindex:1,onFocus:A},[e.renderAsText?(l(),m("div",Ot,[s(i)?(l(),m("span",Rt,w(((V=s(i))==null?void 0:V.getText())??""),1)):E("",!0)])):(l(),m(ue,{key:1},[s(i)?(l(),C(c,{key:0,ref_key:"richTextLinkOptionRef",ref:U,editor:s(i),"is-comment":!0,"is-form-field":!0,onBlur:o[0]||(o[0]=oe=>x.value=!1)},null,8,["editor"])):E("",!0),p(s($t),{ref_key:"editorDom",ref:S,editor:s(i),class:M([{"p-1":!v.readOnly,"px-[0.25rem]":v.readOnly},"nc-rich-text-content flex flex-col nc-comment-rich-editor w-full scrollbar-thin scrollbar-thumb-gray-200 nc-rich-truncate scrollbar-track-transparent"]),onKeydown:de(r,["stop"])},null,8,["editor","class"]),e.hideOptions?E("",!0):(l(),m("div",Bt,[p(g,{editor:s(i),class:"!bg-transparent"},null,8,["editor"]),J((l(),C(R,{disabled:!((D=s(L))!=null&&D.length),class:"!disabled:bg-nc-bg-gray-light nc-comment-save-btn !h-7 !w-7 !shadow-none",size:"xsmall",onClick:O},{default:_(()=>[p(u,{icon:"ncSendAlt"})]),_:1},8,["disabled"])),[[te,["a:row-expand:comment:save"]]])]))],64))],34)}}}),Pt=Object.assign(Mt,{__name:"SmartsheetExpandedFormRichComment"}),Dt={key:0,class:"flex flex-col items-center justify-center w-full h-full"},Kt={key:1,class:"flex flex-col h-full"},jt={key:0,class:"flex flex-col my-1 text-center justify-center h-full nc-scrollbar-thin"},Nt={class:"text-center text-3xl text-nc-content-gray-subtle"},Ft={class:"font-medium text-center my-6 text-nc-content-gray-muted"},zt={class:"flex items-start justify-between"},Wt={class:"flex h-[28px] items-center gap-3 w-[calc(100%_-_40px)]"},qt={class:"truncate text-nc-content-gray font-medium !text-small !leading-[18px] overflow-hidden"},Ut={class:"bg-nc-bg-default rounded-lg"},Ht={class:"flex items-center gap-4 py-3 px-2"},Vt={class:"flex flex-col"},Gt={class:"font-semibold text-nc-content-gray"},Qt={class:"text-xs text-nc-content-gray-subtle2"},Yt={key:0,class:"px-3 rounded-b-lg !text-[13px] items-center text-nc-content-gray-subtle2 flex gap-1 bg-nc-bg-gray-light py-1.5"},Jt={class:"text-xs text-nc-content-gray-muted"},Xt={class:"flex items-center"},Zt={class:"flex gap-2 items-center"},It={class:"flex gap-2 items-center"},eo={class:"flex gap-2 items-center"},to={key:1},oo={key:1,class:"space-y-1 pl-9"},no=["innerHTML"],so={key:2,class:"px-3 pb-3 nc-comment-input !rounded-br-2xl gap-2 flex"},ao=Le({__name:"Comments",setup(N){const{user:b,appInfo:T}=Ie(),{dashboardUrl:v}=Tt(),{isUIAllowed:y}=et(),{copy:X}=tt(),x=ot(),h=Y(()=>y("commentEdit")),{isExpandedFormCommentMode:S}=Ce(St()),U=nt(),{basesUser:L}=Ce(U),F=Ae(st,f()),{deleteComment:Z,resolveComment:i,isCommentsLoading:H,comments:A,loadComments:z,updateComment:P,saveComment:I,primaryKey:W,parsedHtmlComments:ee}=Lt(),r=f(),O=f(),e=f(!1),o=f(!1),c=f(null),g=f(),u=f(""),R=at(),te=Y(()=>{var t,a;return(t=F.value)!=null&&t.base_id?L.value.get((a=F.value)==null?void 0:a.base_id)||[]:[]}),V=lt(Ne,1e3);function D(){O.value&&O.value.scrollTo({top:O.value.scrollHeight,behavior:"smooth"})}const oe=async()=>{var a,k,$,q,G;if(!u.value.trim())return;for(;u.value.endsWith("<br />")||u.value.endsWith(`
`);)u.value.endsWith("<br />")?u.value=u.value.slice(0,-6):u.value=u.value.slice(0,-2);o.value=!0,A.value=[...A.value,{id:`temp-${new Date().getTime()}`,comment:u.value,created_at:new Date().toISOString(),created_by:(a=b.value)==null?void 0:a.id,created_by_email:(k=b.value)==null?void 0:k.email,created_display_name:(($=b.value)==null?void 0:$.display_name)??"",created_by_meta:((q=b.value)==null?void 0:q.meta)??""}];const t=u.value;u.value="",(G=g==null?void 0:g.value)==null||G.setEditorContent("",!0),await j(()=>{D()});try{await I(t),await j(()=>{S.value=!0}),D()}catch(Q){console.error(Q)}},Pe=async t=>{var a;await X(encodeURI(`${v==null?void 0:v.value}#/${x.params.typeOrId}/${x.params.baseId}/${(a=F.value)==null?void 0:a.id}?rowId=${W.value}&commentId=${t.id}`))};function pe(t){const a=document.querySelector(`.${t}`);a&&a.scrollIntoView({behavior:"smooth",block:"center"})}function De(t){e.value&&(t.preventDefault(),t.stopPropagation(),r.value=void 0,z(),e.value=!1,r.value=void 0)}function Ke(t){r.value={...t},e.value=!0,j(()=>{pe(t.id)})}const ne=Y({get(){var t;return((t=r.value)==null?void 0:t.comment)||""},set(t){r.value&&(r.value.comment=t)}});async function me(){var a;if(!e.value||!((a=r.value)!=null&&a.comment))return;for(;r.value.comment.endsWith("<br />")||r.value.comment.endsWith(`
`);)r.value.comment.endsWith("<br />")?r.value.comment=r.value.comment.slice(0,-6):r.value.comment=r.value.comment.slice(0,-2);o.value=!0;const t={...r.value};e.value=!1,r.value=void 0,await P(t.id,{comment:t.comment}),z()}const _e=t=>{var a,k;return t.created_by===((a=b.value)==null?void 0:a.id)?"You":(k=t.created_display_name)!=null&&k.trim()?t.created_display_name||"Shared source":t.created_by_email?t.created_by_email:"Shared source"};function fe(){c.value&&(c.value=null)}$e(O,()=>{setTimeout(()=>{j(()=>{const t=R.currentRoute.value.query,a=t.commentId;a?(R.push({query:{rowId:t.rowId}}),pe(a),c.value=a,Oe(document.querySelector(`.${c.value}`),fe)):D()})},100)});const je=t=>{const a=te.value.find(k=>k.email===t);return a?a.roles??(a.workspace_roles?ft[a.workspace_roles]??ce.NO_ACCESS:ce.NO_ACCESS):ce.NO_ACCESS},se=[];function Ne(){ve(),document.querySelectorAll(".nc-rich-link-tooltip").forEach(t=>{const a=Object.values(t.attributes).find($=>$.name==="data-tooltip");if(!a)return;const k=Et(t,{content:`<span class="tooltip nc-rich-link-tooltip-popup">${a.value}</span>`,placement:"top",allowHTML:!0,arrow:!0,animation:"fade",duration:0});se.push(k)})}function ve(){se.forEach(t=>t==null?void 0:t.destroy()),se.length=0}const ye=t=>{t.key!=="Escape"&&t.stopPropagation()};return $e(A,()=>{V()},{immediate:!0}),rt(()=>{ve()}),(t,a)=>{const k=it,$=Me,q=ut,G=yt,Q=dt,ae=Be,le=bt,Fe=mt,ze=xt,be=_t,xe=Pt,re=Re("e");return l(),m("div",{class:M(["h-full",{"pb-1":!s(h)}])},[s(H)?(l(),m("div",Dt,[p(k,{size:"xlarge"})])):(l(),m("div",Kt,[s(A).length===0?(l(),m("div",jt,[d("div",Nt,[p($,{icon:"commentHere"})]),d("div",Ft,w(s(h)?t.$t("activity.startCommenting"):t.$t("activity.noCommentsYet")),1)])):(l(),m("div",{key:1,ref_key:"commentsWrapperEl",ref:O,class:"flex flex-col h-full py-1 nc-scrollbar-thin"},[(l(!0),m(ue,null,ct(s(A),(n,We)=>{var he,ge,ke;return l(),m("div",{key:n.id,class:M([[{"mt-auto":We===0},n.id],"nc-comment-item"]),onMouseover:fe},[d("div",{class:M([{"hover:bg-nc-bg-gray-light":((he=s(r))==null?void 0:he.id)!==n.id,"nc-hovered-comment bg-nc-bg-gray-light":s(c)===n.id},"group gap-3 overflow-hidden px-3 py-2 transition-colors"])},[d("div",zt,[d("div",{class:M(["flex items-start gap-3 flex-1",{"w-[calc(100%)] group-hover:w-[calc(100%_-_50px)]":!s(T).ee,"w-[calc(100%_-_44px)] group-hover:w-[calc(100%_-_72px)]":s(T).ee&&n.resolved_by,"w-[calc(100%_-_16px)] group-hover:w-[calc(100%_-_72px)]":s(T).ee&&!n.resolved_by&&s(h),"w-[calc(100%_-_16px)] group-hover:w-[calc(100%_-_44px)]":s(T).ee&&!n.resolved_by&&!s(h)}])},[p(q,{user:{display_name:n==null?void 0:n.created_display_name,email:n==null?void 0:n.created_by_email,meta:n==null?void 0:n.created_by_meta},class:"mt-0.5",size:"medium"},null,8,["user"]),d("div",Wt,[p(Q,{placement:"topLeft",trigger:["hover"],class:"flex-none max-w-[calc(100%_-_72px)]"},{overlay:_(()=>[d("div",Ut,[d("div",Ht,[p(q,{class:"border-1 border-nc-border-gray-medium rounded-full",user:{display_name:n==null?void 0:n.created_display_name,email:n==null?void 0:n.created_by_email,meta:n==null?void 0:n.created_by_meta},size:"base"},null,8,["user"]),d("div",Vt,[d("div",Gt,w(_e(n)),1),d("div",Qt,w(n.created_by_email),1)])]),s(y)("dataEdit")?(l(),m("div",Yt,[a[4]||(a[4]=B(" Has ")),p(G,{size:"sm",border:!1,role:je(n.created_by_email)},null,8,["role"]),a[5]||(a[5]=B(" role in base "))])):E("",!0)])]),default:_(()=>[d("div",qt,w(_e(n)),1)]),_:2},1024),d("div",Jt,w(("timeAgo"in t?t.timeAgo:s(pt))(n.created_at)),1)])],2),d("div",Xt,[s(r)?E("",!0):(l(),C(Q,{key:0,class:"nc-comment-more-actions !hidden !group-hover:block","overlay-class-name":"!min-w-[160px]",placement:"bottomRight"},{overlay:_(()=>[p(ze,{variant:"small"},{default:_(()=>[s(b)&&n.created_by_email===s(b).email&&s(h)?J((l(),C(le,{key:0,onClick:K=>Ke(n)},{default:_(()=>[d("div",Zt,[(l(),C(Ee(("iconMap"in t?t.iconMap:s(Te)).rename),{class:"cursor-pointer"})),B(" "+w(t.$t("general.edit")),1)])]),_:2},1032,["onClick"])),[[re,["c:comment-expand:comment:edit"]]]):E("",!0),J((l(),C(le,{onClick:K=>Pe(n)},{default:_(()=>[d("div",It,[(l(),C(Ee(("iconMap"in t?t.iconMap:s(Te)).copy),{class:"cursor-pointer"})),B(" "+w(t.$t("general.copy"))+" URL ",1)])]),_:2},1032,["onClick"])),[[re,["c:comment-expand:comment:copy"]]]),s(b)&&n.created_by_email===s(b).email&&s(h)?(l(),m(ue,{key:1},[p(Fe),J((l(),C(le,{danger:"",onClick:K=>s(Z)(n.id)},{default:_(()=>[d("div",eo,[p($,{icon:"delete",class:"cursor-pointer"}),B(" "+w(t.$t("general.delete")),1)])]),_:2},1032,["onClick"])),[[re,["c:row-expand:comment:delete"]]])],64)):E("",!0)]),_:2},1024)]),default:_(()=>[p(ae,{class:"nc-expand-form-more-actions !hover:bg-nc-bg-gray-medium !w-7 !h-7 !bg-transparent",size:"xsmall",type:"text"},{default:_(()=>[p($,{class:"text-md",icon:"threeDotVertical"})]),_:1})]),_:2},1024)),s(T).ee?(l(),m("div",to,[!n.resolved_by&&s(h)?(l(),C(be,{key:0},{title:_(()=>[B(w(t.$t("activity.clickToResolve")),1)]),default:_(()=>[p(ae,{class:"nc-resolve-comment-btn !w-7 !h-7 !bg-transparent !hover:bg-nc-bg-gray-medium !hidden !group-hover:block",size:"xsmall",type:"text",onClick:K=>s(i)(n.id)},{default:_(()=>[p($,{class:"text-md",icon:"checkCircle"})]),_:2},1032,["onClick"])]),_:2},1024)):n.resolved_by?(l(),C(be,{key:1},{title:_(()=>[B(w(`${t.$t("activity.resolvedBy")} ${n.resolved_display_name}`),1)]),default:_(()=>[p(ae,{class:"!h-7 !w-7 !bg-transparent !hover:bg-nc-bg-gray-medium text-semibold",size:"xsmall",type:"text",onClick:K=>s(i)(n.id)},{default:_(()=>[p($,{class:"text-md rounded-full bg-nc-fill-green-dark text-white",icon:"checkFill"})]),_:2},1032,["onClick"])]),_:2},1024)):E("",!0)])):E("",!0)])]),d("div",{class:M([{"mt-3":n.id===((ge=s(r))==null?void 0:ge.id)},"flex-1 flex flex-col gap-1 max-w-[calc(100%)]"])},[n.id===((ke=s(r))==null?void 0:ke.id)&&s(h)?(l(),C(xe,{key:0,value:s(ne),"onUpdate:value":a[0]||(a[0]=K=>Se(ne)?ne.value=K:null),autofocus:"","autofocus-to-end":"","hide-options":!1,class:"expanded-form-comment-edit-input cursor-text expanded-form-comment-input !py-2 !px-2 !m-0 w-full !border-1 !border-nc-border-gray-medium !rounded-lg !bg-nc-bg-default !text-nc-content-gray !text-small !leading-18px !max-h-[240px]","data-testid":"expanded-form-comment-input",onSave:me,onKeydown:[ie(De,["esc"]),ye,ie(de(me,["exact","prevent"]),["enter"])],onBlur:a[1]||(a[1]=()=>{r.value=void 0,e.value=!1})},null,8,["value","onKeydown"])):(l(),m("div",oo,[d("div",{class:"nc-rich-text-content !text-small !leading-18px !text-nc-content-gray",innerHTML:s(ee)[n.id]},null,8,no)]))],2)],2)],34)}),128))],512)),s(h)?(l(),m("div",so,[p(xe,{ref_key:"commentInputRef",ref:g,value:s(u),"onUpdate:value":a[2]||(a[2]=n=>Se(u)?u.value=n:null),"hide-options":!1,placeholder:`${t.$t("general.comment")}...`,class:"expanded-form-comment-input !py-2 !px-2 cursor-text border-1 rounded-lg w-full bg-transparent !text-nc-content-gray !text-small !leading-18px !max-h-[240px]",autofocus:s(S),"data-testid":"expanded-form-comment-input",onFocus:a[3]||(a[3]=n=>S.value=!1),onKeydown:[ye,ie(de(oe,["exact","prevent"]),["enter"])],onSave:oe},null,8,["value","placeholder","autofocus","onKeydown"])])):E("",!0)]))],2)}}}),lo=Object.assign(vt(ao,[["__scopeId","data-v-49873641"]]),{__name:"SmartsheetExpandedFormSidebarComments"}),yo=Object.freeze(Object.defineProperty({__proto__:null,default:lo},Symbol.toStringTag,{value:"Module"}));export{yo as C,lo as _,Pt as a};
