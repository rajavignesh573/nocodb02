import{as as Ie,J as Qe,n as V,r as _,el as ze,Y as De,d5 as ge,ah as Be,a6 as Ge,V as ke,a8 as Le,f as We,a9 as qe,W as Ue,G as Xe,bX as Ke,ge as ea,aj as J,gT as aa,aG as j,fN as Ye,a4 as H,a5 as W,ie as be,aC as ta,fV as la,gj as ra}from"./DRA9KN5F.js";import{u as sa}from"./DkDj6Z7Z.js";import{b as ua,u as oa}from"./CQa0sIfA.js";import{b as na}from"./C2xdh4Xe.js";import{e as de,r as ia}from"./gAYHr7Gr.js";const ce=(o,f)=>o.map(I=>({row:{...I},oldRow:{...I},rowMeta:{...(f==null?void 0:f(I))??{}}})),[pa,da]=sa((o,f,I=!1,N)=>{if(!o)throw new Error("Table meta is not available");const{isUIAllowed:q}=Ie(),{isMobileMode:Se}=Qe(),{getValidSearchQueryForColumn:Te}=ua(),Q=V(()=>{var e,a;return(a=(e=o.value)==null?void 0:e.columns)==null?void 0:a.find(t=>t.pv)}),v=_(),h=_([]),U=V(()=>{var e,a;return!h.value||!h.value[0]?null:(a=(e=h.value[0])==null?void 0:e.fk_from_col)==null?void 0:a.uidt}),B=V(()=>{var e,a,t;return!h.value||!h.value[0]?ze.tz.guess():((t=(a=(e=h.value[0])==null?void 0:e.fk_from_col)==null?void 0:a.meta)==null?void 0:t.timezone)??ze.tz.guess()}),s=De(ge(Be,B==null?void 0:B.value)),C=De({value:"",field:"",isValidFieldQuery:!0}),te=V(()=>{var a;if(!Q.value||!((a=C.value)!=null&&a.trim())){C.isValidFieldQuery=!0;return}const e=Te(Q.value,C.value.trim(),o.value,{getWhereQueryAs:"object"});if(!e){C.isValidFieldQuery=!1;return}return e}),m=_(s.dayjsTz()),r=_(s.dayjsTz()),b=_(s.dayjsTz()),g=_(s.dayjsTz()),le=_(!1),re=_(!1),$=_(!Se.value),w=_({start:s.dayjsTz(r.value).startOf("week"),end:s.dayjsTz(r.value).startOf("week").add(6,"day")}),ve=25,G=_([]),F=_([]),X=_(!1),se=_([]),O=_(v.value??"allRecords"),{api:K}=Ge(),{isMysql:je}=ke(),{base:p}=Le(ke()),{$api:ue,$e:fe}=We(),{t:ee}=qe(),{addUndo:Re,clone:ye,defineViewScope:He}=Ue(),R=_(I)||Xe(Ke,_(!1)),{sorts:ae,nestedFilters:E,isSyncedTable:Ve,eventBus:Fe}=oa(),{sharedView:Ae,fetchSharedViewData:me,fetchSharedViewActiveDate:xe,fetchSharedCalendarViewData:Me}=ea(),{getEvaluatedRowMetaRowColorInfo:Z}=na(),T=_({}),pe=_({page:1,pageSize:ve}),oe=V(()=>({limit:pe.value.pageSize??ve,where:(N==null?void 0:N.value)??""})),Pe=V(()=>{var e;return je((e=o.value)==null?void 0:e.source_id)?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD HH:mm:ssZ"}),ne=V(()=>{var a;let e=((a=T.value)==null?void 0:a.meta)??{};if(typeof e=="string")try{e=JSON.parse(e)}catch{}return e}),L=V(()=>{let e=[];if(!h.value)return[];if(O.value==="allRecords")e=[];else if(O.value==="withoutDates")h.value.forEach(a=>{const t=a.fk_from_col,l=a.fk_to_col;if(!t)return;const u=[];t&&u.push({fk_column_id:t.id,logical_op:"or",comparison_op:"blank"}),l&&u.push({fk_column_id:l.id,logical_op:"or",comparison_op:"blank"}),e=[...e,...u]}),e=[{is_group:!0,logical_op:"or",children:e}];else if(O.value==="week"||O.value==="month"||O.value==="day"||O.value==="year"||O.value==="selectedDate"||O.value==="selectedHours"){let a=null,t=null,l=null,u=null;switch(O.value){case"day":case"selectedDate":t=r.value.startOf("day"),l=r.value.endOf("day"),a=r.value.subtract(1,"day").endOf("day"),u=r.value.add(1,"day").startOf("day");break;case"week":t=w.value.start.startOf("week"),l=w.value.end.endOf("week"),a=s.timezonize(t.subtract(1,"day")).endOf("day"),u=s.timezonize(l.add(1,"day")).startOf("day");break;case"month":{const i=s.timezonize(g.value.startOf("month")),y=s.timezonize(i.startOf("week")),d=s.timezonize(g.value.endOf("month")).endOf("week");t=y,l=d,a=t.subtract(1,"day").endOf("day"),u=l.add(1,"day").startOf("day");break}case"year":t=r.value.startOf("year"),l=r.value.endOf("year"),a=s.timezonize(t.subtract(1,"day")).endOf("day"),u=l.add(1,"day").startOf("day");break;case"selectedHours":t=s.timezonize((b.value??s.dayjsTz()).startOf("hour")),l=s.timezonize((b.value??s.dayjsTz()).endOf("hour")),a=s.timezonize(t==null?void 0:t.subtract(1,"hour").endOf("hour")),u=s.timezonize(l==null?void 0:l.add(1,"hour").startOf("hour"));break}if(t=s.dayjsTz(t).format("YYYY-MM-DD HH:mm:ssZ"),a=s.dayjsTz(a).format("YYYY-MM-DD HH:mm:ssZ"),u=s.dayjsTz(u).format("YYYY-MM-DD HH:mm:ssZ"),l=s.dayjsTz(l).format("YYYY-MM-DD HH:mm:ssZ"),U.value===J.Date){const i=/^\d{4}-\d{2}-\d{2}/;t=t.match(i)[0],l=l.match(i)[0],u=u.match(i)[0],a=a.match(i)[0]}h.value.forEach(i=>{const y=i.fk_from_col,d=i.fk_to_col;let c=[];y&&d?(c=[{is_group:!0,logical_op:"and",children:[{fk_column_id:y.id,comparison_op:"lt",comparison_sub_op:"exactDate",value:u},{fk_column_id:d.id,comparison_op:"gt",comparison_sub_op:"exactDate",value:a}]},{is_group:!0,logical_op:"or",children:[{fk_column_id:y.id,comparison_op:"gte",comparison_sub_op:"exactDate",value:t},{fk_column_id:y.id,comparison_op:"lte",comparison_sub_op:"exactDate",value:l}]}],e.push({is_group:!0,logical_op:"or",children:c})):y&&(c=[{fk_column_id:y.id,comparison_op:"lt",comparison_sub_op:"exactDate",value:u},{fk_column_id:y.id,comparison_op:"gt",comparison_sub_op:"exactDate",value:a}],e.push({is_group:!0,logical_op:"and",children:c}))})}return Q.value&&aa(te.value)&&(e.length>0?e=[{is_group:!0,logical_op:"and",children:[...e,te.value]}]:e.push(te.value)),e});async function Ee(e={}){var a,t,l,u;if(!((!((a=p==null?void 0:p.value)!=null&&a.id)||!((t=o.value)!=null&&t.id)||!((l=f.value)!=null&&l.id))&&!R.value||!((u=h.value)!=null&&u.length))&&!X.value)try{const i=R.value?await me({...e,sortsArr:ae.value,filtersArr:[...E.value,...L.value],offset:e.offset}):await K.dbViewRow.list("noco",p.value.id,o.value.id,f.value.id,{...e,offset:e.offset,...q("filterSync")?{filterArrJson:JSON.stringify([...L.value])}:{filterArrJson:JSON.stringify([E.value,...L.value])}});F.value=[...F.value,...ce(i.list,Z)]}catch(i){console.log(i)}}const A=async()=>{var u,i,y,d,c,D,k;if(v.value==="month"||!((u=p==null?void 0:p.value)!=null&&u.id)||!((i=o.value)!=null&&i.id)||!((y=f.value)!=null&&y.id)||!((d=h.value)!=null&&d.length))return;let e=null,a=null,t=null,l=null;if(v.value==="week"||v.value==="day"){const n=s.timezonize(m.value.startOf("month"));a=s.timezonize(n.startOf("week")),t=s.timezonize(m.value.endOf("month").endOf("week")),e=a.subtract(1,"day").endOf("day"),l=t.startOf("day")}else if(v.value==="year"){const n=s.timezonize(r.value.startOf("year"));a=s.timezonize(n.startOf("week")),t=s.timezonize(r.value.endOf("year")).endOf("week"),e=a.subtract(1,"day").endOf("day"),l=t.startOf("day")}if(e=s.dayjsTz(e).format("YYYY-MM-DD HH:mm:ssZ"),l=s.dayjsTz(l).format("YYYY-MM-DD HH:mm:ssZ"),a=s.dayjsTz(a).format("YYYY-MM-DD HH:mm:ssZ"),t=s.dayjsTz(t).format("YYYY-MM-DD HH:mm:ssZ"),!(!((c=p==null?void 0:p.value)!=null&&c.id)||!((D=o.value)!=null&&D.id)||!((k=f.value)!=null&&k.id)))try{const n=R.value?await xe({from_date:e,to_date:l,next_date:l,prev_date:e,sortsArr:ae.value,filtersArr:E.value}):await K.dbCalendarViewRowCount.dbCalendarViewRowCount("noco",p.value.id,o.value.id,f.value.id,{...oe.value,from_date:a,to_date:t,next_date:l,prev_date:e});se.value=n.dates.map(z=>s.timezonize(z)),n.count>3e3&&v.value!=="year"&&H.warning("This current date range has more than 3000 records. Some records may not be displayed. To get complete records, contact support")}catch(n){se.value=[],H.error(`${ee("msg.error.fetchingActiveDates")} ${await W(n)}`),console.log(n)}},Je=async e=>{fe("c:calendar:change-calendar-view",e);try{v.value=e,q("calendarViewUpdate")&&await we({meta:{...typeof T.value.meta=="string"?JSON.parse(T.value.meta):T.value.meta,active_view:e}}),v.value==="week"&&(b.value=null)}catch(a){H.error("Error changing calendar view"),console.log(a)}},Ne=V(()=>Ve.value&&h.value.some(e=>{var a;return!!((a=e.fk_from_col)!=null&&a.readonly)}));async function Ce(){var e,a,t,l;if(!(!((e=f==null?void 0:f.value)!=null&&e.id)||!((a=o==null?void 0:o.value)!=null&&a.columns))){re.value=!0;try{const u=R.value?(t=Ae.value)==null?void 0:t.view:await ue.dbView.calendarRead(f.value.id);T.value=u;const i=typeof u.meta=="string"?JSON.parse(u.meta):u.meta;v.value=i==null?void 0:i.active_view,v.value||(v.value="month"),h.value=(l=u==null?void 0:u.calendar_range)==null?void 0:l.map(y=>{var D,k,n,z,M,S,he,Oe;const d=(k=(D=o.value)==null?void 0:D.columns)==null?void 0:k.find(P=>P.id===y.fk_from_column_id),c=y.fk_to_column_id?(z=(n=o.value)==null?void 0:n.columns)==null?void 0:z.find(P=>P.id===y.fk_to_column_id):null;if((d==null?void 0:d.uidt)===J.Formula||(c==null?void 0:c.uidt)===J.Formula){const P=(d==null?void 0:d.uidt)===J.Formula&&((S=(M=d==null?void 0:d.colOptions)==null?void 0:M.parsed_tree)==null?void 0:S.dataType)===be.DATE,Ze=(c==null?void 0:c.uidt)===J.Formula&&((Oe=(he=c==null?void 0:c.colOptions)==null?void 0:he.parsed_tree)==null?void 0:Oe.dataType)===be.DATE;if(!P)return H.error(`Please update the Formula column ${d==null?void 0:d.title} to return a date`),null;if(c&&!Ze)return H.error(`Please update the Formula column ${c==null?void 0:c.title} to return a date`),null}return{id:y==null?void 0:y.id,fk_from_col:d,fk_to_col:c,is_readonly:[d,c].some(P=>ta(P)||la(P))}}).filter(Boolean)}catch(u){H.error(`Error loading calendar meta ${await W(u)}`)}finally{re.value=!1}}}async function x(e=!0){var i,y,d,c,D;if((!((i=p==null?void 0:p.value)!=null&&i.id)||!((y=o.value)!=null&&y.id)||!((d=f.value)!=null&&d.id))&&!(R!=null&&R.value)||!((c=h.value)!=null&&c.length)||v.value==="year")return;let a=null,t=null,l=null,u=null;switch(v.value){case"day":a=r.value.subtract(1,"day").endOf("day"),u=r.value.add(1,"day").startOf("day"),t=r.value.startOf("day"),l=r.value.endOf("day");break;case"week":t=w.value.start.startOf("week"),l=w.value.end.endOf("week"),a=s.timezonize(t.subtract(1,"day")).endOf("day"),u=s.timezonize(l.add(1,"day")).startOf("day"),(D=ne.value)!=null&&D.hide_weekend&&(l=s.timezonize(l.subtract(2,"day")).endOf("day"),u=s.timezonize(u.subtract(2,"day")).startOf("day"));break;case"month":{const k=s.timezonize(g.value.startOf("month")),n=s.timezonize(k.startOf("week")),z=s.timezonize(g.value.endOf("month")).endOf("week");t=n,l=z,a=t.subtract(1,"day").endOf("day"),u=l.add(1,"day").startOf("day");break}}a=s.dayjsTz(a).format("YYYY-MM-DD HH:mm:ssZ"),u=s.dayjsTz(u).format("YYYY-MM-DD HH:mm:ssZ"),t=s.dayjsTz(t).format("YYYY-MM-DD HH:mm:ssZ"),l=s.dayjsTz(l).format("YYYY-MM-DD HH:mm:ssZ");try{e&&(le.value=!0);const k=R.value?await Me({sortsArr:ae.value,prev_date:a,next_date:u,to_date:l,from_date:t,filtersArr:E.value}):await K.dbCalendarViewRow.list("noco",p.value.id,o.value.id,f.value.id,{prev_date:a,next_date:u,to_date:l,from_date:t,include_row_color:!0},{...oe.value,...q("filterSync")?{filterArrJson:[]}:{filterArrJson:JSON.stringify([E.value])},where:(N==null?void 0:N.value)??"",filterArrJson:JSON.stringify([...E.value])});G.value=ce(k.list,Z)}catch(k){H.error(`${ee("msg.error.fetchingCalendarData")} ${await W(k)}`),console.log(k)}finally{le.value=!1}}async function we(e){var t;if(!((t=f==null?void 0:f.value)!=null&&t.id)||!q("viewCreateOrEdit",{skipSourceCheck:!0})||R.value)return;const a={...typeof T.value.meta=="string"?JSON.parse(T.value.meta):T.value.meta,...typeof e.meta=="string"?JSON.parse(e.meta):e.meta};try{await ue.dbView.calendarUpdate(f.value.id,{...e,meta:JSON.stringify(a)}),T.value={...T.value,...e,meta:a}}catch(l){H.error("Error updating changes"),console.log(l)}}function _e(e){var t;const a=ia(e,(t=o==null?void 0:o.value)==null?void 0:t.columns);for(const l of G.value)if(Object.keys(a).every(u=>a[u]===l.row[u]))return l}const $e=async e=>{switch(v.value){case"month":g.value=e==="next"?g.value.add(1,"month"):g.value.subtract(1,"month"),m.value=e==="next"?m.value.add(1,"month"):m.value.subtract(1,"month"),m.value.year()!==r.value.year()&&(m.value=r.value);break;case"year":r.value=e==="next"?r.value.add(1,"year"):r.value.subtract(1,"year"),m.value.year()!==r.value.year()&&(m.value=r.value);break;case"day":r.value=e==="next"?r.value.add(1,"day"):r.value.subtract(1,"day"),b.value=r.value,(m.value.year()!==r.value.year()||m.value.month()!==r.value.month())&&(m.value=r.value);break;case"week":w.value=e==="next"?{start:w.value.start.add(7,"day"),end:w.value.end.add(7,"day")}:{start:w.value.start.subtract(7,"day"),end:w.value.end.subtract(7,"day")},m.value.month()!==w.value.end.month()&&(m.value=w.value.start);break}},Y=async(e=!0)=>{var a,t,l,u;if(!(!((a=p==null?void 0:p.value)!=null&&a.id)||!((t=o.value)!=null&&t.id)||!((l=f.value)!=null&&l.id)||!((u=h.value)!=null&&u.length)))try{e&&(X.value=!0);const i=R.value?await me({sortsArr:ae.value,filtersArr:[...E.value,...L.value]}):await K.dbViewRow.list("noco",p.value.id,o.value.id,f.value.id,{...oe.value,filterArrJson:JSON.stringify([...L.value]),include_row_color:!0});F.value=ce(i.list,Z)}catch(i){H.error(`${ee("msg.error.fetchingCalendarData")} ${await W(i)}`),console.log(i)}finally{X.value=!1}};async function ie(e,a,t=!1){var l,u,i,y;try{const d=de(e.row,(l=o==null?void 0:o.value)==null?void 0:l.columns),c=a.reduce((n,z)=>(n[z]=e.row[z],n),{}),D=await ue.dbViewRow.update(ra,p==null?void 0:p.value.id,(u=o.value)==null?void 0:u.id,(i=f==null?void 0:f.value)==null?void 0:i.id,encodeURIComponent(d),c);t||(Re({redo:{fn:async(n,z)=>{const M=await ie(n,z,!0),S=_e(n.row);S&&Object.assign(S.row,M),Object.assign(S==null?void 0:S.oldRow,M)},args:[ye(e),a]},undo:{fn:async(n,z)=>{const M=await ie({row:n.oldRow,oldRow:n.row,rowMeta:n.rowMeta},z,!0),S=_e(n.row);S&&Object.assign(S.row,M),Object.assign(S.oldRow,M)},args:[ye(e),a]},scope:He({view:f.value})}),Object.assign(e.row,D),Object.assign(e.oldRow,D));const k=de(D,(y=o==null?void 0:o.value)==null?void 0:y.columns);return F.value=F.value.map(n=>{var z;return de(n.row,(z=o==null?void 0:o.value)==null?void 0:z.columns)===k&&(Object.assign(n.row,D),Object.assign(n.oldRow,D)),Object.assign(n.rowMeta,Z(n.row)),n}),await A(),D}catch(d){H.error(`${ee("msg.error.rowUpdateFailed")}: ${await W(d)}`)}}return j(r,async(e,a)=>{v.value==="month"||v.value==="week"?O.value==="selectedDate"&&$.value&&await Y():v.value==="year"?e.year()!==a.year()?await Promise.all([x(),Y(),await A()]):O.value==="selectedDate"&&$.value&&await Y():$.value?await Promise.all([Y(),x()]):await Promise.all([x()]),v.value==="year"&&e.year()!==a.year()&&await A()}),j(b,async()=>{U.value!==J.Date&&$.value&&O.value==="selectedHours"&&await Y()}),j(g,async()=>{v.value==="month"&&await Promise.all([x(),Y(),A()])}),j(w,async()=>{v.value==="week"&&await Promise.all([x(),Y()])}),j(v,async(e,a)=>{a==="week"?(m.value=r.value,g.value=r.value??w.value.start,r.value=r.value??w.value.start,b.value=r.value??w.value.start):a==="month"?(m.value=r.value,b.value=r.value,w.value={start:r.value.startOf("week"),end:r.value.endOf("week")}):a==="day"?(m.value=r.value,b.value=r.value,g.value=r.value,w.value={start:r.value.startOf("week"),end:r.value.endOf("week")}):a==="year"&&(g.value=r.value,b.value=r.value,m.value=r.value,w.value={start:r.value.startOf("week"),end:r.value.endOf("week")}),O.value=v.value??"allRecords",v.value==="year"?await Promise.all([Y(),A()]):await Promise.all([x(),Y(),A()])}),j($,async e=>{e&&await Y()}),j(O,async()=>{fe("a:calendar:sidebar-filter",O.value),await Y()}),j([()=>C.value,()=>{var e;return(e=Q.value)==null?void 0:e.id}],async()=>{await Y()}),j(m,async()=>{v.value!=="year"&&await A()}),j([B,U],([e,a])=>{const t=ge(!0,a===J.Date?null:e);s.dayjsTz=t.dayjsTz,s.timezonize=t.timezonize,m.value=s.timezonize(m.value),r.value=s.timezonize(r.value),b.value=s.timezonize(b.value),g.value=s.timezonize(g.value),w.value={start:r.value.startOf("week"),end:r.value.endOf("week")}}),j(()=>ne.value.hide_weekend,async()=>{v.value==="week"&&await x()}),Fe.on(e=>{[Ye.TRIGGER_RE_RENDER,Ye.ON_ROW_COLOUR_INFO_UPDATE].includes(e)&&(G.value=G.value.map(a=>(Object.assign(a.rowMeta,Z(a.row)),a)),F.value=F.value.map(a=>(Object.assign(a.rowMeta,Z(a.row)),a)))}),{fetchActiveDates:A,formattedSideBarData:F,loadMoreSidebarData:Ee,updateCalendarMeta:we,loadSidebarData:Y,displayField:Q,sideBarFilterOption:O,searchQuery:C,activeDates:se,isCalendarDataLoading:le,isCalendarMetaLoading:re,changeCalendarView:Je,calDataType:U,loadCalendarMeta:Ce,calendarRange:h,loadCalendarData:x,formattedData:G,isSidebarLoading:X,showSideMenu:$,selectedTime:b,calendarMetaData:T,updateRowProperty:ie,activeCalendarView:v,pageDate:m,paginationData:pe,selectedDate:r,selectedMonth:g,selectedDateRange:w,paginateCalendarView:$e,viewMetaProperties:ne,updateFormat:Pe,timezoneDayjs:s,timezone:B,isSyncedFromColumn:Ne}});function wa(){const o=da();if(o==null)throw new Error("Please call `useProvideCalendarViewStore` on the appropriate parent component");return o}export{wa as a,pa as u};
