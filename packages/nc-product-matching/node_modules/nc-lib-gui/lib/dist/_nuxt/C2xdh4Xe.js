import{u as Ce}from"./DkDj6Z7Z.js";import{a8 as pe,am as Ee,n as we,a9 as $e,a6 as Fe,V as Ke,f as Ae,ge as Pe,as as Ie,r as O,G as Ne,bX as Qe,W as Be,fN as de,a4 as F,a5 as N,aF as ve,gC as xe,gj as fe,bb as ze,j5 as Ge}from"./DRA9KN5F.js";import{u as We,b as Je}from"./CQa0sIfA.js";import{r as M,e as k}from"./gAYHr7Gr.js";import{d as Ue}from"./boyBAVNN.js";function qe(){const{activeViewRowColorInfo:t}=pe(Ee()),r=we(()=>{var m;return t.value&&!!((m=t.value)!=null&&m.mode)});return{rowColorInfo:t,evaluateRowColor:m=>null,isRowColouringEnabled:r,getEvaluatedRowMetaRowColorInfo:m=>({is_set_as_background:!1,rowBgColor:null,rowLeftBorderColor:null,rowHoverColor:null,rowBorderColor:null})}}const[Me,Le]=Ce((t,r,ee=!1)=>{if(!t)throw new Error("Table meta is not available");const ae="addNewStack",m="uncategorized",{t:le}=$e(),{api:Q}=Fe(),{base:R}=pe(Ke()),{$e:ge,$api:K}=Ae(),{sorts:G,nestedFilters:W,eventBus:ye}=We(),{sharedView:oe,fetchSharedViewData:Re,fetchSharedViewGroupedData:he}=Pe(),{isUIAllowed:J}=Ie(),D=O(ee)||Ne(Qe,O(!1)),be=O(null),{search:A,getValidSearchQueryForColumn:Oe}=Je(),{addUndo:U,clone:P,defineViewScope:q}=Be(),{getEvaluatedRowMetaRowColorInfo:j}=qe(),L=O([]),H=we(()=>{var l,i,c,d;let e;const n=((i=(l=t.value)==null?void 0:l.columns)==null?void 0:i.find(({id:g})=>g===A.value.field))||((d=(c=t.value)==null?void 0:c.columns)==null?void 0:d.find(g=>g.pv)),o=A.value.query.trim();if(!n||!o)return A.value.isValidFieldQuery=!0,e;const a=Oe(n,o,t.value,{getWhereQueryAs:"string"});return a?(A.value.isValidFieldQuery=!0,a):(A.value.isValidFieldQuery=!1,e)});ze(Ge,be);const E=O({}),$=O([]),u=O(new Map),f=O(new Map),y=O(""),w=O(),h=O({}),te=O(!1),ue=(e,n)=>e.map(o=>({row:{...o},oldRow:{...o},rowMeta:{...(n==null?void 0:n(o))??{}}}));async function Se(){var n,o,a,l,i;if((!((n=R==null?void 0:R.value)!=null&&n.id)||!((o=t.value)!=null&&o.id)||!((a=r==null?void 0:r.value)!=null&&a.id)||!((l=w==null?void 0:w.value)!=null&&l.id))&&!D.value)return;u.value=new Map,f.value=new Map;let e;D.value?e=await he(w.value.id,{sortsArr:G.value,filtersArr:W.value,include_row_color:!0}):e=await Q.dbViewRow.groupedDataList("noco",R.value.id,t.value.id,r.value.id,w.value.id,{where:H.value,include_row_color:!0},{});for(const c of e??[]){const d=typeof c.key=="string"&&(i=c.key)!=null&&i.length?c.key:null;u.value.set(d,ue(c.value.list,j)),f.value.set(d,c.value.pageInfo.totalRows||0)}}const _e=(e,n)=>{const o=(e||[]).reduce((a,l)=>{const i=k(l.row,t.value.columns);return i&&(a[i]=l),a},{});return(n||[]).filter(({row:a})=>{const l=k(a,t.value.columns);return!(l&&o[l])})};async function Ve(e,n={}){var l,i,c;if((!((l=R==null?void 0:R.value)!=null&&l.id)||!((i=t.value)!=null&&i.id)||!((c=r.value)!=null&&c.id))&&!D.value)return;let o=`(${y.value},eq,${e})`;e===null&&(o=`(${y.value},is,blank)`),H.value&&(o=`${o} and ${H.value}`);const a=D.value?await Re({...n,sortsArr:G.value,filtersArr:W.value,offset:n.offset,where:o}):await Q.dbViewRow.list("noco",R.value.id,t.value.id,r.value.id,{...n,...J("sortSync")?{}:{sortArrJson:JSON.stringify(G.value)},...J("filterSync")?{}:{filterArrJson:JSON.stringify(W.value)},where:o});u.value.set(e,[...u.value.get(e),..._e(u.value.get(e),ue(a.list,j))])}async function ke(){var o,a,l,i,c,d,g,b,S;if(!((o=r==null?void 0:r.value)!=null&&o.id)||!((a=t==null?void 0:t.value)!=null&&a.columns))return;E.value=D.value?(l=oe.value)==null?void 0:l.view:await K.dbView.kanbanRead(r.value.id),w.value=D.value?ve((i=oe.value)==null?void 0:i.meta).groupingFieldColumn:t.value.columns.filter(v=>v.id===E.value.fk_grp_col_id)[0]||{},y.value=w.value.title;const{fk_grp_col_id:e,meta:n}=E.value;if(h.value=ve(n)||{},h.value&&e&&h.value[e]){let v=!1,p=!1;for(const s of((c=w.value.colOptions)==null?void 0:c.options)??[]){const C=h.value[e].findIndex(x=>x.id===s.id);if(C!==-1){const{collapsed:x,...z}=h.value[e][C];if(!Ue(z,s)){if(D.value)continue;h.value[e][C]={...h.value[e][C],...s},s.title!==z.title&&(u.value.set(s.title,u.value.get(z.title)),f.value.set(s.title,f.value.get(z.title)),await Z(s.title)),v=!0}}else h.value[e].push({...s,collapsed:!1}),u.value.set(s.title,[]),f.value.set(s.title,0),v=!0,p=!0}const V=(g=(d=w.value)==null?void 0:d.colOptions)==null?void 0:g.options.map(({id:s})=>s),_=h.value[e].filter(({id:s})=>s!==m&&!V.includes(s));for(const s of _){const C=h.value[e].map(x=>x.id).indexOf(s.id);C!==-1&&(h.value[e].splice(C,1),u.value.size&&f.value.size&&u.value.has(s.title)&&(await Z(s.title,!0),u.value.set(null,[...u.value.get(null)||[],...u.value.get(s.title)]),f.value.set(null,(f.value.get(null)||0)+(f.value.get(s.title)||0))),v=!0)}$.value=[...h.value[e]],v&&(await B(),p&&(te.value=!0))}else $.value=[...((S=(b=w.value)==null?void 0:b.colOptions)==null?void 0:S.options)??[],{id:m,title:null,order:0,color:xe.gray[500]}].sort((v,p)=>v.order-p.order).map(v=>({...v,collapsed:!1})),await B()}async function B(){const{fk_grp_col_id:e}=E.value;e&&(h.value[e]=$.value,await ne({meta:h.value}))}async function ne(e){var n;!((n=r==null?void 0:r.value)!=null&&n.id)||!J("viewCreateOrEdit",{skipSourceCheck:!0})||await K.dbView.kanbanUpdate(r.value.id,e)}function X(e){var o;const n=M(e,(o=t==null?void 0:t.value)==null?void 0:o.columns);for(const a of u.value.values())for(const l of a)if(Object.keys(n).every(i=>n[i]===l.row[i]))return l}async function T(e,n=u.value.get(null).length,o=!1){var a,l,i,c,d;try{const g=((a=t==null?void 0:t.value)==null?void 0:a.columns).reduce((S,v)=>((!v.ai||o)&&(e==null?void 0:e[v.title])!==null&&(S[v.title]=e==null?void 0:e[v.title]),S),{}),b=await K.dbViewRow.create(fe,(metaValue==null?void 0:metaValue.base_id)??(R==null?void 0:R.value.id),(l=t.value)==null?void 0:l.id,(i=r==null?void 0:r.value)==null?void 0:i.id,g);if(!o){const S=k(b,(c=t.value)==null?void 0:c.columns);U({redo:{fn:async function(p,V){var s;const _=M(p.row,(s=t.value)==null?void 0:s.columns);p.row={..._,...p.row},Object.assign(p.rowMeta,j(p.row)),await T(p,V,!0),I(p,!0)},args:[P(e),n]},undo:{fn:async function(p){await ce(p);const V=X(b);V&&se(V)},args:[S]},scope:q({view:r.value})})}return(d=u.value.get(null))==null||d.splice(n??0,1,{row:b,rowMeta:{...j(b)},oldRow:{...b}}),b}catch(g){F.error(await N(g))}}async function Y(e,n,o=!1){var a,l,i,c;try{const d=k(e.row,(a=t==null?void 0:t.value)==null?void 0:a.columns),g=await K.dbViewRow.update(fe,((l=t.value)==null?void 0:l.base_id)??(R==null?void 0:R.value.id),(i=t.value)==null?void 0:i.id,(c=r==null?void 0:r.value)==null?void 0:c.id,encodeURIComponent(d),{[n]:e.row[n]});if(!o){const b=L.value.find(v=>v.op==="removed"&&v.pk===d),S=L.value.find(v=>v.op==="added"&&v.pk===d);U({redo:{fn:async function(p,V){const _=await Y(p,V,!0),s=X(p.row);s&&(Object.assign(s.row,_),Object.assign(s.rowMeta,j(_)),s.row[y.value]!==s.oldRow[y.value]&&I(s,!1,S==null?void 0:S.index),Object.assign(s.oldRow,_))},args:[P(e),n]},undo:{fn:async function(p,V){const _=await Y({row:p.oldRow,oldRow:p.row,rowMeta:p.rowMeta},V,!0),s=X(p.row);s&&(Object.assign(s.row,_),Object.assign(s.rowMeta,j(_)),s.row[y.value]!==s.oldRow[y.value]&&I(s,!1,b==null?void 0:b.index),Object.assign(s.oldRow,_))},args:[P(e),n]},scope:q({view:r.value})}),Object.assign(e.row,g),Object.assign(e.oldRow,g),Object.assign(e.rowMeta,j(g))}return g}catch(d){F.error(`${le("msg.error.rowUpdateFailed")} ${await N(d)}`)}}async function me(e){e.rowMeta.new?await T(e.row,u.value.get(e.row.title).indexOf(e)):await Y(e,y.value)}async function Z(e,n=!1){var o;try{const a=n?null:e;await Q.dbTableRow.bulkUpdateAll("noco",R.value.id,(o=t.value)==null?void 0:o.id,{[y.value]:a},{where:`(${y.value},eq,${e})`}),u.value.has(e)&&u.value.set(e,(u.value.get(e)||[]).map(l=>({...l,row:{...l.row,[y.value]:a},oldRow:{...l.oldRow,[y.value]:l.row[y.value]}})))}catch(a){F.error(await N(a))}}async function De(e,n){var o;if(!(!((o=r==null?void 0:r.value)!=null&&o.id)||!w.value))try{await Z(e,!0),u.value.set(null,[...u.value.get(null),...u.value.get(e)]),f.value.set(null,(f.value.get(null)||0)+(f.value.get(e)||0)),u.value.delete(e),f.value.delete(e);const a=w.value.colOptions.options.filter(i=>i.title!==e);w.value.colOptions.options=a;const l=w.value.cdf?w.value.cdf.replace(/^'/,"").replace(/'$/,""):null;await Q.dbTableColumn.update(w.value.id,{...w.value,colOptions:{options:a},cdf:l===e?null:l}),$.value.splice(n,1),h.value[E.value.fk_grp_col_id]=$.value,await B(),ge("a:kanban:delete-stack")}catch(a){F.error(await N(a))}}function je(e=u.value.get(null).length){return u.value.get(null).splice(e,0,{row:{},oldRow:{},rowMeta:{new:!0}}),u.value.get(null)[e]}function I(e,n,o){const a=e.row[y.value],l=e.oldRow[y.value];if(!(!a||l))if(n)a&&(o!==void 0?u.value.get(a).splice(o,0,e):u.value.get(a).push(e),f.value.set(a,f.value.get(a)+1),re());else{const i=k(e.row,t.value.columns),c=u.value.get(l).findIndex(d=>k(d.row,t.value.columns)===i);if(c!==-1)if(a!==l){f.value.set(l,f.value.get(l)-1);const d=u.value.get(l);if(d.splice(c,1),u.value.set(l,d),f.value.set(a,f.value.get(a)+1),o!==void 0){const g=u.value.get(a);g.splice(o,0,e),u.value.set(a,g)}else u.value.set(a,[...u.value.get(a),e])}else{const d=u.value.get(a);o!==void 0?(d.splice(c,1),d.splice(o,0,e)):d[c]=e,u.value.set(l,d)}}}function se(e){const n=k(e.row,t.value.columns),o=e.row[y.value];u.value.set(o,u.value.get(o).filter(a=>k(a.row,t.value.columns)!==n)),f.value.set(o,f.value.get(o)-1)}function re(){D.value||(u.value.get(null).pop(),f.value.set(null,f.value.get(null)-1))}async function ie(e,n=!1){var o;try{if(n||U({redo:{fn:async function(l){await ie(l,!0)},args:[P(e)]},undo:{fn:async function(l){var c;const i=M(l.row,(c=t.value)==null?void 0:c.columns);l.row={...i,...l.row},await T(l.row,void 0,!0),I(l,!0)},args:[P(e)]},scope:q({view:r.value})}),!e.rowMeta.new){const a=k(e.row,(o=t==null?void 0:t.value)==null?void 0:o.columns);if(!await ce(a))return}se(e)}catch(a){F.error(`${le("msg.error.deleteRowFailed")}: ${await N(a)}`)}}async function ce(e){var o,a,l;if(!e)throw new Error("Delete not allowed for table which doesn't have primary Key");const n=await K.dbViewRow.delete("noco",((o=t.value)==null?void 0:o.base_id)??R.value.id,(a=t.value)==null?void 0:a.id,(l=r.value)==null?void 0:l.id,encodeURIComponent(e));return n.message?(F.info(`Record delete failed: ${`Unable to delete record with ID ${e} because of the following:
              
${n.message.join(`
`)}.

              Clear the data first & try again`})}`),!1):!0}return ye.on(e=>{if(![de.TRIGGER_RE_RENDER,de.ON_ROW_COLOUR_INFO_UPDATE].includes(e))return;Array.from(u.value.keys()).forEach(o=>{const a=u.value.get(o)??[];a.length&&(a.forEach(l=>{Object.assign(l.rowMeta,j(l.row))}),u.value.set(o,a))})}),{loadKanbanData:Se,loadMoreKanbanData:Ve,loadKanbanMeta:ke,updateKanbanMeta:ne,kanbanMetaData:E,formattedData:u,countByStack:f,groupingField:y,groupingFieldColOptions:$,groupingFieldColumn:w,updateOrSaveRow:me,addEmptyRow:je,addOrEditStackRow:I,deleteStack:De,updateKanbanStackMeta:B,removeRowFromUncategorizedStack:re,shouldScrollToRight:te,deleteRow:ie,moveHistory:L,addNewStackId:ae,uncategorizedStackId:m}},"kanban-view-store");function ea(){const t=Le();if(t==null)throw new Error("Please call `useProvideKanbanViewStore` on the appropriate parent component");return t}export{ea as a,qe as b,Me as u};
