import{u as N}from"./DkDj6Z7Z.js";import{r as u,a6 as q,a8 as F,V as J,f as U,as as $,G as B,bX as G,ge as X,n as H,S as K,gj as R,a4 as L,a5 as Q}from"./DRA9KN5F.js";import{u as V}from"./CQa0sIfA.js";import{p as W}from"./gAYHr7Gr.js";const Y=o=>o.map(s=>({row:{...s},oldRow:{...s},rowMeta:{}})),[ta,Z]=N((o,s,j=!1,e)=>{if(!o)throw new Error("Table meta is not available");const w=1e3,l=u([]),{api:h}=q(),{base:i}=F(J()),{$api:p}=U(),{isUIAllowed:y}=$(),c=u(j)||B(G,u(!1)),{sorts:_,nestedFilters:b}=V(),{sharedView:A,fetchSharedViewData:C}=X(),f=u({}),D=u(),v=u({page:1,pageSize:w}),E=H(()=>({limit:v.value.pageSize??w,where:(e==null?void 0:e.value)??""}));async function O(){var r,t,n,d;const{count:a}=await p.dbViewRow.count(R,((r=o.value)==null?void 0:r.base_id)??((t=i==null?void 0:i.value)==null?void 0:t.title),(n=o==null?void 0:o.value)==null?void 0:n.id,(d=s==null?void 0:s.value)==null?void 0:d.id);v.value.totalRows=a}async function I(){var a,r,t;!((a=s==null?void 0:s.value)!=null&&a.id)||!((r=o==null?void 0:o.value)!=null&&r.columns)||(f.value=c.value?(t=A.value)==null?void 0:t.view:await p.dbView.mapRead(s.value.id),D.value=o.value.columns.filter(n=>n.id===f.value.fk_geo_data_col_id)[0]||{})}async function P(){var r,t,n;if((!((r=i==null?void 0:i.value)!=null&&r.id)||!((t=o.value)!=null&&t.id)||!((n=s.value)!=null&&n.id))&&!(c!=null&&c.value))return;const a=c.value?await C({sortsArr:_.value,filtersArr:b.value}):await h.dbViewRow.list("noco",i.value.id,o.value.id,s.value.id,{...E.value,...y("filterSync")?{}:{filterArrJson:JSON.stringify(b.value)},where:e==null?void 0:e.value});l.value=Y(a.list)}async function k(a){var r;!((r=s==null?void 0:s.value)!=null&&r.id)||!y("dataEdit",{skipSourceCheck:!0})||await p.dbView.mapUpdate(s.value.id,a)}const{getMeta:z}=K();async function T(a,r={},{metaValue:t=o.value,viewMetaValue:n=s.value}={}){const d=a.row;a.rowMeta&&(a.rowMeta.saving=!0);try{const{missingRequiredColumns:S,insertObj:x}=await W({meta:t,ltarState:r,getMeta:z,row:d});if(S.size)return;const g=await p.dbViewRow.create(R,(t==null?void 0:t.base_id)??(i==null?void 0:i.value.id),t==null?void 0:t.id,n==null?void 0:n.id,x);return Object.assign(a,{row:{...g,...d},rowMeta:{...a.rowMeta||{},new:void 0},oldRow:{...g}}),O(),g}catch(S){L.error(await Q(S))}finally{a.rowMeta&&(a.rowMeta.saving=!1)}}function m(a=l.value.length){return l.value.splice(a,0,{row:{},oldRow:{},rowMeta:{new:!0}}),l.value[a]}return{formattedData:l,loadMapData:P,loadMapMeta:I,updateMapMeta:k,mapMetaData:f,geoDataFieldColumn:D,addEmptyRow:m,insertRow:T,syncCount:O,paginationData:v}});function ra(){const o=Z();if(o==null)throw new Error("Please call `useProvideMapViewStore` on the appropriate parent component");return o}export{ra as a,ta as u};
