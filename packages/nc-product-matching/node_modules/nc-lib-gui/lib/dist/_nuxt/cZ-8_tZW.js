import{_ as Se}from"./Nm9CBPbO.js";import{e as Me,J as Ee,G as c,fO as Le,g6 as Ae,r,kU as Re,kn as $e,ef as Pe,n as g,bX as Fe,k5 as Ke,j9 as Ne,kV as Ve,gy as De,gu as Te,f as Be,as as Ge,V as Ue,Y as oe,aG as ne,bx as qe,gF as ie,a4 as ze,a5 as He,bv as Je,iw as Qe,kk as We,j1 as Xe,gz as Ye,j7 as Ze,g as ea,iU as aa,kW as la,c as D,o as b,I as S,L as a,aF as ta,b as R,w,K as ce,an as sa,aq as oa,eJ as na,O as ia,ag as I,bN as ca,a as x,cf as re,aL as $,ap as ra,t as M,d as ue,b9 as ua,bo as da,j as fa,M as va,Q as pa,es as ma,_ as ga}from"./DRA9KN5F.js";import{g as wa,a as ya}from"./CbSESqy_.js";import{M as ba}from"./GfahIbp6.js";import{u as de}from"./CbX26EBz.js";const ha={key:0,class:"w-full max-w-full"},ka={class:"text-ellipsis overflow-hidden",style:{wordBreak:"keep-all",whiteSpace:"nowrap",display:"inline"}},_a={class:"flex gap-2 text-gray-500 items-center h-full"},Ca={class:"text-xs whitespace-normal"},Ia=Me({__name:"Editor",props:{modelValue:{},rowIndex:{},disableOptionCreation:{type:Boolean},location:{},options:{}},emits:["update:modelValue"],setup(P,{emit:fe}){const ve=fe,{isMobileMode:pe}=Ee(),u=c(Le),E=c(Ae),T=c(Re,r(!1)),B=c($e,r(!1)),h=c(Pe,r(!1)),F=g(()=>B.value||T.value||h.value),G=c(Fe,r(!1)),K=c(Ke,r(!1)),U=c(Ne,r(void 0)),me=c(Ve,r(!1)),_=r(),i=r(!1),q=c(De,null),N=r(!1),L=c(Te,r(!1)),n=r(),{$api:ge}=Be(),{isUIAllowed:z,isMetaReadOnly:H}=Ge(),{isPg:J,isMysql:Q}=Ue(),O=oe([]),W=g(()=>!G.value&&!P.disableOptionCreation&&z("fieldEdit")&&!H.value&&!h.value),v=g(()=>P.options??wa(u.value,K.value,h.value)),A=g(()=>v.value.reduce((e,l)=>(l.title&&(e[l.title.trim()]=l),e),{})),X=g(()=>n.value?!A.value[n.value]:!1),Y=g(()=>z("dataEdit")),p=g(()=>(Y.value||h.value)&&F.value),m=g({get:()=>{let e=[];return e=ya(u.value,A.value,Q,P.modelValue).reduce((l,t)=>{const s=A.value[t==null?void 0:t.trim()];return(s!=null&&s.id||s!=null&&s.title)&&l.push({...s,value:s.value,label:s.title||s.value||""}),l},[]),O.length&&e.push(...O),e},set:e=>{if(W.value&&X.value&&e.length&&e[e.length-1]===n.value)return ye();n.value="",ve("update:modelValue",e.length===0?null:e.join(","))}}),we=g(()=>(m.value||[]).map(e=>e.value));ne(i,(e,l)=>{var t,s,d,k,f,C;e||(n.value=""),p.value&&(e?(C=(f=(k=_.value)==null?void 0:k.$el)==null?void 0:f.querySelector("input"))==null||C.focus():(d=(s=(t=_.value)==null?void 0:t.$el)==null?void 0:s.querySelector("input"))==null||d.blur())}),de(B,e=>{var l;switch(e.key){case"Escape":if(q){q.trigger();return}i.value=!1;break;case"Enter":p.value&&F.value&&!i.value&&(i.value=!0);break;case" ":break;case"ArrowUp":case"ArrowDown":case"ArrowRight":case"ArrowLeft":case"Delete":break;default:if(!p.value){e.preventDefault();break}!(e.metaKey||e.ctrlKey||e.altKey)&&((l=e.key)==null?void 0:l.length)===1&&!qe()&&(e.stopPropagation(),i.value=!0);break}},{immediate:!0,isGridCell:!0}),de(i,e=>{e.key==="Escape"&&(i.value=!1)},{isGridCell:!1});const j=r(0);async function ye(){var e,l;if(!n.value||G.value)return!1;try{const t={label:n.value,title:n.value,value:n.value,color:ie.light[(v.value.length+1)%ie.light.length]};if(O.push(t),n.value="",j.value++,t.value&&!A.value[t.value]){const s=[...v.value];s.push(t),u.value.colOptions={options:s.map(({value:f,...C})=>C)};const d={...u.value};d.cdf&&(J(u.value.source_id)&&(d.cdf=d.cdf.substring(d.cdf.indexOf("'")+1,d.cdf.lastIndexOf("'"))),!Q(u.value.source_id)&&!J(u.value.source_id)&&(d.cdf=d.cdf.replace(/''/g,"'")));const k=await ge.dbTableColumn.update(((e=u.value)==null?void 0:e.fk_column_id)||((l=u.value)==null?void 0:l.id),d);u.value.colOptions=k.columns.find(f=>f.id===u.value.id).colOptions,j.value--,j.value||(O.splice(0,O.length),m.value=[...m.value.map(f=>f.title),t.title])}else j.value--}catch(t){console.log(t),j.value--,ze.error(await He(t))}}const be=()=>{var e,l,t;n.value=(t=(l=(e=_.value)==null?void 0:e.$el)==null?void 0:l.querySelector(".ant-select-selection-search-input"))==null?void 0:t.value},he=(e,l)=>{var t,s;((t=e.target)!=null&&t.classList.contains("ant-tag-close-icon")||(s=e.target)!=null&&s.closest(".ant-tag-close-icon"))&&(e.stopPropagation(),l())},ke=()=>{N.value||(i.value=p.value&&!i.value)};Je(document,"click",e=>{var l;i.value&&_.value&&!_.value.$el.contains(e.target)&&!((l=document.querySelector(".nc-dropdown-multi-select-cell.active"))!=null&&l.contains(e.target))&&(T.value=!1,i.value=!1)},!0);const _e=e=>{if(e.key==="Tab"){i.value=!1;return}else if(e.key==="Escape"&&h.value){i.value=!1;return}e.stopPropagation()},Z=()=>{var e;N.value=!0,setTimeout(()=>{N.value=!1},250),!(me.value&&((e=m.value)!=null&&e.length))&&(i.value=!0)};ne(()=>F.value,e=>{e||(n.value="",i.value=!1)});const Ce=c(Qe,oe({})),Ie=c(We,r(!1)),xe=c(Xe,!1),Oe=c(Ye,r(!1)),je=c(Ze,r(!1));return ea(()=>{!Ie.value&&xe&&!Oe.value&&je.value&&!K.value&&aa(()=>{const e=Ce.keyboardKey;e&&la(e)&&(n.value=e),Z()})}),(e,l)=>{var ee;const t=Se,s=va,d=ra,k=ca,f=na,C=ma;return b(),D("div",{class:I(["nc-cell-field nc-multi-select h-full w-full flex items-center",{"read-only":a(E),"max-w-full":a(h)}]),onClick:ke},[!a(K)&&a(h)&&((ee=("parseProp"in e?e.parseProp:a(ta))(a(u).meta))!=null&&ee.isList)?(b(),D("div",ha,[R(t,{options:a(v),"selected-options":a(we),disabled:a(E)||!a(p),location:e.location,"row-index":e.rowIndex,"onUpdate:selectedOptions":l[0]||(l[0]=o=>m.value=o)},null,8,["options","selected-options","disabled","location","row-index"])])):(b(),S(C,{key:1,ref_key:"aselect",ref:_,value:a(m),"onUpdate:value":l[2]||(l[2]=o=>pa(m)?m.value=o:null),mode:"multiple",class:I(["w-full overflow-hidden",{"caret-transparent":!a(Y)}]),bordered:!1,"clear-icon":"","show-search":!a(pe),"show-arrow":a(p)&&!a(E)&&!a(n),open:a(i)&&a(p),disabled:a(E)||!a(p),"dropdown-class-name":`nc-dropdown-multi-select-cell !min-w-156px ${a(i)?"active":""}`,"search-value":a(n)??"",onSearch:be,onKeydown:_e,onFocus:Z,onBlur:l[3]||(l[3]=o=>i.value=!1)},{suffixIcon:w(()=>[R(s,{icon:"arrowDown",class:"text-gray-700 nc-select-expand-btn"})]),tagRender:w(({value:o,onClose:ae})=>{var le,te;return[a(v).find(y=>y.title===o)?(b(),S(k,{key:0,class:I(["rounded-tag nc-selected-option",{"!my-0":!a(U)||a(U)===1}]),style:{display:"flex",alignItems:"center"},color:(le=a(v).find(y=>y.title===o))==null?void 0:le.color,closable:a(p)&&(a(m).length>1||!((te=a(u))!=null&&te.rqd)),"close-icon":("h"in e?e.h:a(fa))(a(ba),{class:["ms-close-icon"]}),onClick:y=>he(y,ae),onClose:ae},{default:w(()=>{var y,se;return[x("span",{style:re({color:a($).isReadable(((y=a(v).find(V=>V.title===o))==null?void 0:y.color)||"#ccc","#fff",{level:"AA",size:"large"})?"#fff":a($).mostReadable(((se=a(v).find(V=>V.title===o))==null?void 0:se.color)||"#ccc",["#0b1d05","#fff"]).toHex8String()}),class:I({"text-sm":a(L),"text-small":!a(L)})},M(o),7)]}),_:2},1032,["class","color","closable","close-icon","onClick","onClose"])):ce("",!0)]}),default:w(()=>[(b(!0),D(sa,null,oa(a(v),o=>(b(),S(f,{key:o.id||o.title,value:o.title,class:I(["gap-2",`nc-select-option-${a(u).title}-${o.title}`]),"data-testid":`select-option-${a(u).title}-${e.location==="filter"?"filter":e.rowIndex}`,onClick:l[1]||(l[1]=ia(()=>{},["stop"]))},{default:w(()=>[R(k,{class:"rounded-tag max-w-full",color:o.color},{default:w(()=>[x("span",{style:re({color:a($).isReadable(o.color||"#ccc","#fff",{level:"AA",size:"large"})?"#fff":a($).mostReadable(o.color||"#ccc",["#0b1d05","#fff"]).toHex8String()}),class:I({"text-sm":a(L),"text-small":!a(L)})},[R(d,{class:"truncate max-w-full","show-on-truncate-only":""},{title:w(()=>[ue(M(o.title),1)]),default:w(()=>[x("span",ka,M(o.title),1)]),_:2},1024)],6)]),_:2},1032,["color"])]),_:2},1032,["value","data-testid","class"]))),128)),!a(H)&&a(n)&&a(X)&&a(W)?(b(),S(f,{key:a(n),value:a(n)},{default:w(()=>[x("div",_a,[(b(),S(ua(("iconMap"in e?e.iconMap:a(da)).plusThick),{class:"min-w-4"})),x("div",Ca,[ue(M(e.$t("msg.selectOption.createNewOptionNamed"))+" ",1),x("strong",null,M(a(n)),1)])])]),_:1},8,["value"])):ce("",!0)]),_:1},8,["value","show-search","show-arrow","open","disabled","class","dropdown-class-name","search-value"]))],2)}}}),La=Object.assign(ga(Ia,[["__scopeId","data-v-318eaf4b"]]),{__name:"CellMultiSelectEditor"});export{La as default};
