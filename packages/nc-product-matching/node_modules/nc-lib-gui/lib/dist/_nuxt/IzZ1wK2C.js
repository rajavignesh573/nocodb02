import{e as se,f as ne,S as ie,G as N,r as m,bd as re,bc as ce,fO as de,j3 as ue,n as W,T as pe,aG as me,be as _e,g as ve,I as x,o as _,w as d,a as n,d as u,b9 as I,L as t,bo as B,t as r,b as v,ar as fe,Q as U,N as be,ag as ge,c as X,O as xe,j as he,ap as ke,bO as ye,b3 as we,P as Ce,fW as Me,fX as je,fV as $e,aj as Le,gN as Ne,a4 as Ie,_ as Ve}from"./DRA9KN5F.js";import{D as Oe}from"./D7OHpRdS.js";import{g as Te}from"./CG-5KGUk.js";import"./DvtLu3FC.js";import"./BLPDl4Qg.js";import"./CkvAmLZt.js";import"./D_txg4HT.js";import"./CQa0sIfA.js";import"./DkDj6Z7Z.js";import"./By5RWL3d.js";import"./gAYHr7Gr.js";import"./C3FZdmXk.js";import"./JqUqXTOd.js";import"./I4o4wRE2.js";import"./BMPzbwPk.js";import"./CwPFbl3n.js";import"./YbUkeyWR.js";import"./D7poRkS0.js";import"./C5HnjaiI.js";import"./CBhmoxRW.js";import"./DjPyxH1k.js";import"./Bc3_tI4-.js";import"./CsX17Y_h.js";import"./BCBMEREK.js";import"./CJAyvGKH.js";import"./C2UaKEE0.js";import"./C_VN1MCC.js";import"./QeWwuUYP.js";import"./Dv0nYk-Y.js";import"./D43249YX.js";import"./CNwEZGnv.js";import"./DP83Cqnl.js";import"./DlXIlcns.js";import"./BVqTF1QK.js";import"./Ce4xoeky.js";import"./U3gU45AW.js";import"./BYKJ-MHf.js";import"./B94p8ToD.js";import"./Cd4chHHL.js";import"./boyBAVNN.js";import"./BBg0y0zb.js";import"./-iDxnmJF.js";const ze={class:"flex flex-col gap-3"},Ae={class:"text-base text-gray-800 font-semibold"},Be={class:"text-gray-500 text-[13px] leading-5"},Ue={class:"font-semibold"},Fe={class:"flex w-full gap-2 justify-between items-center"},De={class:"flex items-center gap-2"},Ee=["data-testid","onClick"],He={class:"flex flex-row items-center w-full cursor-pointer truncate ml-1 py-[5px] pr-2"},Se={key:1},Ge={class:"flex w-full gap-2 justify-end"},Re=se({__name:"AddLookups",props:{value:{type:Boolean}},setup(J){const K=J,{$api:Y}=ne(),{getMeta:F,metas:D}=ie(),p=N(re,m()),E=N(ce,m()),V=N(de),O=N(ue),H=W(()=>(V==null?void 0:V.value)||(O==null?void 0:O.value)),h=pe(K,"value"),T=m(!1),k=m(""),g=m([]),i=m({}),Z=e=>he($e(e)?Me:je,{columnMeta:e}),S=m(!1),ee=W(()=>{var e;return(e=H.value.colOptions)==null?void 0:e.fk_related_model_id}),s=m(),te=()=>{Object.keys(i.value).forEach(e=>i.value[e]=!1)},oe=()=>{g.value.forEach(e=>i.value[e.id]=!0)},ae=async()=>{var e,a,c,f,C,M,j,$,b,y,o,w,G,R;try{T.value=!0;const L=[],q=((a=(e=p.value)==null?void 0:e.columns)==null?void 0:a.length)??0;for(const[z]of Object.entries(i.value).filter(([,l])=>l)){const l=D.value[(c=s.value)==null?void 0:c.id].columns.find(A=>A.id===z),P=g.value.findIndex(A=>A.id===z),Q={uidt:Le.Lookup,fk_lookup_column_id:z,fk_relation_column_id:H.value.id,lookupTableTitle:(f=s.value)==null?void 0:f.title,lookupColumnTitle:(l==null?void 0:l.title)||l.column_name,table_name:(C=p.value)==null?void 0:C.table_name,title:`${l==null?void 0:l.title} from ${(M=s.value)==null?void 0:M.title}`,view_id:(j=E.value)==null?void 0:j.id,order:q+P,column_name:`${l==null?void 0:l.title} from (${($=s.value)==null?void 0:$.title})`,column_order:{order:q+P,view_id:(b=E.value)==null?void 0:b.id}},le=Ne({formState:Q,metaColumns:(y=s.value)==null?void 0:y.columns,tableExplorerColumns:(o=p.value)==null?void 0:o.columns});L.push({op:"add",column:{...Q,title:le}})}await Y.dbTableColumn.bulk((w=p.value)==null?void 0:w.id,{hash:(G=p.value)==null?void 0:G.columnsHash,ops:L}),await F((R=p==null?void 0:p.value)==null?void 0:R.id,!0),h.value=!1}catch(L){console.error(L),Ie.error("Failed to create lookup columns")}finally{T.value=!1}};return me([s,k],async()=>{var e;if(s.value){const a=((e=D.value[s.value.id])==null?void 0:e.columns)||[];g.value=a.filter(c=>Te({column:c})&&_e([c==null?void 0:c.title],k.value))}}),ve(async()=>{s.value=await F(ee.value)}),(e,a)=>{const c=fe,f=be,C=ke,M=ye,j=we,$=Ce;return _(),x($,{visible:t(h),"onUpdate:visible":a[3]||(a[3]=b=>U(h)?h.value=b:null),size:"small"},{default:d(()=>{var b,y;return[n("div",ze,[n("div",null,[n("h1",Ae,[(_(),x(I(("iconMap"in e?e.iconMap:t(B)).cellLookup),{class:"text-gray-500 pb-1"})),u(" "+r(e.$t("general.addLookupField")),1)]),n("div",Be,[u(r(e.$t("labels.addNewLookupHelperText1"))+" ",1),n("span",Ue,r(((b=t(s))==null?void 0:b.title)??((y=t(s))==null?void 0:y.table_name)),1),u(" "+r(e.$t("labels.addNewLookupHelperText2")),1)])]),n("div",Fe,[v(c,{value:t(k),"onUpdate:value":a[0]||(a[0]=o=>U(k)?k.value=o:null),class:"w-full h-8 flex-1",size:"small",placeholder:e.$t("placeholder.searchFields")},{prefix:d(()=>[(_(),x(I(("iconMap"in e?e.iconMap:t(B)).search),{class:"w-4 text-gray-500 h-4"}))]),_:1},8,["value","placeholder"]),n("div",De,[v(f,{size:"small",type:"text",class:"!text-xs",onClick:te},{default:d(()=>[u(r(e.$t("labels.clearAll")),1)]),_:1}),v(f,{size:"small",type:"text",class:"!text-xs",onClick:oe},{default:d(()=>[u(r(e.$t("general.addAll")),1)]),_:1})])]),n("div",{class:ge([{"flex items-center justify-center":t(S)},"border-1 rounded-md h-[300px] nc-scrollbar-md border-gray-200"])},[t(S)?(_(),X("div",Se,[v(j,{size:"xlarge"})])):(_(),x(t(Oe),{key:0,modelValue:t(g),"onUpdate:modelValue":a[1]||(a[1]=o=>U(g)?g.value=o:null),"item-key":"id","ghost-class":"nc-lookup-menu-items-ghost"},{item:d(({element:o})=>[(_(),X("div",{key:o.id,"data-testid":`nc-lookup-add-menu-${o.title}`,class:"px-3 py-1 flex flex-row items-center rounded-md hover:bg-gray-100",onClick:xe(w=>t(i)[o.id]=!t(i)[o.id],["stop"])},[(_(),x(I(("iconMap"in e?e.iconMap:t(B)).drag),{class:"cursor-move !h-3.75 text-gray-600 mr-1"})),n("div",He,[(_(),x(I(Z(o)),{class:"!w-3.5 !h-3.5 !text-gray-500"})),v(C,{class:"flex-1 pl-1 pr-2 truncate","show-on-truncate-only":""},{title:d(()=>[u(r(o.title),1)]),default:d(()=>[u(r(o.title),1)]),_:2},1024),v(M,{checked:t(i)[o.id],"onUpdate:checked":w=>t(i)[o.id]=w,size:"default"},null,8,["checked","onUpdate:checked"])]),a[4]||(a[4]=n("div",{class:"flex-1"},null,-1))],8,Ee))]),_:1},8,["modelValue"]))],2),n("div",Ge,[v(f,{type:"secondary",size:"small",onClick:a[2]||(a[2]=o=>h.value=!1)},{default:d(()=>[u(r(e.$t("general.cancel")),1)]),_:1}),v(f,{loading:t(T),disabled:!Object.values(t(i)).filter(Boolean).length,size:"small",onClick:ae},{default:d(()=>[u(r(e.$t("general.addLookupField",{count:Object.values(t(i)).filter(Boolean).length||""})),1)]),_:1},8,["loading","disabled"])])])]}),_:1},8,["visible"])}}}),Tt=Object.assign(Ve(Re,[["__scopeId","data-v-9e20cc24"]]),{__name:"SmartsheetHeaderAddLookups"});export{Tt as default};
