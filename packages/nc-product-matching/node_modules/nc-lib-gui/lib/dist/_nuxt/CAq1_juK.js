import{e as D,mP as q,f as K,n as I,aG as P,I as G,o as v,L as n,w as u,a as N,c as A,K as U,ag as T,b as r,t as x,an as J,aq as ee,fW as te,d as O,ap as oe,fV as ne,fX as se,_ as ae,r as le,mQ as H,aL as ie,aj as re,fP as L,ak as de,dt as ce,ao as me,M as ue,by as fe,a1 as pe,Q as _e,$ as ge}from"./DRA9KN5F.js";import{_ as ye}from"./CJAyvGKH.js";import{_ as he,l as ve,d as j,a as we}from"./D187WxNH.js";import{u as X,P as V,a as Z,i as B,b as F,M as be,W as xe,R as W,G as $e,O as ke,c as Te}from"./KAvfy7MV.js";const Ne={class:"capitalize"},Ce={key:0},Ae={key:1,class:"py-1 pr-0.5"},Le={class:"nc-erd-table-node-column flex items-center gap-2"},Oe=D({__name:"TableNode",props:{data:{},showSkeleton:{type:Boolean},dragging:{type:Boolean}},setup(R){const{viewport:z}=X(),_=q(!1,200),{$e:S}=K(),f=t=>t.type==="mm"?t.fk_parent_column_id:t.fk_child_column_id,w=I(()=>R.data.columns.length);return P(()=>z.value.zoom,()=>{_.value=!0}),(t,y)=>{const h=ye,C=te,$=oe,E=se,k=he;return v(),G(k,{class:"h-full flex flex-1 justify-center items-center","modifier-key":t.showSkeleton||n(z).zoom>.35?"Alt":void 0,disabled:t.dragging||n(_)},{title:u(()=>[N("div",Ne,x(t.data.table),1)]),default:u(()=>[N("div",{class:T(["relative h-full max-w-76 flex flex-col justify-center bg-white min-w-16 min-h-8 rounded-lg nc-erd-table-node",[`nc-erd-table-node-${t.data.table}`,t.showSkeleton?"cursor-pointer items-center min-h-200px min-w-300px":""]]),onClick:y[0]||(y[0]=a=>n(S)("c:erd:node-click"))},[N("div",{class:T([[(t.showSkeleton,""),(n(w),"")],"text-gray-800 text-sm py-4 border-b-1 border-gray-200 rounded-t-lg w-full h-full px-3 font-medium flex items-center"])},[r(h,{class:T(["text-primary",{"!text-6xl !w-auto mr-2 !h-18":t.showSkeleton}]),meta:{meta:{}}},null,8,["class"]),N("div",{class:T([t.showSkeleton?"text-6xl":"","flex pr-2 pl-1"])},x(t.data.table),3)],2),t.showSkeleton?(v(),A("div",Ce,[r(n(Z),{style:{left:"-20px"},class:"opacity-0",position:n(V).Left,type:"target",connectable:!1},null,8,["position"]),r(n(Z),{style:{right:"-15px"},class:"opacity-0",position:n(V).Right,type:"source",connectable:!1},null,8,["position"])])):t.data.columns.length?(v(),A("div",Ae,[(v(!0),A(J,null,ee(t.data.columns,(a,Y)=>{var i;return v(),A("div",{key:a.title},[N("div",{class:T(["relative w-full h-full flex items-center min-w-32 py-2 px-1",Y+1===t.data.columns.length?"rounded-b-lg":""])},[a.relationType?(v(),A("div",{key:0,class:T(["flex w-full",`nc-erd-table-node-${t.data.table}-column-${(i=a.title)==null?void 0:i.toLowerCase().replace(" ","_")}`])},[r(n(Z),{id:`s-${f(a.colOptions)}-${t.data.table}`,class:"opacity-0 !right-[-1px]",type:"source",position:n(V).Right,connectable:!1},null,8,["id","position"]),r(n(Z),{id:`d-${f(a.colOptions)}-${t.data.table}`,class:"opacity-0 !left-[-1px]",type:"target",position:n(V).Left,connectable:!1},null,8,["id","position"]),N("div",Le,[r(C,{"column-meta":{uidt:"Links",colOptions:{type:a.relationType}}},null,8,["column-meta"]),r($,{"show-on-truncate-only":"",class:"truncate text-sm"},{title:u(()=>[O(x(a.title),1)]),default:u(()=>[O(" "+x(a.title),1)]),_:2},1024)])],2)):n(ne)(a.type)?(v(),A("div",{key:1,class:T(["nc-erd-table-node-column flex items-center gap-2",`nc-erd-table-node-${t.data.table}-column-${a.title}`])},[r(C,{"column-meta":{uidt:a.type}},null,8,["column-meta"]),r($,{"show-on-truncate-only":"",class:"truncate text-sm"},{title:u(()=>[O(x(a.title),1)]),default:u(()=>[O(" "+x(a.title),1)]),_:2},1024)],2)):(v(),A("div",{key:2,class:T(["nc-erd-table-node-column flex items-center gap-2",`nc-erd-table-node-${t.data.table}-column-${a.title}`])},[r(E,{"column-meta":{uidt:a.type}},null,8,["column-meta"]),r($,{"show-on-truncate-only":"",class:"truncate text-sm"},{title:u(()=>[O(x(a.title),1)]),default:u(()=>[O(" "+x(a.title),1)]),_:2},1024)],2))],2)])}),128))])):U("",!0)],2)]),_:1},8,["modifier-key","disabled"])}}}),ze=Object.assign(ae(Oe,[["__scopeId","data-v-74cf8138"]]),{__name:"AiErdTableNode"});function Se(R,z){const _=le([]),S=ve().domain([0,2]).range([H["royal-blue"].DEFAULT,H.pink[500]]),f=new j.graphlib.Graph;f.setDefaultEdgeLabel(()=>({})),f.setGraph({rankdir:"LR",align:"UL",nodesep:50,ranksep:100});const w=I(()=>n(R)),t=I(()=>n(z)),y=300,h=I(()=>t.value.showViews&&t.value.showAllColumns?50:40),C=I(()=>w.value.relationships.reduce((i,e)=>{const l=e.from,d=e.to,o={source:l,target:d,parentColId:l,childColId:d,modelId:l,type:e.type};return i.push(o),i},[]));function $({type:i,source:e,target:l,childColId:d,parentColId:o}){const c={[L.HAS_MANY]:"has many",[L.MANY_TO_MANY]:"many to many",[L.ONE_TO_ONE]:"one to one"};return[`[${e}] ${d} - ${c[i]} - ${o} [${l}]`,`${e} - ${c[i]} - ${l}`]}function E(){return w.value.tables.reduce((i,e)=>{const l=w.value.relationships.filter(o=>o.from===e.title||o.to===e.title).map(o=>({title:o.from===e.title?o.to:o.from,type:re.Links,relationType:o.to===e.title&&o.type==="hm"?"bt":o.type,colOptions:{type:o.to===e.title&&o.type==="hm"?"bt":o.type,fk_child_column_id:o.from===e.title?o.to:o.from,fk_parent_column_id:o.from===e.title?o.from:o.to}})),d=e.columns.concat(l);return i.push({id:e.title,data:{table:e.title,showAllColumns:t.value.showAllColumns,columns:l,columnLength:d.length,color:""},type:"custom",position:{x:0,y:0}}),i},[])}function k(){return C.value.reduce((i,{source:e,target:l,childColId:d,parentColId:o,type:c,modelId:g})=>{let b,s;(c===L.HAS_MANY||c==="oo")&&(b=d,s=o),c===L.MANY_TO_MANY&&(b=o,s=d);const[p,m]=$({source:e,target:l,type:c,childColId:d,parentColId:o});return i.push({id:`e-${b}-${e}-${s}-${l}-#${p}`,source:`${e}`,target:`${l}`,sourceHandle:`s-${b}-${e}`,targetHandle:`d-${s}-${l}`,type:"custom",markerEnd:{id:"arrow-colored",type:be.ArrowClosed},data:{isManyToMany:c===L.MANY_TO_MANY,isOneToOne:c===L.ONE_TO_ONE,isSelfRelation:e===l&&b===s,label:p,simpleLabel:m,color:""}}),i},[])}const a=(i,e)=>({});return{elements:_,layout:async(i=!1)=>new Promise(e=>{_.value=[...E(),...k()];for(const s of _.value)if(B(s)){const m=s.data.columnLength,M=i?y*3:y,Q=h.value+(i?250:m>0?h.value*m:h.value);f.setNode(s.id,{width:M,height:Q})}else F(s)&&f.setEdge(s.source,s.target);j.layout(f);let l=1/0,d=1/0,o=-1/0,c=-1/0;for(const s of _.value)if(B(s)){const p=f.node(s.id),m=i?y*3:y,M=h.value+(i?250:s.data.columnLength>0?h.value*s.data.columnLength:h.value);l=Math.min(l,p.x-m/2),d=Math.min(d,p.y-M/2),o=Math.max(o,p.x+m/2),c=Math.max(c,p.y+M/2)}const g=-(l+o)/2,b=-(d+c)/2;for(const s of _.value)if(B(s)){const p=S(f.predecessors(s.id).length),m=f.node(s.id);s.targetPosition=V.Left,s.sourcePosition=V.Right,s.position={x:m.x+g,y:m.y+b},s.class=["rounded-lg border-1 border-gray-200 shadow-lg"].join(" "),s.data.color=p,s.style=M=>(M.selected,a())}else if(F(s)){const p=_.value.find(m=>m.id===s.source);if(p){const m=p.data.color;s.data.color=m,s.markerEnd.color=`#${ie(m).toHex()}`}}e()})}}const Ee=D({__name:"Flow",props:{aiBaseSchema:{},config:{}},setup(R){const z=R,{aiBaseSchema:_,config:S}=de(z),{$destroy:f,fitView:w,viewport:t,setMaxZoom:y,onNodeDoubleClick:h,zoomIn:C,zoomOut:$}=X({minZoom:.05,maxZoom:2}),{layout:E,elements:k}=Se(_,S),a=I(()=>t.value.zoom<.15);async function Y(){await E(a.value),await ge(),setTimeout(()=>{w({duration:200,padding:.1,minZoom:t.value.zoom||1,maxZoom:t.value.zoom||1})},100)}function i(e){w({nodes:e?[e]:void 0,duration:200,minZoom:.2})}return h(({node:e})=>{a.value&&i(),setTimeout(()=>{i(e.id)},250)}),P(_,Y,{flush:"post",immediate:!0}),P(a,async e=>{E(e).then(()=>{e&&w({duration:300,padding:.1,minZoom:t.value.zoom,maxZoom:t.value.zoom})})}),P(k,e=>{e.length>3?y(2):y(1.25)}),ce(f),(e,l)=>{const d=ue,o=ze,c=we;return v(),G(n(Te),{modelValue:n(k),"onUpdate:modelValue":l[2]||(l[2]=g=>_e(k)?k.value=g:null),class:"nc-erd-flow"},{"node-custom":u(({data:g,dragging:b})=>[r(o,{data:g,dragging:b,"show-skeleton":n(a)},null,8,["data","dragging","show-skeleton"])]),"edge-custom":u(g=>[r(c,pe(g,{"show-skeleton":n(a)}),null,16,["show-skeleton"])]),default:u(()=>[r(n(xe),{class:"bg-transparent rounded-lg shadow-md border-1 border-gray-200 !right-13 flex items-center",position:n(W).TopRight,"show-fit-view":!1,"show-interactive":!1},{"control-zoom-in":u(()=>[N("div",{class:"nc-erd-zoom-btn rounded-l-lg h-9 !px-2 flex items-center",onClick:l[0]||(l[0]=(...g)=>n(C)&&n(C)(...g))},[r(d,{icon:"plus"})])]),"control-zoom-out":u(()=>[N("div",{class:"nc-erd-zoom-btn border-l-1 border-gray-200 rounded-r-lg h-9 !px-2 flex items-center",onClick:l[1]||(l[1]=(...g)=>n($)&&n($)(...g))},[r(d,{icon:"minus"})])]),_:1},8,["position"]),r(n($e),{size:n(a)?2:void 0,gap:n(a)?50:void 0},null,8,["size","gap"]),r(fe,{name:"layout"},{default:u(()=>[n(a)&&n(S).showAllColumns?(v(),G(n(ke),{key:0,position:n(W).BottomCenter,class:"color-transition z-5 cursor-pointer rounded shadow-sm text-slate-400 font-semibold px-4 py-2 bg-slate-100/50 hover:text-slate-900 hover:ring hover:ring-accent hover:ring-opacity-100 hover:bg-slate-100/90",onClick:i},{default:u(()=>[O(x(e.$t("labels.zoomInToViewColumns")),1)]),_:1},8,["position"])):U("",!0)]),_:1}),me(e.$slots,"default")]),_:3},8,["modelValue"])}}}),Ye=Object.assign(Ee,{__name:"AiErdFlow"});export{Ye as default};
