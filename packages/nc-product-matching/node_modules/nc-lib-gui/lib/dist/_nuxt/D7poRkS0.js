import{r as k,n as g,f as ue,a9 as le,as as ie,a8 as ne,V as te,W as ae,iu as oe,be as E,aC as j,aG as z,jg as re,gD as fe,aF as Q,b1 as de,bb as ce,gg as ve}from"./DRA9KN5F.js";import{u as _e}from"./DkDj6Z7Z.js";const[we,he]=_e((n,c,v,S=!1)=>{const L=k([]),d=k(),q=g(()=>(d.value||[]).reduce((e,s)=>(s.fk_column_id&&(e[s.fk_column_id]=s),e),{})),b=k(""),{$api:p,$e:A}=ue(),{t:R}=le(),{isUIAllowed:U}=ie(),{isSharedBase:I}=ne(te()),B=k(!0),{addUndo:$,defineViewScope:G}=ae(),w=g(()=>S||!U("viewFieldEdit")||I.value),C=k({}),M=e=>{var s,l,i;return((s=n.value)==null?void 0:s.type)===de.MAP&&((i=(l=n.value)==null?void 0:l.view)==null?void 0:i.fk_geo_data_col_id)===e.id},r=g(()=>{var e;return(e=c.value)!=null&&e.columns?c.value.columns.reduce((s,l)=>({...s,[l.id]:l}),{}):{}}),m=k({}),V=async()=>{var s,l,i,o,a;if(!c||!n)return;let e=1;if((s=n.value)!=null&&s.id){const t=(S?(l=c.value)==null?void 0:l.columns:(await p.dbViewColumn.list(n.value.id)).list).reduce((_,f)=>(f.show=!!f.show,{..._,[f.fk_column_id]:f}),{});if(d.value=(o=(i=c.value)==null?void 0:i.columns)==null?void 0:o.filter(_=>!re(_,c.value)).map(_=>{var y;const f=t[_.id]||{};return{title:_.title,fk_column_id:_.id,...f,show:f.show||M(f),order:f.order||e++,aggregation:(f==null?void 0:f.aggregation)??fe.None,system:j((y=r==null?void 0:r.value)==null?void 0:y[f.fk_column_id]),isViewEssentialField:M(_),initialShow:f.show||M(f)||(f==null?void 0:f.group_by)}}).sort((_,f)=>_.order-f.order),w.value&&d.value)for(const _ in C.value){const f=d.value.findIndex(y=>y.fk_column_id===_);f!==void 0&&f>-1&&(d.value[f]=C.value[_],d.value=d.value.sort((y,se)=>y.order-se.order))}const h=(S.value?(a=n.value)==null?void 0:a.columns:d.value)??[];m.value=h.reduce((_,f)=>({..._,[f.fk_column_id]:f}),{})}},O=async(e,s={},l=!1)=>{var i,o,a;(i=c.value)!=null&&i.columns&&(c.value.columns=(c.value.columns||[]).map(u=>(!l&&u.id!==e||l&&u.pv||(u.meta={...Q(u.meta||{}),...s}),u)),!l&&e&&((a=(o=c.value)==null?void 0:o.columnsById)!=null&&a[e])&&(c.value.columnsById[e].meta={...Q(c.value.columnsById[e].meta),...s}),l&&(c.value.columnsById=c.value.columns.reduce((u,t)=>(u[t.id]=t,u),{})))},J=async e=>{var s,l,i,o;if(w.value){const a=(d.value||[]).reduce((u,t)=>(t.fk_column_id&&(t.show=!!t.initialShow,u[t.fk_column_id]=t),u),{});d.value=(s=d.value||[])==null?void 0:s.map(u=>{var h;const t={...u,show:(h=a[u.fk_column_id])==null?void 0:h.show};return C.value[u.fk_column_id]=u,t}),c.value.columns=(l=c.value.columns)==null?void 0:l.map(u=>a[u.id]?{...u,...a[u.id],id:a[u.id].fk_column_id}:u),v==null||v();return}(i=n==null?void 0:n.value)!=null&&i.id&&(e?await p.dbView.showAllColumn(n.value.id,{ignoreIds:e}):await p.dbView.showAllColumn(n.value.id),(o=n.value)!=null&&o.is_default&&O(void 0,{defaultViewColVisibility:!0},!0)),await V(),v==null||v(),A("a:fields:show-all")},K=async e=>{var s,l,i,o;if(w.value){const a=(d.value||[]).reduce((u,t)=>{var h,_;return t.fk_column_id&&(t.show=!!((_=(h=r==null?void 0:r.value)==null?void 0:h[t.fk_column_id])!=null&&_.pv)||!!t.isViewEssentialField,u[t.fk_column_id]=t),u},{});d.value=(s=d.value||[])==null?void 0:s.map(u=>{var h;const t={...u,show:(h=a[u.fk_column_id])==null?void 0:h.show};return C.value[u.fk_column_id]=u,t}),c.value.columns=(l=c.value.columns)==null?void 0:l.map(u=>a[u.id]?{...u,...a[u.id],id:a[u.id].fk_column_id}:u),v==null||v();return}(i=n==null?void 0:n.value)!=null&&i.id&&(e?await p.dbView.hideAllColumn(n.value.id,{ignoreIds:e}):await p.dbView.hideAllColumn(n.value.id),(o=n.value)!=null&&o.is_default&&O(void 0,{defaultViewColVisibility:!1},!0)),await V(),v==null||v(),A("a:fields:show-all")},F=async(e,s,l=!1,i=!1)=>{var o,a,u;if(w.value&&d.value&&(d.value[s]=e,c.value.columns=(o=c.value.columns)==null?void 0:o.map(t=>t.id===e.fk_column_id?{...t,...e,id:e.fk_column_id}:t),C.value[e.fk_column_id]=e),U("viewFieldEdit")){if(e.id&&((a=n==null?void 0:n.value)!=null&&a.id))await p.dbViewColumn.update(n.value.id,e.id,e),i&&O(e.fk_column_id,{defaultViewColOrder:e.order,defaultViewColVisibility:e.show});else if((u=n.value)!=null&&u.id){const t=await p.dbViewColumn.create(n.value.id,e);return d.value&&(d.value[s]=t),t}}l||(await V(),v==null||v({shouldShowLoading:!1}))},x=g({get(){var e;return((e=n.value)==null?void 0:e.show_system_fields)||!1},set(e){var s;(s=n==null?void 0:n.value)!=null&&s.id&&(w.value||p.dbView.update(n.value.id,{show_system_fields:e}).finally(()=>{V(),v==null||v()}),n.value.show_system_fields=e),A("a:fields:system-fields")}}),X=[{searchBasisInfo:R("msg.info.matchedByButtonLabel"),filterCallback:(e,s)=>{var i;if(!s)return!1;const l=s;return oe(l)&&E([(i=l.colOptions)==null?void 0:i.label],e)}},{searchBasisInfo:R("msg.info.matchedByFieldDescription"),filterCallback:(e,s)=>{if(!s)return!1;const l=s;return l.description?E([l.description],e):!1}}],T=k({}),H=e=>{if(!e)return!1;for(const s of X)if(s.filterCallback(b.value,e))return T.value[e.id]=s.searchBasisInfo,!0;return!1},Y=g(()=>(T.value={},(d.value||[]).filter(e=>{var l;if(!e.initialShow&&w.value)return!1;const s=(l=r==null?void 0:r.value)==null?void 0:l[e.fk_column_id];return s!=null&&s.pv?!b.value||E([e.title],b.value)?!0:H(s):!x.value&&j(s)?!1:!b.value||E([e.title],b.value)?!0:H(s)}))),Z=g(()=>{var e,s;return(s=(e=d.value||[])==null?void 0:e.filter(l=>{var i,o,a;return!l.initialShow&&w.value?!1:(o=(i=r==null?void 0:r.value)==null?void 0:i[l.fk_column_id])!=null&&o.pv?!0:!(!x.value&&j((a=r==null?void 0:r.value)==null?void 0:a[l.fk_column_id]))}).filter(l=>!l.show))==null?void 0:s.length}),N=g(()=>{var e,s,l;return((l=(s=(e=d==null?void 0:d.value)==null?void 0:e.filter(i=>{var o,a,u,t,h;return!x.value&&r.value&&((o=r==null?void 0:r.value)!=null&&o[i.fk_column_id])&&j((a=r.value)==null?void 0:a[i.fk_column_id])&&!((t=(u=r.value)==null?void 0:u[i.fk_column_id])!=null&&t.pv)?!1:i.show&&((h=r==null?void 0:r.value)==null?void 0:h[i.fk_column_id])}))==null?void 0:s.sort((i,o)=>i.order-o.order))==null?void 0:l.map(i=>{var o;return(o=r==null?void 0:r.value)==null?void 0:o[i.fk_column_id]}))||[]}),D=(e,s)=>{var i,o;const l=(i=d.value)==null?void 0:i.findIndex(a=>a.fk_column_id===s.fk_column_id);!l&&l!==0||($({undo:{fn:a=>{var u;s.show=!a,F(s,l,!1,!!((u=n.value)!=null&&u.is_default))},args:[e]},redo:{fn:a=>{var u;s.show=a,F(s,l,!1,!!((u=n.value)!=null&&u.is_default))},args:[e]},scope:G({view:n.value})}),F(s,l,!e,!!((o=n.value)!=null&&o.is_default)))},ee=(e,s,l)=>{var o;const i=(o=d.value)==null?void 0:o.findIndex(a=>a.fk_column_id===e.fk_column_id);!i&&i!==0||(e[s]=l,A("a:fields:style",{style:s,status:l}),F(e,i,!0))};z([()=>{var e;return(e=n==null?void 0:n.value)==null?void 0:e.id},()=>{var e;return(e=c.value)==null?void 0:e.columns}],async([e])=>{var s,l;if(e&&((s=n.value)==null?void 0:s.fk_model_id)===((l=c.value)==null?void 0:l.id)){B.value=!0;try{await V()}catch(i){console.error(i)}B.value=!1}},{immediate:!0});const W=k("180px"),P=async(e,s,l=!1)=>{var i,o;if(!l){const a=Object.keys(s).reduce((u,t)=>(m.value[e][t]&&(t==="width"?u[t]=`${W.value}px`:u[t]=m.value[e][t]),u),{});$({redo:{fn:u=>P(e,u,!0),args:[s]},undo:{fn:u=>P(e,u,!0),args:[a]},scope:G({view:n.value})})}try{!S.value&&U("viewFieldEdit")&&((i=m.value[e])!=null&&i.id)&&await p.dbView.gridColumnUpdate(m.value[e].id,{...s}),(o=m.value)!=null&&o[e]?Object.assign(m.value[e],{...m.value[e],...s}):await V()}catch(a){console.error(a)}};return z(N,e=>{L&&(L.value=e||[])},{immediate:!0}),ce(ve,L),{fields:d,fieldsMap:q,loadViewColumns:V,filteredFieldList:Y,searchBasisIdMap:T,numberOfHiddenFields:Z,filterQuery:b,showAll:J,hideAll:K,saveOrUpdate:F,sortedAndFilteredFields:N,showSystemFields:x,metaColumnById:r,toggleFieldVisibility:D,toggleFieldStyles:ee,isViewColumnsLoading:B,updateGridViewColumn:P,gridViewCols:m,resizingColOldWith:W,isLocalMode:w,updateDefaultViewColumnMeta:O}},"useViewColumnsOrThrow");function ke(){const n=he();if(n==null)throw new Error("Please call `useProvideViewColumns` on the appropriate parent component");return n}export{we as a,ke as u};
