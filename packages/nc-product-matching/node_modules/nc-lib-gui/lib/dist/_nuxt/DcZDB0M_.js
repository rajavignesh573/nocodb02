import{b as X}from"./ghxJ1J6L.js";import{e as Y,f as R,V as Z,a8 as ee,a9 as te,r as d,g as ae,ac as se,c as _,o as n,a as l,I as h,ad as E,L as c,w as m,d as p,b9 as V,bo as L,t as y,at as ne,b as v,ag as B,N as oe,K as G,ap as le,ai as z,a4 as A,a5 as ie}from"./DRA9KN5F.js";import{_ as ce}from"./CJAyvGKH.js";import{_ as ue}from"./BhKW-HeQ.js";import{_ as me}from"./BCBMEREK.js";import"./0J_Jm9qQ.js";import"./-iDxnmJF.js";import"./BYKJ-MHf.js";import"./lL-0_K96.js";import"./phJnKPvr.js";import"./CkpISeXq.js";import"./ytmFgNfN.js";const fe={class:"h-full flex flex-col w-full"},re={class:"h-full flex flex-col"},de={class:"flex flex-row justify-between items-center w-full mb-4"},_e={class:"flex"},pe={key:0},ye={class:"flex items-center gap-2"},ve={key:1},ge={class:"flex items-center gap-2 text-gray-600 font-light"},be={key:0,class:"flex flex-col justify-center items-center h-full overflow-y-auto"},he={class:"flex justify-center"},xe={key:0,class:"flex items-center gap-2 max-w-full"},we={class:"min-w-5 flex items-center justify-center"},ke={key:1,class:"flex items-center gap-2 max-w-full"},Se=Y({__name:"Metadata",props:{sourceId:{}},emits:["baseSynced"],setup(F,{emit:O}){const I=F,W=O,{$api:T}=R(),P=Z(),{loadTables:J}=P,{base:x}=ee(P),{t:N}=te(),w=d(),f=d(!1),k=d(!1),S=d(!1),r=d(!1),C=d([]);async function $(e=!1){var a,i,s;try{if(!((a=x.value)!=null&&a.id)||S.value&&!r.value&&!e)return;f.value=!0,k.value=!1,C.value=await T.source.metaDiffGet((i=x.value)==null?void 0:i.id,I.sourceId);for(const o of C.value)((s=o.detectedChanges)==null?void 0:s.length)>0&&(o.syncState=o.detectedChanges.map(u=>u==null?void 0:u.msg).join(", "),k.value=!0)}catch(o){console.error(o)}finally{f.value=!1,e&&(r.value=!0)}}const{$poller:K}=R(),q=()=>{S.value=!1,r.value=!1};async function H(){var e,a;try{if(!((e=x.value)!=null&&e.id)||!k.value)return;f.value=!0,S.value=!0;const i=await T.source.metaDiffSync((a=x.value)==null?void 0:a.id,I.sourceId);K.subscribe({id:i.id},async s=>{var o,u,D,g,M,b;s.status!=="close"&&(s.status===z.COMPLETED?(A.info(N("msg.info.metaDataRecreated")),(o=w.value)==null||o.pushProgress("Done!",s.status),f.value=!1,await J(),await $(!0),W("baseSynced")):s.status===z.FAILED?((g=w.value)==null||g.pushProgress(((D=(u=s.data)==null?void 0:u.error)==null?void 0:D.message)||"Failed to sync base metadata",s.status),r.value=!0,f.value=!1):(b=w.value)==null||b.pushProgress((M=s.data)==null?void 0:M.message))})}catch(i){A.error(await ie(i))}}ae(async()=>{C.value.length===0&&await $()});const Q=[{title:N("labels.models"),key:"table_name",name:"table_name",minWidth:200,padding:"0px 12px"},{title:N("labels.syncState"),dataIndex:"syncState",key:"syncState",minWidth:200,padding:"0px 12px"}],U=e=>({class:`nc-metasync-row nc-metasync-row-${e.table_name}`});return(e,a)=>{const i=ne,s=me,o=X,u=oe,D=ce,g=le,M=ue,b=se("e");return n(),_("div",fe,[l("div",re,[l("div",de,[l("div",_e,[c(k)?(n(),_("div",pe,[E((n(),h(i,{class:"nc-btn-metasync-sync-now",type:"primary",onClick:H},{default:m(()=>[l("div",ye,[(n(),h(V(("iconMap"in e?e.iconMap:c(L)).databaseSync))),p(" "+y(e.$t("activity.metaSync")),1)])]),_:1})),[[b,["a:proj-meta:meta-data:sync"]]])])):(n(),_("div",ve,[l("span",null,[v(s,{message:e.$t("msg.info.tablesMetadataInSync"),type:"success","show-icon":"",class:"!rounded-md"},null,8,["message"])])]))]),E((n(),h(i,{class:"self-start !rounded-md nc-btn-metasync-reload",onClick:a[0]||(a[0]=j=>$())},{default:m(()=>[l("div",ge,[(n(),h(V(("iconMap"in e?e.iconMap:c(L)).reload),{class:B({"animate-infinite animate-spin !text-success":c(f)})},null,8,["class"])),p(" "+y(e.$t("general.reload")),1)])]),_:1})),[[b,["a:proj-meta:meta-data:reload"]]])]),c(S)?(n(),_("div",be,[v(o,{ref_key:"progressRef",ref:w,class:"w-1/2 h-full"},null,512),l("div",he,[v(u,{"html-type":"submit",class:B(["mt-4 mb-8",{"sync-completed":c(r)}]),size:"medium",disabled:!c(r),onClick:q},{default:m(()=>a[1]||(a[1]=[p(" Back ")])),_:1,__:[1]},8,["class","disabled"])])])):(n(),h(M,{key:1,columns:Q,data:c(C)??[],"row-height":"44px","header-row-height":"44px","is-data-loading":c(f),"custom-row":U,class:"nc-metasync-table h-[calc(100%_-_58px)] w-full"},{bodyCell:m(({column:j,record:t})=>[j.key==="table_name"?(n(),_("div",xe,[l("div",we,[v(D,{meta:t,class:"text-gray-500"},null,8,["meta"])]),v(g,{class:"truncate","show-on-truncate-only":""},{title:m(()=>[p(y(t.title||t.table_name),1)]),default:m(()=>[p(" "+y(t.title||t.table_name),1)]),_:2},1024)])):G("",!0),j.key==="syncState"?(n(),_("div",ke,[v(g,{class:"truncate","show-on-truncate-only":""},{title:m(()=>[p(y((t==null?void 0:t.syncState)||e.$t("msg.info.metaNoChange")),1)]),default:m(()=>[l("span",{class:B({"text-red-500":t==null?void 0:t.syncState,"text-gray-500":!(t!=null&&t.syncState)})},y((t==null?void 0:t.syncState)||e.$t("msg.info.metaNoChange")),3)]),_:2},1024)])):G("",!0)]),_:1},8,["data","is-data-loading"]))]),a[2]||(a[2]=l("div",{class:"flex place-content-center item-center"},null,-1))])}}}),Ve=Object.assign(Se,{__name:"DashboardSettingsMetadata"});export{Ve as default};
