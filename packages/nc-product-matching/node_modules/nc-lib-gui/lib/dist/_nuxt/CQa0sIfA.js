import{V as Y,a8 as T,S as Fe,j6 as M,fY as k,gU as Ve,fV as x,aj as U,jc as ge,ie as Qe,jd as we,G as be,r as n,bX as _e,f as je,u as Ae,J as qe,am as Ce,n as a,b7 as B,b1 as f,je as Pe,jf as Re,L as D,aG as z,Y as ke}from"./DRA9KN5F.js";import{u as Ue}from"./DkDj6Z7Z.js";function Te(){const v=Y(),{isMysql:l,isPg:_}=v,{sqlUis:S}=T(v),{metas:j}=Fe(),F={field:"",query:"",isValidFieldQuery:!0},d=M("field-query-search-map",()=>({})),V=M("field-query-search",()=>({...F}));return{search:V,loadFieldQuery:(r,c=!1)=>{r&&((c||!(r in d.value))&&(d.value[r]={...F}),V.value=d.value[r])},getValidSearchQueryForColumn:(r,c,u,h={})=>{if(!k(c))return"";let o=c;try{o=Ve.serializeValue(o,{col:r,isMysql:l,isPg:_,meta:u,metas:j.value,serializeSearchQuery:!0})}catch{x(r)?r.uidt!==U.Formula&&(o=c):(o="",console.log("invalid search query for column",r.title,o))}if(x(r)&&r.uidt!==U.Formula&&!k(o)&&(o=c),!k(o))return"";if(!h.getWhereQueryAs)return o??"";const Q=u!=null&&u.source_id?S.value[u.source_id]:Object.values(S.value)[0];return(r.uidt!==U.Formula||ge(r)!==Qe.NUMERIC)&&!we(r)&&Q&&["text","string"].includes(Q.getAbstractType(r))&&r.dt!=="bigint"?h.getWhereQueryAs==="object"?{fk_column_id:r.id,comparison_op:"like",value:o??""}:`(${r.title},like,%${o}%)`:h.getWhereQueryAs==="object"?{fk_column_id:r.id,comparison_op:"eq",value:o??""}:`(${r.title},eq,${o})`}}}const[Oe,We]=Ue((v,l,_=!1,S,j)=>{const F=be(_e,n(!1)),{$api:d,$eventBus:V}=je(),g=Ae().currentRoute,{user:r,isMobileMode:c}=qe(),{activeView:u,activeNestedFilters:h,activeSorts:o}=T(Ce()),Q=Y(),{sqlUis:A,base:X}=T(Q),H=a(()=>{var e;return(e=l.value)!=null&&e.source_id?A.value[l.value.source_id]:Object.values(A.value)[0]}),{search:y,getValidSearchQueryForColumn:W}=Te(),J=V.smartsheetStoreEventBus,Z=a(()=>{var e,s,t,i;return((e=u.value)==null?void 0:e.lock_type)===B.Personal&&((s=r.value)==null?void 0:s.id)!==((t=u.value)==null?void 0:t.owned_by)||((i=u.value)==null?void 0:i.lock_type)===B.Locked}),I=a(()=>{var e,s;return(s=(e=l.value)==null?void 0:e.columns)==null?void 0:s.some(t=>t.pk)}),$=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.GRID}),E=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.FORM}),N=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.GALLERY}),ee=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.CALENDAR}),se=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.KANBAN}),re=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.MAP}),te=a(()=>E.value&&_),ae=a(()=>{var e;return(e=u.value)==null?void 0:e.is_default}),ue=n(!0),oe=a(()=>{var e,s;return!!((s=(e=X.value)==null?void 0:e.sources)!=null&&s.some(t=>{var i;return t.id===((i=l.value)==null?void 0:i.source_id)&&!t.is_meta&&!t.is_local}))}),le=n(!1),ie=a(()=>{var s,t;return(t=((s=l.value)==null?void 0:s.columns)||[])==null?void 0:t.reduce((i,p)=>(i[p.title]=p,i),{})}),w=a(()=>{if(g.value.query.where)return Pe({api_version:Re.V1},g.value.query.where,ie.value,!1)}),ne=a(()=>{var e,s,t;return(s=(e=w.value)==null?void 0:e.errors)!=null&&s.length?[]:((t=w.value)==null?void 0:t.filters)||[]}),q=a(()=>{var e,s;if(!((s=(e=w.value)==null?void 0:e.errors)!=null&&s.length))return g.value.query.where}),ce=n(0),ve=n(0),de=a(()=>{var e;return((e=y.value.query)==null?void 0:e.trim())&&!c.value&&($.value||N.value)}),ye=a(()=>{var p,O,G,L;let e;q.value&&(e=q.value);const s=((O=(p=l.value)==null?void 0:p.columns)==null?void 0:O.find(({id:R})=>R===y.value.field))||((L=(G=l.value)==null?void 0:G.columns)==null?void 0:L.find(R=>R.pv)),t=y.value.query.trim();if(!s||!t)return y.value.isValidFieldQuery=!0,e;const i=W(s,t,l.value,{getWhereQueryAs:"string"});return i?(y.value.isValidFieldQuery=!0,`${e?`${e}~and`:""}${i}`):(y.value.isValidFieldQuery=!1,e)}),fe=n(!1),he=n(40),me=a(()=>{var e;return((e=l.value)==null?void 0:e.type)==="view"}),pe=a(()=>{var e;return!!((e=l.value)!=null&&e.synced)}),C=n(D(S)??[]),P=n(D(j)??[]),Se=n([]);z(C,()=>{o.value=C.value},{immediate:!0}),z(P,()=>{h.value=P.value},{immediate:!0});const b=ke({}),m=new Map;return{view:u,meta:l,isLocked:Z,$api:d,xWhere:ye,isPkAvail:I,isForm:E,isGrid:$,isGallery:N,isKanban:se,isMap:re,isCalendar:ee,isSharedForm:te,sorts:C,nestedFilters:P,isSqlView:me,eventBus:J,sqlUi:H,allFilters:Se,isDefaultView:ae,actionPaneSize:he,isActionPaneActive:fe,viewColumnsMap:b,getViewColumns:async e=>{if(F.value)return[];if(b[e])return b[e];if(m.has(e))return m.get(e);const s=d.dbViewColumn.list(e).then(t=>(b[e]=t.list,m.delete(e),t.list)).catch(t=>{throw m.delete(e),t});return m.set(e,s),s},isExternalSource:oe,isAlreadyShownUpgradeModal:le,filtersFromUrlParams:w,whereQueryFromUrl:q,validFiltersFromUrlParams:ne,isSyncedTable:pe,totalRowsWithSearchQuery:ce,totalRowsWithoutSearchQuery:ve,fetchTotalRowsWithSearchQuery:de,gridEditEnabled:ue,getValidSearchQueryForColumn:W}},"smartsheet-store");function Ge(){const v=We();if(!v)throw new Error("Please call `useProvideSmartsheetStore` on the appropriate parent component");return v}export{Oe as a,Te as b,Ge as u};
