import{u as Oe,_ as Fe}from"./C5HnjaiI.js";import{e as Me,V as je,a7 as Ge,a8 as Qe,G as Re,eT as ze,n as g,aa as Ke,eU as We,X as se,r as _,a6 as qe,f as Ye,a9 as Je,ch as p,cT as N,eV as Xe,bR as Ze,aG as le,g as He,f8 as ea,e$ as E,c as U,o as f,a as i,b as n,w as l,I as v,K as $,eY as aa,eZ as ta,a0 as oa,a1 as w,L as o,ar as na,bB as sa,an as A,aq as W,eJ as la,ap as ca,d as P,t as h,b9 as ia,bo as ra,Q as q,N as da,M as ua,ag as ce,aS as ma,aA as pa,a4 as ie,a5 as re,f0 as fa,$ as _a,_ as va}from"./DRA9KN5F.js";import{a as ba,b as Sa}from"./DzOdU1_u.js";import{_ as ga}from"./BMufqs0w.js";import{v as ha}from"./C9dUxAef.js";import{g as ya}from"./CN7ac-4_.js";import{C as xa,_ as wa}from"./-iDxnmJF.js";import"./CBhmoxRW.js";import"./DkDj6Z7Z.js";import"./ghxJ1J6L.js";import"./0J_Jm9qQ.js";import"./BYKJ-MHf.js";import"./lL-0_K96.js";import"./phJnKPvr.js";import"./CkpISeXq.js";import"./C_uh0dMc.js";import"./mXY_vhPu.js";import"./QeWwuUYP.js";import"./Ce4xoeky.js";import"./DP83Cqnl.js";import"./CNwEZGnv.js";import"./DlXIlcns.js";import"./BVqTF1QK.js";import"./C_gbauhL.js";import"./BCBMEREK.js";import"./C2UaKEE0.js";import"./C_VN1MCC.js";import"./gByPF8bR.js";import"./Dv0nYk-Y.js";import"./C6valJX6.js";import"./LhVKWcKT.js";import"./BhKW-HeQ.js";import"./ytmFgNfN.js";import"./HY0lXmUV.js";import"./B8gs0dG7.js";import"./CHRPOXXy.js";import"./D7OHpRdS.js";import"./DvtLu3FC.js";import"./CwPFbl3n.js";import"./YbUkeyWR.js";import"./CtCRqrd3.js";import"./boyBAVNN.js";import"./By5RWL3d.js";import"./G4Pt-Lbf.js";import"./BSgyuQBI.js";import"./D8vl_16c.js";import"./BMPzbwPk.js";const ka={class:"edit-source bg-white relative h-full flex flex-col w-full"},Ca={class:"h-full max-h-[calc(100%_-_65px)] flex"},Pa={class:"nc-edit-source-left-panel nc-scrollbar-thin relative"},Ia={class:"h-full max-w-[768px] mx-auto"},Ta={class:"nc-form-section"},Da={class:"nc-form-section-body"},Na=["data-testid"],Ea={class:"nc-form-section"},Ua={class:"nc-form-section-body"},$a={class:"nc-form-section"},Ba={class:"nc-form-section-body"},La={class:"flex flex-col gap-4"},Aa={class:"flex flex-col gap-4"},Va={class:"flex items-center justify-center h-full w-full !bg-white !bg-opacity-85 z-1000"},Oa={class:"nc-edit-source-right-panel"},Fa={class:"p-4 w-full flex items-center justify-between gap-3 border-t-1 border-gray-200"},Ma={class:"flex-1 flex items-center gap-3"},ja={class:"flex-1 flex items-center gap-3 text-[#C86827]"},Ga={class:"flex items-center gap-3"},Qa=Me({__name:"EditBase",props:{sourceId:{}},emits:["sourceUpdated","close"],setup(de,{emit:ue}){const Y=de,J=ue,me=je(),pe=Ge(),{base:k}=Qe(me),{integrations:V,loadIntegrations:fe}=Oe(),O=Re(ze,void 0),_e=g(()=>{var a;return(O==null?void 0:O.value)??((a=k.value)==null?void 0:a.id)}),{refreshCommandPalette:ve}=Ke(),be=g(()=>V.value.filter(a=>a.sub_type!==We.NOCODB)),Se=se.useForm,b=_(!1),F=_(!1),X=_(),{api:M}=qe(),{$e:B}=Ye(),{t:ge}=Je(),he=_(!1),ye=_(!1),Z=_(0),C=_([]),I=_(!1),xe=()=>{Z.value+=1,Z.value>=2&&(ye.value=!0)},e=_(((a=p.MYSQL)=>({title:"",dataSource:{...ya(a)},inflection:{inflectionColumn:"none",inflectionTable:"none"},sslUse:E.No,extraParameters:[],is_schema_readonly:!0,is_data_readonly:!1}))()),y=g(()=>e.value.fk_integration_id&&V.value.find(a=>a.id===e.value.fk_integration_id)),we=g(()=>{var a,t,c;return(c=(t=(a=y.value)==null?void 0:a.config)==null?void 0:t.connection)==null?void 0:c.database}),j=g(()=>{var a,t,c;return(c=(t=(a=y.value)==null?void 0:a.config)==null?void 0:t.searchPath)==null?void 0:c[0]}),H=a=>{if(a==="database")return we.value;if(a==="schema")return j.value},ke=g(()=>({title:[Ze()],extraParameters:[Xe],"dataSource.client":[N()],...e.value.dataSource.client===p.SQLITE?{}:e.value.dataSource.client===p.SNOWFLAKE?{"dataSource.connection.database":[N()],"dataSource.connection.schema":[N()]}:{"dataSource.connection.database":y.value&&H("database")?[]:[N()],...[p.PG].includes(e.value.dataSource.client)&&e.value.dataSource.searchPath?{"dataSource.searchPath.0":y.value&&H("schema")?[]:[N()]}:{}}})),{validate:ee,validateInfos:x}=Se(e,ke),Ce=()=>{if(e.value.dataSource.client!==p.SQLITE){const a=e.value.dataSource.connection;a.ssl?typeof a.ssl=="string"?e.value.sslUse=E.Allowed:e.value.sslUse=E.Preferred:e.value.sslUse=E.No}},ae=["camelize","none"];function te(){const a=Object.fromEntries(new Map(e.value.extraParameters.map(c=>[c.key,c.value]))),t={...e.value.dataSource.connection,...a};return t.ssl=ha(t,e.value.sslUse,e.value.dataSource.client),t}const oe=()=>{var a,t,c,r,u;(u=(r=(c=(t=(a=X.value)==null?void 0:a.$el.querySelector(".ant-form-item-explain-error"))==null?void 0:t.parentNode)==null?void 0:c.parentNode)==null?void 0:r.querySelector("input"))==null||u.focus()},Pe=async()=>{var a,t,c,r,u,d;try{await ee()}catch{oe();return}try{if(!((a=k.value)!=null&&a.id))return;const S=te(),m={...e.value.dataSource,connection:S};m.client===p.SQLITE&&((c=(t=m.connection)==null?void 0:t.connection)!=null&&c.filename)&&(m.connection.filename=m.connection.connection.filename),y.value&&(((r=m.connection)==null?void 0:r.database)===""&&(m.connection.database=void 0),((u=m.searchPath)==null?void 0:u[0])===""&&(m.searchPath=void 0)),await M.source.update((d=k.value)==null?void 0:d.id,Y.sourceId,{alias:e.value.title,type:e.value.dataSource.client,config:m,inflection_column:e.value.inflection.inflectionColumn,inflection_table:e.value.inflection.inflectionTable,is_schema_readonly:e.value.is_schema_readonly,is_data_readonly:e.value.is_data_readonly}),B("a:source:edit:extdb"),await pe.loadProject(_e.value,!0),J("sourceUpdated"),J("close")}catch(S){ie.error(await re(S))}finally{ve()}},T=_(),Ie=async()=>{try{await ee()}catch{oe();return}B("a:source:edit:extdb:test-connection",[]);try{if(F.value=!0,e.value.dataSource.client===p.SQLITE)b.value=!0;else{const a=te();a.database=fa(e.value.dataSource);let t=e.value.dataSource.searchPath;y.value&&((a==null?void 0:a.database)===""&&(a.database=void 0),(t==null?void 0:t[0])===""&&(t=void 0));const c={...e.value.dataSource,connection:a,searchPath:t,fk_integration_id:e.value.fk_integration_id},r=await M.utils.testConnection(c);r.code===0?b.value=!0:(b.value=!1,ie.error(`${ge("msg.error.dbConnectionFailed")} ${r.message}`))}}catch(a){b.value=!1,T.value=await re(a)}F.value=!1};le(()=>e.value.dataSource,()=>{b.value=!1,T.value=null},{deep:!0}),He(async()=>{var a,t,c,r;if(I.value=!0,V.value.length||await fe(ea.Database,(a=k.value)==null?void 0:a.id),(t=k.value)!=null&&t.id){const u=["host","port","user","password","database"],d=await M.source.read((c=k.value)==null?void 0:c.id,Y.sourceId),S=Object.entries(d.config.connection||{}).filter(([m])=>!u.includes(m)).map(([m,D])=>({key:m,value:D}));e.value={title:d.alias||"",dataSource:{connection:{},...d.config||{},searchPath:((r=d.config)==null?void 0:r.searchPath)||[]},inflection:{inflectionColumn:d.inflection_column,inflectionTable:d.inflection_table},extraParameters:S,sslUse:E.No,is_schema_readonly:d.is_schema_readonly,is_data_readonly:d.is_data_readonly,fk_integration_id:d.fk_integration_id},Ce()}I.value=!1}),le(()=>e.value.dataSource.searchPath,a=>{[p.PG].includes(e.value.dataSource.client)&&!a&&(e.value.dataSource.searchPath=[])},{immediate:!0});const G=g({get:()=>!e.value.is_schema_readonly,set:a=>{e.value.is_schema_readonly=!a,a&&(e.value.is_data_readonly=!1),B("c:source:schema-write-toggle",{allowed:!a,edit:!0})}}),Q=g({get:()=>!e.value.is_data_readonly,set:a=>{e.value.is_data_readonly=!a,B("c:source:data-write-toggle",{allowed:!a,edit:!0})}}),Te=a=>{a?(C.value=["1"],De(!0,"nc-source-advanced-options")):C.value=[]};let R;function De(a,t){R&&clearTimeout(R),_a(()=>{const c=document.querySelector(`.edit-source .${t}`);c&&(R=setTimeout(()=>{c.scrollIntoView({block:"center",behavior:"smooth"})},400))})}return(a,t)=>{const c=na,r=oa,u=ta,d=aa,S=Fe,m=ca,D=la,z=sa,Ne=ba,L=ua,K=da,Ee=wa,Ue=xa,$e=se,Be=ma,Le=ga,Ae=Sa,Ve=pa;return f(),U("div",ka,[i("div",Ca,[i("div",Pa,[i("div",Ia,[n($e,{ref_key:"form",ref:X,model:o(e),"hide-required-mark":"",name:"external-base-create-form",layout:"vertical","no-style":"",class:"flex flex-col gap-5.5"},{default:l(()=>[i("div",Ta,[i("div",Da,[n(d,{gutter:24},{default:l(()=>[n(u,{span:12},{default:l(()=>[n(r,w({label:"Data Source Name"},o(x).title),{default:l(()=>[n(c,{value:o(e).title,"onUpdate:value":t[0]||(t[0]=s=>o(e).title=s),class:"nc-extdb-proj-name"},null,8,["value"])]),_:1},16)]),_:1})]),_:1}),n(d,{gutter:24},{default:l(()=>[n(u,{span:12},{default:l(()=>[n(r,{label:"Select connection"},{default:l(()=>[n(z,{value:o(e).fk_integration_id,disabled:"",class:"nc-extdb-db-type nc-select-shadow","dropdown-class-name":"nc-dropdown-ext-db-type",placeholder:"Select connection","allow-clear":"","show-search":"","dropdown-match-select-width":""},{default:l(()=>[(f(!0),U(A,null,W(o(be),s=>(f(),v(D,{key:s.id,value:s.id},{default:l(()=>[i("div",{class:"w-full flex gap-2 items-center","data-testid":s.title},[s!=null&&s.sub_type?(f(),v(S,{key:0,type:s.sub_type,style:{filter:"grayscale(100%) brightness(115%)"}},null,8,["type"])):$("",!0),n(m,{class:"flex-1 truncate","show-on-truncate-only":""},{title:l(()=>[P(h(s.title),1)]),default:l(()=>[P(" "+h(s.title),1)]),_:2},1024),o(e).fk_integration_id===s.id?(f(),v(ia(("iconMap"in a?a.iconMap:o(ra)).check),{key:1,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):$("",!0)],8,Na)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})])]),i("div",Ea,[i("div",Ua,[o(e).dataSource.client===o(p).SQLITE?(f(),U(A,{key:0},[],64)):o(e).dataSource.client===o(p).SNOWFLAKE?(f(),v(d,{key:1,gutter:24},{default:l(()=>[n(u,{span:12},{default:l(()=>[n(r,w({label:a.$t("labels.database")},o(x)["dataSource.connection.database"]),{default:l(()=>[n(c,{value:o(e).dataSource.connection.database,"onUpdate:value":t[1]||(t[1]=s=>o(e).dataSource.connection.database=s),class:"nc-extdb-host-database"},null,8,["value"])]),_:1},16,["label"])]),_:1}),n(u,{span:12},{default:l(()=>[n(r,w({label:"Schema"},o(x)["dataSource.connection.schema"]),{default:l(()=>[n(c,{value:o(e).dataSource.connection.schema,"onUpdate:value":t[2]||(t[2]=s=>o(e).dataSource.connection.schema=s),class:"nc-extdb-host-database"},null,8,["value"])]),_:1},16)]),_:1})]),_:1})):o(e).dataSource.client===o(p).DATABRICKS?(f(),v(d,{key:2,gutter:24},{default:l(()=>[n(u,{span:12},{default:l(()=>[n(r,w({label:"Database"},o(x)["dataSource.connection.database"]),{default:l(()=>[n(c,{value:o(e).dataSource.connection.database,"onUpdate:value":t[3]||(t[3]=s=>o(e).dataSource.connection.database=s),class:"nc-extdb-host-database"},null,8,["value"])]),_:1},16)]),_:1}),n(u,{span:12},{default:l(()=>[n(r,w({label:"Schema"},o(x)["dataSource.connection.schema"]),{default:l(()=>[n(c,{value:o(e).dataSource.connection.schema,"onUpdate:value":t[4]||(t[4]=s=>o(e).dataSource.connection.schema=s),class:"nc-extdb-host-schema"},null,8,["value"])]),_:1},16)]),_:1})]),_:1})):(f(),v(d,{key:3,gutter:24},{default:l(()=>[n(u,{span:12},{default:l(()=>[n(r,w({label:a.$t("labels.database")},o(x)["dataSource.connection.database"]),{default:l(()=>[n(c,{value:o(e).dataSource.connection.database,"onUpdate:value":t[5]||(t[5]=s=>o(e).dataSource.connection.database=s),placeholder:a.$t("labels.dbCreateIfNotExists"),class:"nc-extdb-host-database"},null,8,["value","placeholder"])]),_:1},16,["label"])]),_:1}),n(u,{span:12},{default:l(()=>{var s;return[([o(p).PG].includes(o(e).dataSource.client)||[o(p).PG].includes((s=o(y))==null?void 0:s.sub_type))&&o(e).dataSource.searchPath?(f(),v(r,w({key:0,label:a.$t("labels.schemaName")},o(x)["dataSource.searchPath.0"]),{default:l(()=>[n(c,{value:o(e).dataSource.searchPath[0],"onUpdate:value":t[6]||(t[6]=ne=>o(e).dataSource.searchPath[0]=ne),placeholder:o(j)&&`${o(j)} (default)`},null,8,["value","placeholder"])]),_:1},16,["label"])):$("",!0)]}),_:1})]),_:1}))])]),i("div",$a,[t[14]||(t[14]=i("div",{class:"nc-form-section-title"},"Permissions",-1)),i("div",Ba,[n(Ne,{"allow-meta-write":o(G),"onUpdate:allowMetaWrite":t[7]||(t[7]=s=>q(G)?G.value=s:null),"allow-data-write":o(Q),"onUpdate:allowDataWrite":t[8]||(t[8]=s=>q(Q)?Q.value=s:null)},null,8,["allow-meta-write","allow-data-write"])])]),[o(p).SQLITE,o(p).SNOWFLAKE,o(p).DATABRICKS].includes(o(e).dataSource.client)?$("",!0):(f(),v(Ue,{key:0,"active-key":o(C),"onUpdate:activeKey":t[12]||(t[12]=s=>q(C)?C.value=s:null),ghost:"",class:"nc-source-advanced-options !mt-4"},{expandIcon:l(({isActive:s})=>[n(K,{type:"text",size:"small",class:"!-ml-1.5",onClick:t[9]||(t[9]=ne=>Te(!o(C).length))},{default:l(()=>[t[15]||(t[15]=i("div",{class:"nc-form-section-title"},"Advanced options",-1)),n(L,{icon:"chevronDown",class:ce(["ml-2 flex-none cursor-pointer transform transition-transform duration-500",{"!rotate-180":s}])},null,8,["class"])]),_:2,__:[15]},1024)]),default:l(()=>[n(Ee,{key:"1",collapsible:"disabled"},{header:l(()=>t[16]||(t[16]=[i("span",null,null,-1)])),default:l(()=>[i("div",La,[i("div",Aa,[n(d,{gutter:24},{default:l(()=>[n(u,{span:12},{default:l(()=>[n(r,{label:a.$t("labels.inflection.tableName")},{default:l(()=>[n(z,{value:o(e).inflection.inflectionTable,"onUpdate:value":t[10]||(t[10]=s=>o(e).inflection.inflectionTable=s),class:"nc-select-shadow","dropdown-class-name":"nc-dropdown-inflection-table-name"},{default:l(()=>[(f(),U(A,null,W(ae,s=>n(D,{key:s,value:s},{default:l(()=>[P(h(s),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"])]),_:1}),n(u,{span:12},{default:l(()=>[n(r,{label:a.$t("labels.inflection.columnName")},{default:l(()=>[n(z,{value:o(e).inflection.inflectionColumn,"onUpdate:value":t[11]||(t[11]=s=>o(e).inflection.inflectionColumn=s),class:"nc-select-shadow","dropdown-class-name":"nc-dropdown-inflection-column-name"},{default:l(()=>[(f(),U(A,null,W(ae,s=>n(D,{key:s,value:s},{default:l(()=>[P(h(s),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"])]),_:1})]),_:1})])])]),_:1})]),_:1},8,["active-key"])),t[17]||(t[17]=i("div",null,null,-1))]),_:1,__:[17]},8,["model"])]),n(Le,{"model-value":o(I),inline:"",transition:"",class:"!bg-opacity-15"},{default:l(()=>[i("div",Va,[n(Be,{size:"large"})])]),_:1},8,["model-value"])]),i("div",Oa,[n(Ae),n(Ve)])]),i("div",Fa,[i("div",Ma,[i("div",ja,[n(L,{icon:"alertTriangle",class:"flex-none"}),i("div",null,h(a.$t("msg.warning.dbValid")),1)])]),i("div",Ga,[i("div",{class:"w-[15px] h-[15px] cursor-pointer",onDblclick:xe},null,32),n(m,{disabled:!o(T)},{title:l(()=>[P(h(o(T)),1)]),default:l(()=>[n(K,{type:"secondary",size:"small",class:ce(["nc-extdb-btn-test-connection",{"pointer-events-none":o(b)}]),loading:o(F),disabled:o(I),"icon-position":"right",onClick:t[13]||(t[13]=s=>Ie())},{icon:l(()=>[o(b)?(f(),v(L,{key:0,icon:"circleCheckSolid",class:"!text-green-700 w-4 h-4"})):o(T)?(f(),v(L,{key:1,icon:"alertTriangleSolid",class:"!text-red-700 w-4 h-4"})):$("",!0)]),default:l(()=>[i("span",null,h(o(b)?"Test successful":"Test connection"),1)]),_:1},8,["class","loading","disabled"])]),_:1},8,["disabled"]),n(K,{size:"small",type:"primary",disabled:!o(b)||o(I),loading:o(he),class:"nc-extdb-btn-submit",onClick:Pe},{default:l(()=>[P(h(a.$t("general.submit")),1)]),_:1},8,["disabled","loading"])])])])}}}),Ot=Object.assign(va(Qa,[["__scopeId","data-v-2a300547"]]),{__name:"DashboardSettingsDataSourcesEditBase"});export{Ot as default};
