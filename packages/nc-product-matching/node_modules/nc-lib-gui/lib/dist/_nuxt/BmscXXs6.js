var Me=Object.defineProperty;var Oe=(i,o,d)=>o in i?Me(i,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):i[o]=d;var ue=(i,o,d)=>Oe(i,typeof o!="symbol"?o+"":o,d);import{aj as l,eO as fe,aF as me,jh as $e,hy as ye,ix as I,ji as he,dk as Re,a6 as Ne,f as je,J as Ce,a8 as xe,V as Je,ge as Ve,S as ze,G as ve,r as j,j5 as Ee,n as C,as as Pe,dM as Ue,fL as Fe,iX as Ke,gF as qe,aG as Qe,$ as He,gD as E,a4 as Q,a5 as H}from"./DRA9KN5F.js";import{u as Xe}from"./DkDj6Z7Z.js";import{u as Ye}from"./D7poRkS0.js";import{u as Ze}from"./CQa0sIfA.js";import{e as ge}from"./gAYHr7Gr.js";const P=(i,o,d)=>o.uidt===l.Checkbox?i?I.TRUE:I.FALSE:[l.User,l.CreatedBy,l.LastModifiedBy].includes(o.uidt)&&!i?I.NULL:o.uidt===l.LinkToAnotherRecord&&d&&i&&typeof i=="object"?i[d]??I.NULL:(i&&typeof i=="object"&&(i=JSON.stringify(i)),i??I.NULL),We=(i,o,d)=>{var v,B;if(o)switch(o.uidt){case l.MultiSelect:{const k=(i==null?void 0:i.split(","))||[],g=[];for(const T of k){const S=(v=o.colOptions.options)==null?void 0:v.find(p=>p.title===T);S&&g.push(S.color)}return g.join(",")}case l.SingleSelect:{const k=(B=o.colOptions.options)==null?void 0:B.find(g=>g.title===i);return k?k.color||d():"gray"}case l.Checkbox:return i==="__nc_true__"?he.success:he.error;default:return i?d():"gray"}return i?d():"gray"},rt=i=>[l.Lookup,l.Attachment,l.Barcode,l.QrCode,l.Links,l.User,l.DateTime,l.CreatedTime,l.LastModifiedTime,l.CreatedBy,l.LongText,l.LastModifiedBy].includes(typeof i=="object"?i==null?void 0:i.uidt:i),ct=i=>{var d,v,B,k,g,T,S,p,M;let o=((i==null?void 0:i.key)??(i==null?void 0:i.value)).toString();if(o&&((d=i.column)==null?void 0:d.uidt)===l.Lookup||((v=i.column)==null?void 0:v.uidt)===l.LinkToAnotherRecord)try{o=JSON.parse(o)}catch{return o.split("___")}if(o&&((B=i.column)==null?void 0:B.uidt)===l.DateTime)return[fe(o,`${((g=me((k=i.column)==null?void 0:k.meta))==null?void 0:g.date_format)??$e[0]} ${((S=me((T=i.column)==null?void 0:T.meta))==null?void 0:S.time_format)??ye[0]}`)];if(o&&((p=i.column)==null?void 0:p.uidt)===l.Time)return[fe(o,ye[0],!1)];if(o&&[l.User,l.CreatedBy,l.LastModifiedBy].includes((M=i.column)==null?void 0:M.uidt))try{return[JSON.parse(o)]}catch{return null}return[o]};class pe{constructor(){ue(this,"aliasMap",new Map)}generateAlias(o){const d=Math.random().toString(36).substring(2,15);return this.aliasMap.set(d,o),d}getAlias(o){return this.aliasMap.get(o)}clear(){this.aliasMap.clear()}async process(o,d){for(const[v,B]of Object.entries(o)){const k=this.getAlias(v);k!==void 0&&await d(k,B)}}}const et=[l.Attachment,l.QrCode,l.Barcode,l.Button],[dt,tt]=Xe((i,o,d,v=!1)=>{const k=Re(),{api:g}=Ne(),{$api:T}=je(),{appInfo:S}=Ce(),{base:p}=xe(Je()),{sharedView:M,fetchSharedViewData:X,fetchBulkAggregatedData:Y}=Ve(),{gridViewCols:U}=Ye(),{getMeta:F}=ze(),ke=ve(Ee,j(null)),y=C(()=>{const t=[];return Object.values(U.value).forEach(e=>{var n,s;if(e.group_by){const c=(s=(n=o==null?void 0:o.value)==null?void 0:n.columns)==null?void 0:s.find(u=>u.id===e.fk_column_id);c&&t.push({column:c,sort:e.group_by_sort||"asc",order:e.group_by_order||1})}}),t.sort((e,n)=>(e.order??1/0)-(n.order??1/0)),t}),_e=C(()=>!!y.value.length),{isUIAllowed:b}=Pe(),{sorts:x,nestedFilters:G}=Ze(),K=ve(Fe,Ue()),D=C(()=>{var t;return((t=S.value.defaultGroupByLimit)==null?void 0:t.limitGroup)||25}),O=C(()=>{var t;return((t=S.value.defaultGroupByLimit)==null?void 0:t.limitRecord)||10}),Z=j([]),we=C(()=>{var t;return k(((t=o==null?void 0:o.value)==null?void 0:t.columns)||[]).map(e=>(e.uidt===l.Lookup&&e.id&&Z.value.includes(e.id)||et.includes(e.uidt)?(e.ncItemDisabled=!0,e.ncItemTooltip=`This Field of type ${Ke[e.uidt]} not supported for grouping`):(e.ncItemDisabled=!1,e.ncItemTooltip=""),e))}),_=j({key:"root",color:"root",count:0,column:{},nestedIn:[],aggregations:{},paginationData:{page:1,pageSize:D.value},nested:!0,children:[],root:!0});async function W(t,e){e=e||_.value,e&&(e.paginationData.page=t,await te({offset:(t-1)*(e.paginationData.pageSize||D.value)},e))}const Se=t=>t.map(e=>({row:{...e},oldRow:{...e},rowMeta:{}})),$=j(qe.light),J=j($.value[0]),De=()=>{const t=J.value,e=$.value.indexOf(J.value);return e===$.value.length-1?J.value=$.value[0]:J.value=$.value[e+1],t},V=(t,e="")=>t.reduce((n,s)=>{if(s.key===I.NULL)n+=`${n.length?"~and":""}(${s.title},gb_null)`;else if(s.column_uidt===l.Checkbox)n+=`${n.length?"~and":""}(${s.title},${s.key===I.TRUE?"checked":"notchecked"})`;else if([l.Date,l.DateTime,l.CreatedTime,l.LastModifiedTime].includes(s.column_uidt))n+=`${n.length?"~and":""}(${s.title},gb_eq,exactDate,${s.key})`;else if([l.User,l.CreatedBy,l.LastModifiedBy].includes(s.column_uidt))try{const c=JSON.parse(s.key);n+=`${n.length?"~and":""}(${s.title},gb_eq,${(Array.isArray(c)?c:[c]).map(u=>u.id).join(",")})`}catch(c){console.error(c)}else n+=`${n.length?"~and":""}(${s.title},gb_eq,${s.key})`;return n},e),ee=t=>{if(t==="asc")return"+";if(t==="desc")return"-";if(t==="count-asc")return"~+";if(t==="count-desc")return"~-"},Ae=async(t,e)=>{var u;e=e||_.value;const n=y.value[e.nestedIn.length];if(!n)return e;const s=t.list.reduce((a,r)=>{const f=a.find(w=>w.key===P(r[n.column.column_name]??r[n.column.title],n.column));return f?(f.count+=+r.count,f.paginationData={page:1,pageSize:e.paginationData.pageSize||D.value,totalRows:f.count},a):(n.column.title&&n.column.uidt&&a.push({key:P(r[n.column.title],n.column),column:n.column,count:+r.count,color:We(r[n.column.title],n.column,De),nestedIn:[...e.nestedIn,{title:n.column.title,column_name:n.column.title,key:P(r[n.column.title],n.column),column_uidt:n.column.uidt,column_id:n.column.id}],aggregations:r.aggregations??{},paginationData:{page:1,pageSize:e.nestedIn.length<y.value.length-1?e.paginationData.pageSize||D.value:O.value,totalRows:+r.count},nested:e.nestedIn.length<y.value.length-1}),a)},[]);e.children||(e.children=[]);for(const a of s){const r=(u=e.children)==null?void 0:u.find(f=>f.key===a.key);if(r){a.paginationData={page:r.paginationData.page||a.paginationData.page,pageSize:r.paginationData.pageSize||a.paginationData.pageSize,totalRows:a.count},Object.assign(r,a);continue}e.children.push(a)}e.children=e.children.filter(a=>s.find(r=>r.key===a.key)),e.count<=(e.paginationData.pageSize??D.value)&&e.children.sort((a,r)=>{const f=s.findIndex(m=>m.key===a.key),w=s.findIndex(m=>m.key===r.key);return f-w}),e.paginationData=t.pageInfo;const c=Math.max(1,Math.ceil(e.paginationData.totalRows/e.paginationData.pageSize));return c<e.paginationData.page&&await W(c,e),e};async function te(t={},e,n){var s,c,u,a,r,f,w,m;try{if(e=e||_.value,!((s=p==null?void 0:p.value)!=null&&s.id)||!((c=i.value)!=null&&c.id)||!((u=i.value)!=null&&u.fk_model_id)||!e)return;if(y.value.length===0){e.children=[];return}if(e.nestedIn.length>y.value.length)return;const h=y.value[e.nestedIn.length],R=V(e.nestedIn,d==null?void 0:d.value);if(!h||!h.column.title||v&&!((a=M.value)!=null&&a.uuid))return;if(h.column.uidt===l.LinkToAnotherRecord){const L=await F(h.column.colOptions.fk_related_model_id);if(!L)return;e.displayValueProp=((w=((r=L.columns)==null?void 0:r.find(N=>N.pv))||((f=L.columns)==null?void 0:f[0]))==null?void 0:w.title)||""}const q=v?await g.public.dataGroupBy(M.value.uuid,{offset:((e.paginationData.page??0)-1)*D.value,limit:D.value,...t,where:R,sort:`${ee(h.sort)}${h.column.title}`,column_name:h.column.title,sortsArr:x.value,filtersArr:G.value},{headers:{"xc-password":ke.value}}):await g.dbViewRow.groupBy("noco",p.value.id,i.value.fk_model_id,i.value.id,{offset:((e.paginationData.page??0)-1)*D.value,limit:D.value,...t,...b("sortSync")?{}:{sortArrJson:JSON.stringify(x.value)},...b("filterSync")?{}:{filterArrJson:JSON.stringify(G.value)},where:`${R}`,sort:`${ee(h.sort)}${h.column.title}`,column_name:h.column.title});if(e=await Ae(q,e),S.value.ee&&((m=e==null?void 0:e.children)!=null&&m.length)){const L=new pe,N=Object.values(U.value).map(A=>({field:A.fk_column_id,type:A.aggregation??E.None})).filter(A=>A.type!==E.None),re=(e.children??[]).map(A=>({where:V(A.nestedIn,d==null?void 0:d.value),alias:L.generateAlias(A.key),...b("filterSync")?{}:{filterArrJson:JSON.stringify(G.value)}}));let ce={};N.length&&(ce=v?await Y({aggregation:N},re):await g.dbDataTableBulkAggregate.dbDataTableBulkAggregate(o.value.id,{viewId:i.value.id,aggregation:N},re),await L.process(ce,(A,Ge)=>{const de=((e==null?void 0:e.children)??[]).find(Le=>Le.key.toString()===A.toString());de&&Object.assign(de.aggregations,Ge)}))}}catch(h){console.log(h),Q.error(await H(h))}}async function ne(t,e=!1,n={}){var s,c,u;try{if(!((s=p==null?void 0:p.value)!=null&&s.id)||!((c=i.value)!=null&&c.id)||!((u=i.value)!=null&&u.fk_model_id)||t.children&&!e)return;t.paginationData||(t.paginationData={page:1,pageSize:O.value});const a=V(t.nestedIn,d==null?void 0:d.value),r={offset:((t.paginationData.page??0)-1)*(t.paginationData.pageSize??O.value),limit:t.paginationData.pageSize??O.value,where:`${a}`},f=v?await X({sortsArr:x.value,filtersArr:G.value,...r},{isGroupBy:!0}):await g.dbViewRow.list("noco",p.value.id,i.value.fk_model_id,i.value.id,{...r,...n,...b("sortSync")?{}:{sortArrJson:JSON.stringify(x.value)},...b("filterSync")?{}:{filterArrJson:JSON.stringify(G.value)}});t.count=f.pageInfo.totalRows??0,t.rows=Se(f.list),await Te(t.rows),t.paginationData=f.pageInfo}catch(a){Q.error(await H(a))}}async function Be(t,e){var n,s,c,u;try{if(!((n=o==null?void 0:o.value)!=null&&n.id)||!((s=i.value)!=null&&s.id)||!((c=i.value)!=null&&c.fk_model_id)||!S.value.ee)return;let a=e;if(e||(a=Object.values(U.value).map(m=>({field:m.fk_column_id,type:m.aggregation??E.None}))),a=a==null?void 0:a.filter(m=>m.type!==E.None),a&&!(a!=null&&a.length)||!((u=t.children)!=null&&u.length))return;const r=new pe,f=(t.children??[]).map(m=>({where:V(m.nestedIn,d==null?void 0:d.value),alias:r.generateAlias(m.key),...b("filterSync")?{}:{filterArrJson:JSON.stringify(G.value)}})),w=v?await Y({...a?{aggregation:a}:{}},f):await g.dbDataTableBulkAggregate.dbDataTableBulkAggregate(o.value.id,{viewId:i.value.id,...a?{aggregation:a}:{}},f);await r.process(w,(m,h)=>{const R=(t.children??[]).find(q=>q.key.toString()===m.toString());R&&Object.assign(R.aggregations,h)})}catch(a){Q.error(await H(a))}}const be=async(t,e)=>{t.paginationData||(t.paginationData={page:1,pageSize:O.value}),t.paginationData.page=e,await ne(t,!0)},ae=(t,e=0)=>{if(t=t||_.value,!!t&&(e<y.value.length?t.nested=!0:t.nested=!1,t.nested?t!=null&&t.rows&&(t.rows=[]):t!=null&&t.children&&(t.children=[]),!(e>y.value.length)))for(const n of t.children||[])ae(n,e+1)};Qe(()=>y.value.length,async()=>{y.value.length&&(_.value.paginationData={page:1,pageSize:D.value},_.value.column={},ae(),He(()=>K==null?void 0:K.trigger()))});const ie=(t,e,n=0)=>{var c;if(e=e||_.value,n>=t.length)return e;const s=(c=e.children)==null?void 0:c.find(u=>u.key===t[n].key);return s?s.nested?ie(t,s,n+1):s:e},se=t=>ie(t.nestedIn.slice(0,-1)),z=(t,e)=>{var n;if(t){if(t.count+=e,t.count===0){const s=se(t);s&&(s.children=(n=s.children)==null?void 0:n.filter(c=>c.key!==t.key))}t.root||z(se(t),e)}},oe=(t,e,n=0)=>{var s;if(e=e||_.value,e.nested){const c=(s=e.children)==null?void 0:s.find(u=>{if(y.value[n].column.title)return u.key===P(t.row[y.value[n].column.title],y.value[n].column,e.displayValueProp)});return c?oe(t,c,n+1):{found:!1,group:e}}return{found:!0,group:e}},le=t=>{var e;t=t||_.value,t&&(!t.nested&&t.rows?t.rows.forEach(n=>{var c,u,a,r;const s=oe(n);s.found?s.group!==t&&(s.group&&((c=s.group.rows)==null||c.push(n),z(s.group,1)),t&&((u=t.rows)==null||u.splice(t.rows.indexOf(n),1),z(t,-1))):t?((a=t.rows)==null||a.splice(t.rows.indexOf(n),1),z(t,-1)):(r=_.value.rows)==null||r.splice(_.value.rows.indexOf(n),1)}):(e=t.children)==null||e.forEach(n=>le(n)))},Ie=async()=>{var e,n,s,c;const t=[];try{for(const u of((e=o==null?void 0:o.value)==null?void 0:e.columns)||[]){if(u.uidt!==l.Lookup)continue;let a=u;for(;a&&a.uidt===l.Lookup;){const r=(s=(n=await F(a.fk_model_id))==null?void 0:n.columns)==null?void 0:s.find(w=>w.id===(a==null?void 0:a.colOptions).fk_relation_column_id);if(!(r!=null&&r.colOptions))break;const f=await F((r==null?void 0:r.colOptions).fk_related_model_id);if(a=(c=f==null?void 0:f.columns)==null?void 0:c.find(w=>w.id===(a==null?void 0:a.colOptions).fk_lookup_column_id),(a==null?void 0:a.id)===u.id)break}((a==null?void 0:a.uidt)===l.Attachment||!a)&&u.id&&t.push(u.id)}Z.value=t}catch(u){console.error(u)}};async function Te(t){if(!b("commentCount")||v.value)return;const e=t.filter(({rowMeta:{new:n}})=>!n).map(({row:n})=>{var s;return ge(n,(s=o==null?void 0:o.value)==null?void 0:s.columns)}).filter(Boolean);if(e.length)try{const n=await T.utils.commentCount({ids:e,fk_model_id:o.value.id});t.forEach(s=>{var a,r;const c=ge(s.row,(a=o.value)==null?void 0:a.columns),u=((r=n==null?void 0:n.find(f=>f.row_id===c))==null?void 0:r.count)||0;s.rowMeta=s.rowMeta??{},s.rowMeta.commentCount=+u})}catch(n){console.error("Failed to load aggregate comment count:",n)}}return{rootGroup:_,groupBy:y,isGroupBy:_e,fieldsToGroupBy:we,groupByLimit:3,loadGroups:te,loadGroupData:ne,loadGroupPage:be,loadGroupAggregation:Be,groupWrapperChangePage:W,redistributeRows:le,loadDisallowedLookups:Ie}},"useViewGroupBy");function ut(){const i=tt();if(i==null)throw new Error("Please call `useProvideViewGroupBy` on the appropriate parent component");return i}export{pe as A,ut as a,We as f,ct as p,rt as s,dt as u,P as v};
